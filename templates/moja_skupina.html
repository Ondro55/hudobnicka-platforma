{% extends "base.html" %}
{% set is_owner_group = current_user.is_authenticated and skupina and current_user.id == skupina.zakladatel_id %}

{% block content %}
<section class="profil-page">
  <div class="profil-grid">
    <!-- ƒΩAV√ù panel: fotka -> n√°zov -> akcie (rovnako ako profil) -->
    <aside class="profil-left">
      <div class="profil-fotka-wrapper">
        {% if skupina and skupina.profil_fotka_skupina %}
          <img class="profilovka avatar"
               src="{{ url_for('static', filename='profilovky_skupina/' ~ skupina.profil_fotka_skupina) }}"
               data-fallback="{{ url_for('static', filename='profilovky/default.png') }}"
               alt="Skupinov√° fotka">
        {% else %}
          <img class="profilovka avatar"
               src="{{ url_for('static', filename='profilovky/default.png') }}"
               alt="Skupinov√° fotka">
        {% endif %}

        {% if is_owner_group and skupina and skupina.profil_fotka_skupina %}
          <a href="{{ url_for('skupina.odstranit_fotku_skupina') }}"
          class="foto-action delete"
          title="Odstr√°ni≈• fotku"
          onclick="return confirm('Naozaj odstr√°ni≈• profilov√∫ fotku skupiny?');">‚úñ</a>
        {% endif %}

        {% if is_owner_group %}
          <!-- rovnak√Ω overlay "‚úèÔ∏è" ako na profile -->
          <form action="{{ url_for('skupina.upload_fotka_skupina') }}"
                method="post" enctype="multipart/form-data"
                class="profil-upload-fotky">
            <input id="upload-input-group" type="file" name="profil_fotka_skupina" accept="image/*" hidden onchange="this.form.submit()">
            <label for="upload-input-group" class="foto-action edit" title="Zmeni≈• fotku">‚úèÔ∏è</label>
          </form>
        {% endif %}
      </div>

      <!-- N√°zov skupiny + pero na √∫pravu (iba vlastn√≠k) -->
      <div class="profil-nickline">
        <h2 class="profil-nick" style="display:flex;align-items:center;gap:.5rem;margin:0;">
          {{ (skupina and skupina.nazov) or 'Moja skupina' }}
          {% if is_owner_group %}
            <button id="editGroupButton" class="edit-icon" title="Upravi≈• skupinu" type="button">‚úèÔ∏è</button>
          {% endif %}
        </h2>
      </div>

      {% if skupina %}
      <!-- Zobrazenie √∫dajov (view) -->
      <div id="groupView" class="profil-udaje" style="margin-top:.5rem;">
        <p><strong>Mesto / obec:</strong> {{ skupina.mesto or '‚Äî' }}</p>
        <p><strong>Hudobn√Ω ≈æ√°ner:</strong> {{ skupina.zaner or '‚Äî' }}</p>
        {% if skupina.web %}<p><strong>Web:</strong> <a href="{{ skupina.web }}" target="_blank" rel="noopener">{{ skupina.web }}</a></p>{% endif %}
        {% if skupina.email %}<p><strong>E-mail:</strong> {{ skupina.email }}</p>{% endif %}
      </div>
      {% endif %}

      <!-- Editaƒçn√Ω formul√°r (skryt√Ω, uk√°≈æe sa perom) -->
      {% if is_owner_group and skupina %}
      <form id="groupEditForm" method="POST" action="{{ url_for('skupina.upravit') }}" style="display:none;" class="form-profil">
        <div class="form-row">
          <label>N√°zov</label>
          <input type="text" name="nazov" value="{{ skupina.nazov }}" required>
        </div>
        <div class="form-row">
          <label>Mesto / obec</label>
          <input type="text" name="mesto" value="{{ skupina.mesto or '' }}">
        </div>
        <div class="form-row">
          <label>Hudobn√Ω ≈æ√°ner</label>
          <input type="text" name="zaner" value="{{ skupina.zaner or '' }}">
        </div>
        <div class="form-row">
          <label>E-mail</label>
          <input type="email" name="email" value="{{ skupina.email or '' }}">
        </div>
        <div class="form-row">
          <label>Web</label>
          <input type="text" name="web" value="{{ skupina.web or '' }}">
        </div>
        <div class="form-row">
          <label>O skupine</label>
          <textarea name="popis">{{ skupina.popis or '' }}</textarea>
        </div>
        <div class="form-row btn-row">
          <button type="submit" class="btn primary">üíæ Ulo≈æi≈• zmeny</button>
          <button type="button" id="cancelGroupEdit" class="btn ghost">Zru≈°i≈•</button>
        </div>
      </form>
      {% endif %}

      {% if not is_owner_group and skupina %}
        <!-- n√°v≈°tevn√≠k: po≈°li spr√°vu zakladateƒæovi -->
        <a class="btn primary sm" style="margin-top:.75rem;"
           href="{{ url_for('spravy.napisat',
                            komu_id=skupina.zakladatel_id,
                            kontekst='skupina',
                            kontekst_id=skupina.id) }}">
          ‚úâÔ∏è Po≈°li spr√°vu
        </a>
      {% endif %}
    </aside>

    <!-- Prav√° biela karta (rovnak√© bloky ako profil) -->
    <div class="profil-right">
      <div class="profil-right-card">
        {% if not skupina %}
          <section class="sekcia">
            <h3>≈Ωiadna skupina</h3>
            <p>Zatiaƒæ nem√°≈° vytvoren√∫ skupinu.</p>
          </section>
        {% else %}
          <section class="sekcia">
            <h3>O skupine</h3>
            <p>{{ skupina.popis or '‚Äî' }}</p>
          </section>
          {% if skupina %}
            <div class="sekcia-profil">
              <h4>Pozva≈• ƒçlena</h4>
              <form method="POST" action="{{ url_for('skupina.pozvi_clena', id=skupina.id) }}" class="form-skupina" style="margin-top:.5rem;">
                <label for="target">Zadaj prez√Ωvku, email alebo ID</label>
                <input type="text" id="target" name="target" placeholder="napr. jozo123 alebo jozo@mail.sk" required>
                <button type="submit">‚ûï Posla≈• pozv√°nku</button>
              </form>
            </div>

            <div class="sekcia-profil">
              <h4>ƒåakaj√∫ce pozv√°nky</h4>
              {% set pend = skupina.pozvanky | selectattr('stav','equalto','pending') | list %}
              {% if pend %}
                <ul>
                  {% for inv in pend %}
                    <li>
                      {{ inv.pozvany.prezyvka or inv.pozvany.email }} ‚Äì
                      platn√° do: {{ inv.expires_at.strftime('%d.%m.%Y %H:%M') if inv.expires_at else '‚Äî' }}
                      <a href="{{ url_for('skupina.prijmi_pozvanku_view', token=inv.token) }}" class="btn sm">K√≥pia linku</a>
                      <form method="POST" action="{{ url_for('skupina.zrus_pozvanku', token=inv.token) }}" style="display:inline" onsubmit="return confirm('Zru≈°i≈• t√∫to pozv√°nku?');">
                        <button class="btn sm" type="submit">Zru≈°i≈•</button>
                      </form>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="sekcia-empty">≈Ωiadne ƒçakaj√∫ce pozv√°nky.</p>
              {% endif %}
            </div>
          {% endif %}

          <section class="sekcia">
            <h3>ƒålenovia</h3>
            {% if skupina.clenovia and skupina.clenovia|length > 0 %}
              <ul>
                {% for clen in skupina.clenovia %}
                  <li>
                    <a class="clen-link"
                      href="{{ url_for('uzivatel.verejny_profil', user_id=clen.id) }}">
                      {{ clen.prezyvka or (clen.meno ~ ' ' ~ clen.priezvisko)|trim }}
                    </a>{% if clen.instrument %} ‚Äì {{ clen.instrument }}{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="sekcia-empty">≈Ωiadni ƒçlenovia.</p>
            {% endif %}
          </section>

          <section class="sekcia">
            <div class="sekcia-head">
              <h3>Gal√©ria</h3>
              {% if is_owner_group %}
                {% set max_foto = 20 %}
                {% set pocet = (skupina.galeria or [])|length %}
                {% set zostava = (max_foto - pocet) if pocet < max_foto else 0 %}
                <form method="POST"
                      action="{{ url_for('skupina.nahraj_fotku_skupina') }}"
                      enctype="multipart/form-data"
                      id="upload-form-gal-group">
                  <input type="file"
                        id="upload-foto-group"
                        name="fotos"
                        accept="image/*"
                        multiple
                        hidden
                        {% if zostava == 0 %}disabled{% endif %}
                        onchange="this.form.submit()">
                  <label for="upload-foto-group"
                        class="btn primary sm {% if zostava == 0 %}disabled{% endif %}"
                        {% if zostava == 0 %}title="Limit {{ max_foto }} fotiek je naplnen√Ω"{% else %}title="Nahra≈• fotky (m√¥≈æe≈° oznaƒçi≈• viac)"{% endif %}>
                    ‚ûï Nahra≈•
                  </label>
                  <small class="gal-limit">
                    {% if zostava > 0 %} zost√°va {{ zostava }} {% else %} limit {{ max_foto }}/{{ max_foto }} {% endif %}
                  </small>
                </form>
              {% endif %}
            </div>

            {% if skupina.galeria and skupina.galeria|length > 0 %}
            <div class="galeria-wrapper">
              {% for foto in skupina.galeria %}
                <div class="foto-blok">
                  <img src="{{ url_for('static', filename='galeria_skupina/' ~ foto.nazov_suboru) }}"
                       alt="Foto skupiny" class="galeria-foto">
                  {% if is_owner_group %}
                    <form method="POST"
                          action="{{ url_for('skupina.zmaz_fotku_skupina', id=foto.id) }}"
                          class="delete-form"
                          onsubmit="return confirm('Naozaj chce≈° zmaza≈• t√∫to fotku?');">
                      <button type="submit" class="delete-btn" title="Zmaza≈•">‚úñ</button>
                    </form>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            {% else %}
              <p class="sekcia-empty">Zatiaƒæ bez fotiek.</p>
            {% endif %}
          </section>

          <section class="sekcia">
            <div class="sekcia-head">
              <h3>üé• Vide√°</h3>
              <p class="profil-pocet-videi">Poƒçet vide√≠: {{ (skupina.videa or []) | length }}</p>
            </div>

            {% if is_owner_group %}
            <form action="{{ url_for('skupina.pridaj_video_skupina', id=skupina.id) }}"
                  method="POST" class="profil-videoform">
              <input type="text" name="youtube_url" placeholder="https://www.youtube.com/watch?v=..." required>
              <input type="text" name="popis" placeholder="Kr√°tky popis (voliteƒæn√©)">
              <button type="submit" class="btn primary">‚ûï Prida≈• video</button>
            </form>
            {% endif %}

            {% if skupina.videa and skupina.videa|length > 0 %}
            <div class="profil-video-grid">
              {% for video in skupina.videa %}
                <div class="profil-youtube-video">
                  <iframe src="https://www.youtube.com/embed/{{ video.youtube_url | youtube_id }}"
                          title="YouTube video" frameborder="0" allowfullscreen></iframe>
                  {% if video.popis %}<p class="video-popis">{{ video.popis }}</p>{% endif %}
                  {% if is_owner_group %}
                    <form action="{{ url_for('skupina.zmaz_video_skupina', id=video.id) }}"
                          method="POST" class="delete-form">
                      <button type="submit" class="delete-btn" title="Zmaza≈• video"
                              onclick="return confirm('Naozaj chce≈° zmaza≈• video?')">‚úñ</button>
                    </form>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            {% else %}
              <p class="sekcia-empty">Zatiaƒæ bez vide√≠.</p>
            {% endif %}
          </section>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  // fallback na default obr√°zok, ak ch√Ωba s√∫bor
  document.addEventListener('error', function(e){
    var img = e.target;
    if (!(img instanceof HTMLImageElement) || !img.classList.contains('avatar')) return;
    img.classList.remove('avatar');
    var fb = img.getAttribute('data-fallback') || '{{ url_for("static", filename="profilovky/default.png") }}';
    img.src = fb;
  }, true);

  // prep√≠nanie edit√°cie skupiny (ako na profile)
  (function(){
    var btn   = document.getElementById('editGroupButton');
    if (!btn) return;
    var form  = document.getElementById('groupEditForm');
    var view  = document.getElementById('groupView');
    var cancel= document.getElementById('cancelGroupEdit');

    function showEdit(){ if(form){ form.style.display='block'; } if(view){ view.style.display='none'; } }
    function hideEdit(){ if(form){ form.style.display='none'; } if(view){ view.style.display='block'; } }

    btn.addEventListener('click', showEdit);
    if (cancel) cancel.addEventListener('click', hideEdit);
  })();
</script>
{% endblock %}
