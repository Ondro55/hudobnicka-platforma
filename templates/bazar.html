{% extends 'base.html' %}
{% block title %}Bazár | Muzikuj{% endblock %}

{% block content %}
<section class="komunita-wrapper bazar-page" style="padding: 2rem;">

  {% if detail_inz %}
    <h2>🛒 Detail inzerátu</h2>
    <a href="{{ url_for('inzerat.bazar_verejny') }}" class="link-spat">← Späť na bazár</a>

    <header class="detail-head">
      <h1>{{ detail_inz.typ }} – {{ detail_inz.kategoria }}</h1>
      <div class="meta">
        <span>💶 {{ '%.2f'|format(detail_inz.cena or 0) }} €</span>
        <span>📍 {{ detail_inz.mesto_objekt.nazov if detail_inz.mesto_objekt else detail_inz.mesto }}</span>
        <span>🚚 {{ detail_inz.doprava or '—' }}</span>
        <span>🕒 {{ detail_inz.datum.strftime('%d.%m.%Y') }}</span>
      </div>

      <div class="cta-wrap">
        {% if current_user.is_authenticated %}
          {% if current_user.id != detail_inz.pouzivatel_id %}
            <a class="btn primary"
               href="{{ url_for('spravy.napisat',
                                 kontekst='inzerat',
                                 kontekst_id=detail_inz.id,
                                 komu_id=detail_inz.pouzivatel_id) }}">
              ✉️ Poslať správu
            </a>
          {% endif %}
        {% else %}
          <a class="btn primary" href="{{ url_for('uzivatel.login') }}">✉️ Prihlás sa a reaguj</a>
        {% endif %}
      </div>
    </header>

    {% if detail_inz.popis %}
      <article class="popis" style="margin:1rem 0 1.5rem;">
        <h3>Popis</h3>
        <p>{{ detail_inz.popis }}</p>
      </article>
    {% endif %}

    <section class="galeria">
      <h3>Fotky</h3>
      <div class="thumbs">
        {% if detail_inz.fotky %}
          {% for f in detail_inz.fotky %}
            <img class="thumb"
                 src="{{ url_for('static', filename='galeria_inzerat/' ~ f.nazov_suboru) }}"
                 alt="Foto {{ loop.index }}"
                 data-idx="{{ loop.index0 }}">
          {% endfor %}
        {% else %}
          <p>Žiadne fotky.</p>
        {% endif %}
      </div>
    </section>

    {# Lightbox overlay #}
    <div id="lb" class="lb" aria-hidden="true">
      <button type="button" class="lb-close" aria-label="Zavrieť">✖</button>
      <button type="button" class="lb-btn lb-prev" aria-label="Predošlá">‹</button>
      <img id="lb-img" alt="Náhľad">
      <button type="button" class="lb-btn lb-next" aria-label="Ďalšia">›</button>
    </div>

  {% else %}
    <h2>🛒 Bazár</h2>

    {# ✅ Filterbar – nastav premenné a includni #}
    {% set action_url = url_for('inzerat.bazar_verejny') %}
    {% set placeholder = 'Hľadať inzeráty…' %}
    {% set btn_label = 'Hľadať' %}
    {% set show_mesto = False %}
    {% set show_zaner = False %}
    {% set show_kategoria = True %}
    {% set q = q %}
    {% set kategoria = kategoria %}
    {% set kategorie = kategorie %}
    {% include "includes/filterbar.html" %}

    {% if inzeraty %}
      <div class="zoznam-inzeratov">
        {% for inzerat in inzeraty %}
          <a href="{{ url_for('inzerat.bazar_detail', inzerat_id=inzerat.id) }}" class="inzerat-link">
            <div class="bazar-card3">
              <!-- STĹPEC 1: nick/avatár + mesto/dátum -->
              <div class="bazar-col1">
                <div class="bazar-profile">
                  {% set pf = inzerat.pouzivatel.profil_fotka if inzerat.pouzivatel and inzerat.pouzivatel.profil_fotka else 'default.png' %}
                  <img src="{{ url_for('static', filename='profilovky/' ~ pf) }}" alt="Profilová fotka" class="profilovka">
                  <span class="bazar-nick">@{{ inzerat.pouzivatel.prezyvka if inzerat.pouzivatel else 'užívateľ' }}</span>
                </div>
                <div class="bazar-meta">
                  <span class="bazar-chip">📍 {{ inzerat.mesto_objekt.nazov if inzerat.mesto_objekt else inzerat.mesto }}</span>
                  <span class="bazar-chip">🕒 {{ inzerat.datum.strftime('%d.%m.%Y') }}</span>
                </div>
              </div>

              <!-- STĹPEC 2: názov + cena + popis -->
              <div class="bazar-col2">
                <div class="bazar-topline">
                  <h4 class="bazar-title">{{ inzerat.typ }} – {{ inzerat.kategoria }}</h4>
                  <div class="bazar-price">💶 {{ '%.2f'|format(inzerat.cena or 0) }} €</div>
                </div>
                <p class="bazar-desc">{{ inzerat.popis }}</p>
              </div>

              <!-- STĹPEC 3: fotky -->
              <div class="bazar-col3">
                {% if inzerat.fotky %}
                  {% for foto in inzerat.fotky[:5] %}
                    <img src="{{ url_for('static', filename='galeria_inzerat/' ~ foto.nazov_suboru) }}" alt="foto">
                  {% endfor %}
                  {% if inzerat.fotky|length > 5 %}
                    <div class="more-badge">+{{ inzerat.fotky|length - 5 }}</div>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p>Zatiaľ žiadne inzeráty podľa zvolených filtrov.</p>
    {% endif %}
  {% endif %}
</section>

{% if detail_inz %}
<script>
(function(){
  const thumbs = Array.from(document.querySelectorAll('.thumbs .thumb'));
  if (!thumbs.length) return;

  const lb = document.getElementById('lb');
  const lbImg = document.getElementById('lb-img');
  const btnClose = lb.querySelector('.lb-close');
  const btnPrev = lb.querySelector('.lb-prev');
  const btnNext = lb.querySelector('.lb-next');
  const sources = thumbs.map(t => t.getAttribute('src'));
  let i = 0;

  function openAt(idx){ i = idx; lbImg.src = sources[i]; lb.classList.add('open'); lb.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
  function close(){ lb.classList.remove('open'); lb.setAttribute('aria-hidden','true'); lbImg.src=''; document.body.style.overflow=''; }
  function prev(){ i = (i - 1 + sources.length) % sources.length; lbImg.src = sources[i]; }
  function next(){ i = (i + 1) % sources.length; lbImg.src = sources[i]; }

  thumbs.forEach(t => t.addEventListener('click', e => openAt(parseInt(t.dataset.idx, 10))));
  btnClose.addEventListener('click', close);
  btnPrev.addEventListener('click', prev);
  btnNext.addEventListener('click', next);
  lb.addEventListener('click', e => { if (e.target === lb) close(); });
  document.addEventListener('keydown', e => {
    if (!lb.classList.contains('open')) return;
    if (e.key === 'Escape') close();
    if (e.key === 'ArrowLeft') prev();
    if (e.key === 'ArrowRight') next();
  });
})();
</script>
{% endif %}
{% endblock %}
