{% extends "base.html" %}
{% block title %}Moje reklamy{% endblock %}

{% block content %}
<section class="komunita-wrapper" style="padding:2rem;">
  <h2 style="margin-top:0;">Moje reklamy</h2>

  <div class="ad-grid">
    <!-- ƒΩAVO: formul√°r -->
    <form method="POST" action="{{ url_for('reklama.vytvor') }}"
          enctype="multipart/form-data"
          id="ad-form" class="card ad-form">
      <div>
        <div class="form-row">
          <label>N√°zov</label>
          <input class="input-line" type="text" name="nazov" id="inp-nazov" required>
        </div>

        <div class="form-row">
          <label>Popis / text</label>
          <textarea class="input-area" name="text" id="inp-text" rows="5"
                    placeholder="Kr√°tky text reklamy‚Ä¶"></textarea>
        </div>

        <div class="form-row">
          <label>Cieƒæov√Ω odkaz (URL)</label>
          <input class="input-line" type="url" name="url" id="inp-url" placeholder="https://‚Ä¶">
        </div>

        <div class="form-row two">
          <div>
            <label>Zaƒçiatok</label>
            <input class="input-line" type="datetime-local" name="start" id="inp-start">
          </div>
          <div>
            <label>Koniec (voliteƒæn√©)</label>
            <input class="input-line" type="datetime-local" name="end" id="inp-end">
          </div>
        </div>

        <div class="form-row" style="display:flex;align-items:center;gap:.5rem;">
          <input type="checkbox" id="inp-top" name="is_top" value="1">
          <label for="inp-top" style="margin:0;">Topova≈• (zv√Ωrazni≈•)</label>
        </div>

        <div class="form-row">
          <label>Obr√°zok (1 ks)</label>
          <input class="input-file" type="file" name="foto" id="inp-foto" accept="image/*">
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn primary">üöÄ Ulo≈æi≈• & zverejni≈•</button>
      </div>
    </form>

    <!-- PRAVO: n√°hƒæad -->
    <article class="card ad-preview">
      <div class="preview-copy">
        <h4 id="prev-nazov" class="prev-title">N√°zov reklamy</h4>
        <p id="prev-text" class="prev-desc">Kr√°tky text reklamy‚Ä¶</p>
        <div id="prev-url" class="prev-url"></div>
      </div>

      <div class="preview-toolbar">
        <label class="fit-opt">
          <input type="radio" name="fitMode" value="contain" checked>
          Bez orezania
        </label>
        <label class="fit-opt">
          <input type="radio" name="fitMode" value="cover">
          Orez (vyplni≈•)
        </label>
      </div>

      {% set default_img = url_for('static', filename='reklamy/default-ad.jpg') %}
      <div class="preview-frame">
        <img id="preview-img" src="{{ default_img }}" alt="N√°hƒæad">
      </div>
    </article>
  </div>

  <hr style="margin:1.25rem 0;">
  <section>
    <h3>Moje ulo≈æen√© reklamy</h3>
    <div class="list-rows">
      {% for ad in reklamy %}
        <article class="list-row ad-row">
          <div class="ad-row-left">
            <img src="{{ ad.foto_url }}" alt="" style="width:64px;height:40px;object-fit:cover;border-radius:.35rem;">
            <div>
              <strong>{{ ad.nazov }}</strong><br>
              <small>
                {{ ad.start_dt.strftime('%d.%m.%Y %H:%M') }}
                {% if ad.end_dt %} ‚Äì {{ ad.end_dt.strftime('%d.%m.%Y %H:%M') }}{% endif %}
              </small>
            </div>
          </div>
          <div class="row-actions">
            <a class="btn sm" href="{{ url_for('reklama.edit', id=ad.id) }}">Upravi≈•</a>
            <form method="POST" action="{{ url_for('reklama.zmaz', id=ad.id) }}"
                  onsubmit="return confirm('Zmaza≈• reklamu?')">
              <button class="btn sm">Zmaza≈•</button>
            </form>
          </div>
        </article>
      {% else %}
        <p>Zatiaƒæ nem√°≈° ≈æiadne reklamy.</p>
      {% endfor %}
    </div>
  </section>
</section>

<style>
  .ad-grid{
    display:grid;
    grid-template-columns: 340px minmax(0,1fr);
    gap:1.25rem;
    align-items: stretch;
  }
  .ad-form{
    flex:0 0 340px;
    display:flex; flex-direction:column;
  }
  .ad-preview{
    display:flex; flex-direction:column; padding:0; overflow:hidden;
  }

  .form-row{ margin-bottom:.85rem; }
  .form-row.two{ display:grid; grid-template-columns:1fr 1fr; gap:.75rem; }
  .input-line, .input-area, .input-file{
    width:100%; padding:.6rem .2rem .5rem .2rem;
    border:none; border-bottom:1px solid #ddd; background:transparent; outline:none;
  }
  .input-area{ min-height:110px; resize:vertical; }
  .input-line:focus, .input-area:focus{ border-bottom-color:#999; }
  .form-actions{ margin-top:.9rem; display:flex; gap:.5rem; }

  .preview-copy{ padding:1rem 1rem .6rem 1rem; }
  .prev-title{ margin:.1rem 0 .35rem 0; }
  .prev-desc{ margin:.35rem 0 0 0; white-space:pre-wrap; color:#333; }
  .prev-url{ margin-top:.4rem; font-size:.95rem; color:#666; }

  .preview-toolbar{
    display:flex; gap:1rem; align-items:center;
    padding:.6rem 1rem .4rem 1rem; border-top:1px solid #eee;
  }
  .preview-toolbar .fit-opt{ display:flex; align-items:center; gap:.35rem; font-size:.95rem; }

  .preview-frame{
    position:relative; aspect-ratio:16/9; background:#fff; border-top:1px solid #eee;
  }
  .preview-frame img{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit: contain; object-position: center;
    display:block;
  }

  .ad-row{
    display:grid; grid-template-columns:1fr auto; gap:.75rem; align-items:center;
  }
  .ad-row-left{
    display:flex; align-items:center; gap:.6rem;
  }

  @media (max-width: 980px){
    .ad-grid{ grid-template-columns: 1fr; }
  }
</style>

<script>
  (function(){
    const $ = s => document.querySelector(s);

    const inpNazov = $('#inp-nazov');
    const inpText  = $('#inp-text');
    const inpUrl   = $('#inp-url');
    const inpFoto  = $('#inp-foto');

    const prevNazov = $('#prev-nazov');
    const prevText  = $('#prev-text');
    const prevUrl   = $('#prev-url');
    const prevImg   = $('#preview-img');

    const fitRadios = document.querySelectorAll('input[name="fitMode"]');

    function render(){
      prevNazov.textContent = (inpNazov.value || 'N√°zov reklamy').trim();
      prevText.textContent  = (inpText.value || 'Kr√°tky text reklamy‚Ä¶');
      const u = (inpUrl.value || '').trim();
      prevUrl.textContent   = u ? ('Odkaz: ' + u) : '';
    }

    [inpNazov, inpText, inpUrl].forEach(el => el && el.addEventListener('input', render));
    render();

    if (inpFoto) {
      inpFoto.addEventListener('change', () => {
        const f = inpFoto.files && inpFoto.files[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        prevImg.onload = () => URL.revokeObjectURL(url);
        prevImg.src = url;
      });
    }

    function applyFit(mode){
      prevImg.style.objectFit = (mode === 'cover') ? 'cover' : 'contain';
      prevImg.style.objectPosition = 'center';
    }
    fitRadios.forEach(r => r.addEventListener('change', () => applyFit(r.value)));
  })();
</script>
{% endblock %}
