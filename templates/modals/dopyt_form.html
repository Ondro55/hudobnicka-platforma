<div id="dopyt-form" class="modal-root" aria-modal="true" role="dialog" hidden>
  <div class="modal-card">
    <button type="button" class="modal-close" data-modal-close aria-label="Zavrieť">✖</button>
    <h3 style="margin-top:0;">Pridať dopyt</h3>

    <!-- JSON dáta (iba raz!) -->
    <script id="kategorie-json" type="application/json">
      {{ (kategorie|default([], true))|tojson }}
    </script>
    <script id="typy-json" type="application/json">
      {{ (typy|default([], true))|tojson }}
    </script>

    <form id="dopyt-formular" method="post" action="{{ url_for('dopyty.pridaj_dopyt_post') }}" novalidate>
      <input type="text" name="website" style="display:none" autocomplete="off"> {# honeypot #}

      <div class="form-fields">
        <!-- 1) Kto objednáva -->
        <label for="kto" class="req">Kto objednáva</label>
          <select id="kto" name="kto" required>
            <option value="">— vyber —</option>
          </select>
        </label>

        <!-- 2) Typ akcie – vychádza z "kto" -->
        <div>
          <label for="typ_akcie" class="req">Typ akcie</label>
          <select id="typ_akcie" name="typ_akcie" required disabled>
            <option value="">Najprv vyber „Kto objednáva“</option>
          </select>
          <div id="typ-custom-wrap" style="display:none; margin-top:.5rem;">
            <input type="text" name="typ_akcie_custom" placeholder="Upresni typ (napr. vernisáž)">
          </div>
        </div>

        <!-- 3) Miesto -->
        <div class="miesto-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;">
          <div>
            <label for="mesto_name" class="label-spacer">Miesto (výber z miest)</label>
            <!-- viditeľné pole s automatickými návrhmi -->
            <input id="mesto_name" type="text" list="mesta_list" placeholder="napr. Bratislava" autocomplete="off">
            <!-- sem uložíme ID vybraného mesta (to sa odošle do backendu) -->
            <input type="hidden" id="mesto_id" name="mesto_id">
            <datalist id="mesta_list">
              {% set _m = (mesta if mesta is defined and mesta else (mesta_all if mesta_all is defined else [])) %}
              {% for m in _m %}
                <option
                  value="{{ m.nazov }}{% if m.okres %}, {{ m.okres }}{% endif %}{% if m.kraj %}, {{ m.kraj }}{% endif %}"
                  data-id="{{ m.id }}"></option>
              {% endfor %}
            </datalist>
          </div>

          <div>
            <label for="miesto">zadaj miesto (textom)</label>
            <input id="miesto" name="miesto" type="text" placeholder="napr. Dom kultúry">
          </div>
        </div>

        <!-- 4) Dátum / čas -->
        <div class="row-2">
          <div>
            <label for="datum">Dátum</label>
            <input id="datum" name="datum" type="date">
          </div>

          <div>
            <label>Čas (od – do)</label>
            <div class="row-2" style="margin-top:.35rem;">
              <input name="cas_od" type="time">
              <input name="cas_do" type="time">
            </div>
          </div>
        </div>

        <!-- 5) Cena -->
        <fieldset style="margin-top:.25rem;">
          <legend>Cena</legend>
          <label style="display:flex; gap:.5rem; align-items:center; margin-bottom:.35rem;">
            <input type="radio" name="cena_typ" value="dohodou" checked>
            <span>Cena dohodou</span>
          </label>
          <label style="display:flex; gap:.5rem; align-items:center;">
            <input type="radio" name="cena_typ" value="rozpocet">
            <span>Uveď rozpočet</span>
          </label>
          <div id="cena-rozpocet-wrap" style="display:none; margin-top:.5rem;">
            <input type="number" step="1" min="0" name="rozpocet" placeholder="napr. 400">
          </div>
        </fieldset>

        <!-- 6) Popis -->
        <label for="popis">Popis</label>
        <textarea id="popis" name="popis" rows="4" placeholder="Upresnite repertoár, techniku, dĺžku vystúpenia…"></textarea>


        <!-- 7) Kontakt -->
        <div class="row-2">
          <div>
            <label for="meno" class="req">Meno / Organizácia</label>
            <input id="meno" name="meno" type="text" required
                  value="{{ current_user.prezyvka if current_user.is_authenticated else '' }}">
          </div>
          <div>
            <label for="email" class="req">E-mail</label>
            <input id="email" name="email" type="email" required
                  value="{{ current_user.email if current_user.is_authenticated else '' }}">
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn" data-modal-close>Zavrieť</button>
        <button id="btn-odoslat-dopyt" type="button" class="btn primary">Odoslať dopyt</button>
      </div>
    </form>
  </div>
</div>

<script>
(() => {
  document.querySelectorAll('#dopyt-form').forEach(root => {
    if (!root || root.dataset.bound === '1') return;
    root.dataset.bound = '1';

  // -------- helpers --------
  const getJSONLast = (id, fallback=[]) => {
    try {
      const nodes = document.querySelectorAll(`#${CSS.escape(id)}`);
      const el = nodes[nodes.length - 1];
      if (!el) return fallback;
      const txt = (el.textContent || '').trim();
      if (!txt) return fallback;
      const val = JSON.parse(txt);
      return Array.isArray(val) ? val : fallback;
    } catch (e) {
      console.warn('JSON parse fail for', id, e);
      return fallback;
    }
  };

  const norm = (s) => (s||'')
    .toString().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,'_').replace(/-+/g,'_')
    .replace(/[^a-z0-9_]/g,'');

  const SYN = {
    'sukromna_osoba':'sukromna','sukromna_udalost':'sukromna',
    'obec_mesto':'obec','mesto_obec':'obec',
    'firemna_udalost':'firemna','firemna_akcia':'firemna',
    'cirkevna_udalost':'cirkev',
    'skolska_udalost':'skola',
    'klub_bar':'klub','klub_bar_gastro':'klub',
    'neziskovka_charita':'neziskovka'
  };
  const canon = (s) => SYN[norm(s)] || norm(s);

  const LABEL = {
    sukromna:'Súkromná udalosť',
    obec:'Obec / mesto',
    firemna:'Firemná akcia',
    cirkev:'Cirkevná udalosť',
    skola:'Školská udalosť',
    klub:'Klub / bar / gastro',
    neziskovka:'Neziskovka / charita',
    ine:'Iné'
  };

  // --- fallbacky ---
  const KATS_FALLBACK = [
    ['sukromna','Súkromná udalosť'],
    ['obec','Obec / mesto'],
    ['firemna','Firemná akcia'],
    ['cirkev','Cirkevná udalosť'],
    ['skola','Školská udalosť'],
    ['klub','Klub / bar / gastro'],
    ['neziskovka','Neziskovka / charita'],
    ['ine','Iné']
  ];

  const TYPY_FALLBACK = [
    {"slug":"svadba","label":"Svadba","groups":["sukromna"]},
    {"slug":"oslava","label":"Oslava / jubileum","groups":["sukromna"]},
    {"slug":"stretavka","label":"Stretávka / párty","groups":["sukromna"]},
    {"slug":"krstiny","label":"Krstiny","groups":["sukromna"]},
    {"slug":"rozlucka","label":"Rozlúčka so slobodou","groups":["sukromna"]},
    {"slug":"smutocna","label":"Smútočná rozlúčka","groups":["sukromna"]},
    {"slug":"silvester","label":"Silvester","groups":["sukromna","obec"]},
    {"slug":"ples","label":"Ples","groups":["obec","skola","firemna"]},
    {"slug":"festival","label":"Festival","groups":["obec","neziskovka","klub"]},
    {"slug":"koncert","label":"Koncert","groups":["klub","obec","neziskovka","firemna","cirkev"]},
    {"slug":"jarmok","label":"Jarmok / hody / dedinská zábava","groups":["obec"]},
    {"slug":"dni_mesta","label":"Dni obce / mesta","groups":["obec"]},
    {"slug":"festival_obecny","label":"Obecný festival / vinobranie / dožinky","groups":["obec"]},
    {"slug":"fasangy","label":"Fašiangy / karneval","groups":["obec"]},
    {"slug":"mikulasska","label":"Mikuláš / vianočné trhy","groups":["obec"]},
    {"slug":"den_deti","label":"Deň detí","groups":["obec"]},
    {"slug":"ples_obecny","label":"Obecný ples","groups":["obec"]},
    {"slug":"firemny_vecierok","label":"Firemný večierok","groups":["firemna"]},
    {"slug":"teambuilding","label":"Teambuilding","groups":["firemna"]},
    {"slug":"gala","label":"Gala / ples firmy","groups":["firemna"]},
    {"slug":"otvorenie_prevadzky","label":"Otvorenie prevádzky / promo","groups":["firemna"]},
    {"slug":"konferencia","label":"Konferencia / recepcia","groups":["firemna"]},
    {"slug":"family_day","label":"Family day","groups":["firemna"]},
    {"slug":"odpust_puc","label":"Odpust / púť","groups":["cirkev"]},
    {"slug":"farsky_den","label":"Farský deň","groups":["cirkev"]},
    {"slug":"prijimanie_birmovka","label":"1. sv. prijímanie / birmovka","groups":["cirkev"]},
    {"slug":"beneficny_koncert","label":"Benefičný koncert","groups":["cirkev","neziskovka"]},
    {"slug":"stuzkova","label":"Stužková","groups":["skola"]},
    {"slug":"imatrikulacia","label":"Imatrikulácia","groups":["skola"]},
    {"slug":"skolsky_ples","label":"Školský ples","groups":["skola"]},
    {"slug":"klubovy_koncert","label":"Klubový koncert","groups":["klub"]},
    {"slug":"jam_session","label":"Jam session","groups":["klub"]},
    {"slug":"tematicky_vecer","label":"Tematický večer","groups":["klub"]},
    {"slug":"charita_beneficia","label":"Charitatívna / benefičná akcia","groups":["neziskovka"]},
    {"slug":"ine_sukromne","label":"Iné (súkromné)","groups":["sukromna"]},
    {"slug":"ine_obecne","label":"Iné (obecné)","groups":["obec"]},
    {"slug":"ine_firemne","label":"Iné (firemné)","groups":["firemna"]},
    {"slug":"ine_cirkevne","label":"Iné (cirkevné)","groups":["cirkev"]},
    {"slug":"ine_skoly","label":"Iné (školy)","groups":["skola"]},
    {"slug":"ine_klub","label":"Iné (klub/bar)","groups":["klub"]},
    {"slug":"ine_neziskovka","label":"Iné (neziskovka)","groups":["neziskovka"]},
    {"slug":"ine","label":"Iné","groups":["ine"]}
  ];

  // --- dáta z HTML, s fallbackmi ---
  const TYPY = (() => {
    const t = getJSONLast('typy-json', []);
    return t.length ? t : TYPY_FALLBACK;
  })();
  const KATS_DERIVED =
    Array.from(new Set(TYPY.flatMap(t => Array.isArray(t.groups) ? t.groups : [])))
      .map(g => [g, LABEL[canon(g)] || g]);
  const KATS = (() => {
    const k = getJSONLast('kategorie-json', []);
    if (k.length) return k;
    if (KATS_DERIVED.length) return KATS_DERIVED;
    return KATS_FALLBACK;
  })();

  // --- prvky ---
  const ktoSel        = root.querySelector('#kto');
  const typSel        = root.querySelector('#typ_akcie');
  const typCustomWrap = root.querySelector('#typ-custom-wrap');
  const cenaRadios    = Array.from(root.querySelectorAll('input[name="cena_typ"]'));
  const cenaWrap      = root.querySelector('#cena-rozpocet-wrap');
  const rozpocetInput = root.querySelector('input[name="rozpocet"]');

  function ensureKtoOptions(){
    if (!ktoSel) return;
    if (ktoSel.options.length > 1) return; // už naplnené serverom
    const frag = document.createDocumentFragment();
    KATS.forEach(([val,label])=>{
      const o = document.createElement('option');
      o.value = val;
      o.textContent = label;
      o.dataset.slug = canon(val);
      frag.appendChild(o);
    });
    ktoSel.appendChild(frag);
  }

  function rebuildTypy(){
    if (!typSel) return;
    typSel.innerHTML = '';
    typSel.disabled = true;
    if (typCustomWrap) typCustomWrap.style.display = 'none';

    const groupKey = canon(ktoSel?.value || '');
    if (!groupKey){
      typSel.insertAdjacentHTML('beforeend','<option value="">Najprv vyber „Kto objednáva“</option>');
      return;
    }

    const subset = TYPY.filter(t =>
      Array.isArray(t.groups) && t.groups.some(g => canon(g) === groupKey)
    );

    typSel.insertAdjacentHTML('beforeend','<option value="">— vyber —</option>');
    subset.forEach(t => {
      const o = document.createElement('option');
      o.value = t.slug;
      o.textContent = t.label;
      typSel.appendChild(o);
    });
    if (!subset.some(t => String(t.slug||'').startsWith('ine'))){
      typSel.insertAdjacentHTML('beforeend','<option value="ine">Iné</option>');
    }
    typSel.disabled = false;
  }

  function onTypChange(){
    const v = typSel.value || '';
    if (typCustomWrap) typCustomWrap.style.display = v.startsWith('ine') ? 'block' : 'none';
    if (!v.startsWith('ine')) {
      const c = root.querySelector('input[name="typ_akcie_custom"]');
      if (c) c.value = '';
    }
  }

  function updateCena(){
    const v = (cenaRadios.find(r => r.checked)?.value) || 'dohodou';
    const show = (v === 'rozpocet');
    if (cenaWrap) cenaWrap.style.display = show ? 'block' : 'none';
    if (rozpocetInput){ rozpocetInput.required = show; if (!show) rozpocetInput.value = ''; }
  }

  // events
  ktoSel?.addEventListener('change', () => { rebuildTypy(); });
  ktoSel?.addEventListener('input',  () => { rebuildTypy(); });
  typSel?.addEventListener('change', onTypChange);
  cenaRadios.forEach(r => r.addEventListener('change', updateCena));

  // init + pri otvorení modalu
  ensureKtoOptions();
  rebuildTypy();
  updateCena();

  document.addEventListener('click', (e)=>{
    if (e.target.closest('[data-modal-open="#dopyt-form"]')){
      setTimeout(()=>{ ensureKtoOptions(); rebuildTypy(); updateCena(); }, 0);
    }
  });

  console.debug('[Dopyt modal] KATS:', KATS);
  console.debug('[Dopyt modal] TYPY count:', TYPY.length);
  });
})();
</script>

<script>
(() => {
  const root = document.getElementById('dopyt-form');
  if (!root) return;

  const mestoSel    = root.querySelector('#mesto_id');
  const mestoFilter = root.querySelector('#mesto_filter');
  if (!mestoSel || !mestoFilter) return;
})();
</script>

<script>
(() => {
  const root = document.getElementById('dopyt-form');
  if (!root) return;

  const form = root.querySelector('form');
  const submitBtn = root.querySelector('#btn-odoslat-dopyt');

  // Zablokuj Enter mimo textarea (tam povoliť nový riadok)
  form.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
      e.preventDefault();
    }
  });

  // Odoslanie výhradne klikom na tlačidlo
  if (submitBtn) {
    submitBtn.addEventListener('click', () => {
      if (form.checkValidity()) {
        form.submit();
      } else {
        form.reportValidity();
      }
    });
  }
})();
</script>
<script>
(() => {
  const root = document.getElementById('dopyt-form');
  if (!root) return;

  const input = root.querySelector('#mesto_name');
  const hidden = root.querySelector('#mesto_id');
  const list = root.querySelector('#mesta_list');
  if (!input || !hidden || !list) return;

  function syncCityId(){
    const val = (input.value || '').trim().toLowerCase();
    let id = '';
    // nájdi presnú zhodu podľa value (bez ohľadu na veľkosť písmen)
    for (const opt of list.options){
      if ((opt.value || '').trim().toLowerCase() === val){
        id = opt.dataset.id || '';
        break;
      }
    }
    hidden.value = id; // ak nenašlo, necháme prázdne (backend to zvládne)
  }

  input.addEventListener('input', syncCityId);
  input.addEventListener('change', syncCityId);
})();
</script>
