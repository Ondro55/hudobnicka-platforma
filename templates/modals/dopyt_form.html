<style>
  #mesto_id { appearance:auto !important; }
  .choices, .select2, .custom-select { display:none !important; } /* ak pou≈æ√≠va≈° nieƒço tak√©to */
</style>

<!-- templates/modals/dopyt_form.html -->
<section class="komunita-wrapper dopyt-form-page" style="padding:2rem;">
  <h2>üîé Prida≈• dopyt</h2>
  <p style="opacity:.85; margin:.25rem 0 1rem;">
    Vypl≈à ƒço hƒæad√°≈° (kapela, DJ, moder√°tor‚Ä¶), term√≠n a miesto. Registrovan√≠ ƒçlenovia si tvoj dopyt uvidia a m√¥≈æu reagova≈•.
  </p>

<form method="POST" action="{{ url_for('dopyty.pridaj_dopyt_post') }}" novalidate>
    <!-- ƒåo hƒæad√°≈° -->
    <label for="typ_akcie">Typ akcie <span style="color:crimson;">*</span></label>
    <select id="typ_akcie" name="typ_akcie" required>
      <option value="">Vyber typ‚Ä¶</option>
      <option value="svadba">Svadba</option>
      <option value="oslava">Oslava</option>
      <option value="firemna">Firemn√° akcia</option>
      <option value="ine">In√©</option>
    </select>


    <!-- Term√≠n -->
    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-top:.75rem;">
      <div>
        <label for="datum">D√°tum</label>
        <input type="date" id="datum" name="datum">
      </div>
      <div>
        <label for="cas_od">ƒåas od</label>
        <input type="time" id="cas_od" name="cas_od">
      </div>
      <div>
        <label for="cas_do">ƒåas do</label>
        <input type="time" id="cas_do" name="cas_do">
      </div>
    </div>

    <!-- Miesto (p√≠≈° a filtruj cez datalist) -->
    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:.75rem;">
      <div>
        <label for="mesto_label">Miesto konania <span style="color:crimson;">*</span></label>

        {% set obce = mesta_all|sort(attribute='nazov') %}
        <!-- viditeƒæn√© pole na p√≠sanie -->
        <input
          type="text"
          id="mesto_label"
          name="mesto_label"
          list="mesta_datalist"
          placeholder="Zaƒçni p√≠sa≈• (napr. Gelnica)"
          autocomplete="off"
          required
        >

        <!-- ponuka mo≈ænost√≠ -->
        <datalist id="mesta_datalist">
          {% for m in obce %}
            <option
              data-id="{{ m.id }}"
              value="{{ m.nazov }}{% if m.okres %} ‚Äî {{ m.okres }}{% endif %}{% if m.kraj %} ‚Äî {{ m.kraj }}{% endif %}">
            </option>
          {% endfor %}
        </datalist>

        <!-- skryt√© ID, ktor√© sa odo≈°le do backendu -->
        <input type="hidden" id="mesto_id" name="mesto_id">
      </div>
    </div>


    <!-- Rozpoƒçet -->
    <label for="rozpocet" style="margin-top:.75rem;">Rozpoƒçet (max, ‚Ç¨)</label>
    <input type="number" id="rozpocet" name="rozpocet" min="0" step="1" placeholder="napr. 500">

    <!-- Popis -->
    <label for="popis" style="margin-top:.75rem;">Popis</label>
    <textarea id="popis" name="popis" rows="5" placeholder="Nap√≠≈° detaily: typ akcie, ≈æ√°ner, dƒ∫≈æka vyst√∫penia‚Ä¶"></textarea>

    <!-- Kontakt -->
    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:.75rem;">
      <div>
        <label for="meno">Meno <span style="color:crimson;">*</span></label>
        <input type="text" id="meno" name="meno"
               value="{% if current_user.is_authenticated %}{{ current_user.prezyvka or '' }}{% endif %}"
               required>
      </div>
      <div>
        <label for="email">Email <span style="color:crimson;">*</span></label>
        <input type="email" id="email" name="email"
               value="{% if current_user.is_authenticated %}{{ current_user.email or '' }}{% endif %}"
               required>
      </div>
    </div>

    <!-- Anti-spam (honeypot) -->
    <input type="text" name="website" autocomplete="off" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;opacity:0;">

    <div class="actions" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:1rem;">
      <button type="submit" class="btn primary">Odosla≈• dopyt</button>
      <a href="{{ url_for('dopyty.zobraz_dopyty') }}" class="btn">Zru≈°i≈•</a>
    </div>
  </form>
</section>

<script>
(function(){
  const form = document.querySelector('.dopyt-form-page form');
  const inputLabel = form.querySelector('#mesto_label');
  const hiddenId   = form.querySelector('#mesto_id');
  const dataList   = document.getElementById('mesta_datalist');

  function normalize(s){
    return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  }
  function findMestoIdByLabel(label){
    const want = normalize(label);
    if (!want) return '';
    let best = '';
    const opts = dataList ? dataList.options : [];
    for (let i = 0; i < opts.length; i++){
      const opt = opts[i];
      const val = opt.value || '';
      const id  = opt.getAttribute('data-id') || '';
      const n   = normalize(val);
      if (n === want) return id;           // presn√° zhoda
      if (!best && n.startsWith(want)) best = id;  // prv√° vhodn√°
    }
    return best;
  }
  function syncMestoId(){
    hiddenId.value = findMestoIdByLabel(inputLabel.value);
  }
  inputLabel.addEventListener('input', () => { hiddenId.value = ''; });
  inputLabel.addEventListener('change', syncMestoId);
  inputLabel.addEventListener('blur',   syncMestoId);
  
  if (!form) return;

  const submitBtn = form.querySelector('.actions .btn.primary');

  function clearError(input){
    input.removeAttribute('aria-invalid');
    const next = input.nextElementSibling;
    if (next && next.classList.contains('field-error')) next.remove();
  }
  function setError(input, msg){
    clearError(input);
    const hint = document.createElement('div');
    hint.className = 'field-error';
    hint.textContent = msg;
    hint.style.color = 'crimson';
    hint.style.fontSize = '.9rem';
    hint.style.marginTop = '.25rem';
    input.setAttribute('aria-invalid','true');
    input.insertAdjacentElement('afterend', hint);
  }

  function validate(){
  let ok = true;

  const typ = form.typ_akcie;
  const meno = form.meno;
  const email = form.email;
  const mesto = form.mesto_id;
  const rozpocet = form.rozpocet;
  const casOd = form.cas_od;
  const casDo = form.cas_do;
  const honeypot = form.website;

  [typ, meno, email, rozpocet, casOd, casDo, mesto].forEach(i => i && clearError(i));

  // honeypot
  if (honeypot && honeypot.value.trim() !== '') ok = false;

  // povinn√© polia
  if (!typ || !typ.value.trim()){ setError(typ, 'Pros√≠m, nap√≠≈° ƒço hƒæad√°≈°.'); ok = false; }
  if (!meno || !meno.value.trim()){ setError(meno, 'Pros√≠m, uveƒè meno.'); ok = false; }
  if (!mesto || !mesto.value){ setError(mesto, 'Pros√≠m, vyber miesto.'); ok = false; }

  // email
  const emailVal = (email && email.value ? email.value.trim() : '');
  if (!emailVal){
    setError(email, 'Pros√≠m, uveƒè email.'); ok = false;
  } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal)){
    setError(email, 'Email nem√° spr√°vny tvar.'); ok = false;
  } else {
    email.value = emailVal; // normalizuj
  }

  // rozpoƒçet (ak je zadan√Ω, mus√≠ by≈• ƒç√≠slo ‚â• 0)
  if (rozpocet && rozpocet.value && rozpocet.value.trim()){
    const v = Number(rozpocet.value.replace(',', '.'));
    if (Number.isNaN(v) || v < 0){
      setError(rozpocet, 'Rozpoƒçet mus√≠ by≈• ƒç√≠slo ‚â• 0.'); ok = false;
    } else {
      rozpocet.value = String(v);
    }
  }

  // poradie ƒçasov
  if (casOd && casDo && casOd.value && casDo.value && casOd.value >= casDo.value){
    setError(casDo, 'ƒåas ‚Äûdo‚Äú mus√≠ by≈• nesk√¥r ako ‚Äûod‚Äú.'); ok = false;
  }

  return ok;
}


  form.addEventListener('submit', function(e){
    if (!validate()){
      e.preventDefault();
      const firstErr = form.querySelector('.field-error');
      if (firstErr){
        (firstErr.previousElementSibling || firstErr).scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return;
    }
    // zabr√°≈à dvojit√©mu odoslaniu
    const origText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Odosielam‚Ä¶';
    setTimeout(() => { try { submitBtn.disabled = false; submitBtn.textContent = origText; } catch(_){} }, 10000);
  });
})();
</script>
