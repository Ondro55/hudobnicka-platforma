{% extends 'base.html' %}

{# vypočítaj is_owner len raz a bezpečne #}
{% set is_owner = is_owner if is_owner is defined else (current_user.is_authenticated and current_user.id == pouzivatel.id) %}
{# ak nechceš riešiť staff, nech can_edit = is_owner #}
{% set can_edit = can_edit if can_edit is defined else is_owner %}
{% set show_edit = show_edit|default(false) %}
{% set simple = simple_roles or [] %}

{% block content %}
<section class="profil-page">
  <div class="profil-grid">

    <!-- ĽAVÁ STRANA -->
    <aside class="profil-left" id="profilLeft">

      <!-- Foto -->
      <div class="profil-fotka-wrapper">
        {% set foto_url = url_for('static', filename='profilovky/' ~ (pouzivatel.profil_fotka or 'avatar-user.svg')) %}
        <img class="profilovka avatar"
             src="{{ foto_url }}"
             data-fallback="{{ url_for('static', filename='profilovky/default.png') }}"
             alt="Profilová fotka">

        {% if can_edit %}
          <form id="upload-form-user" action="{{ url_for('uzivatel.upload_fotka') }}" method="post" enctype="multipart/form-data" class="profil-upload-fotky">
            <input id="upload-input-user" type="file" name="profil_fotka" accept="image/*" onchange="this.form.submit()" hidden>
            <label for="upload-input-user" class="foto-action edit" title="Zmeniť fotku">✏️</label>
          </form>

          {% if pouzivatel.profil_fotka %}
            <a href="{{ url_for('uzivatel.odstranit_fotku') }}" class="foto-action delete" title="Odstrániť fotku" onclick="return confirm('Naozaj chceš odstrániť profilovú fotku?');">✖</a>
          {% endif %}
        {% endif %}
      </div>

      <!-- Nick + akcie -->
      <div class="profil-nickline">
        <h2 class="profil-nick"
            title="{{ pouzivatel.organizacia_nazov if pouzivatel.typ_subjektu == 'ico' else (pouzivatel.prezyvka or (pouzivatel.meno ~ ' ' ~ pouzivatel.priezvisko)|trim) }}">
          {% if pouzivatel.typ_subjektu == 'ico' %}
            {{ pouzivatel.organizacia_nazov or '—' }}
          {% else %}
            {{ pouzivatel.prezyvka or (pouzivatel.meno ~ ' ' ~ pouzivatel.priezvisko)|trim }}
          {% endif %}
          {% if pouzivatel.is_vip %}<span class="role-badge" title="VIP">⭐</span>{% endif %}
        </h2>

        {% if can_edit %}
          <button type="button" id="editButton" class="edit-icon" title="Upraviť profil">✏️</button>
        {% elif not is_owner %}
          <a class="btn primary sm" href="{{ url_for('spravy.napisat', komu_id=pouzivatel.id, kontekst='profil', kontekst_id=pouzivatel.id) }}">✉️ Pošli správu</a>
        {% endif %}
      </div>

      {# admin prepínač VIP – zahrň default pre public_view #}
      {% if (public_view|default(true)) and current_user.is_authenticated and current_user.is_admin %}
        <div class="admin-controls" style="margin:.5rem 0; display:flex; gap:.5rem; align-items:center;">
          <span class="badge" style="padding:.2rem .5rem; border:1px solid #ddd; border-radius:.5rem;">
            Stav: {{ 'VIP (PRO výhody)' if pouzivatel.is_vip else 'Bežný' }}
          </span>

          {% if pouzivatel.is_vip %}
            <form method="POST" action="{{ url_for('uzivatel.admin_set_vip', user_id=pouzivatel.id, action='off') }}" onsubmit="return confirm('Naozaj chceš zrušiť VIP pre {{ pouzivatel.prezyvka or pouzivatel.email }}?');">
              <input type="hidden" name="next" value="{{ request.url }}">
              <button type="submit" class="btn">Zrušiť VIP</button>
            </form>
          {% else %}
            <form method="POST" action="{{ url_for('uzivatel.admin_set_vip', user_id=pouzivatel.id, action='on') }}" onsubmit="return confirm('Naozaj chceš prepnúť {{ pouzivatel.prezyvka or pouzivatel.email }} na VIP?');">
              <input type="hidden" name="next" value="{{ request.url }}">
              <button type="submit" class="btn primary">Urobiť VIP</button>
            </form>
          {% endif %}
        </div>
      {% endif %}

      {# BANNER: používaj pouzivatel, nie user #}
      {% if current_user.is_authenticated and is_owner and not pouzivatel.verejny_ucet %}
        <div class="notice warning" style="margin:.75rem 0">
          Tvoj účet je momentálne <strong>len komunitný</strong> – viditeľný len pre prihlásených používateľov.
          <a href="{{ url_for('nastavenia.prehlad') }}#sukromie" class="btn small" style="margin-left:.5rem">Zmeniť</a>
        </div>
      {% endif %}


      <!-- ======================== ZOBRAZENIE ÚDAJOV ======================== -->
      <div id="udaje-zobraz" class="profil-udaje" {% if show_edit %}style="display:none"{% endif %}>
        <p><strong>Typ účtu:</strong> {{ 'Organizácia (IČO)' if pouzivatel.typ_subjektu == 'ico' else 'Fyzická osoba' }}</p>

        {% if pouzivatel.typ_subjektu == 'ico' %}
          <p><strong>Organizácia:</strong> {{ pouzivatel.organizacia_nazov or '—' }}</p>
          <p><strong>IČO:</strong> {{ pouzivatel.ico or '—' }}</p>
          {% if pouzivatel.dic %}<p><strong>DIČ:</strong> {{ pouzivatel.dic }}</p>{% endif %}
          {% if pouzivatel.ic_dph %}<p><strong>IČ DPH:</strong> {{ pouzivatel.ic_dph }}</p>{% endif %}
          {% set u = pouzivatel.sidlo_ulica or '' %}
          {% set p = pouzivatel.sidlo_psc or '' %}
          {% set m = pouzivatel.sidlo_mesto or '' %}
          {% if u or p or m %}
            <p><strong>Sídlo:</strong> {{ [u, (p ~ ' ' ~ m)|trim]|reject('equalto','')|join(', ') }}</p>
          {% endif %}
        {% endif %}

        {% if pouzivatel.typ_subjektu != 'ico' %}
          <p><strong>Meno:</strong> {{ (pouzivatel.meno or '') ~ ' ' ~ (pouzivatel.priezvisko or '') | trim or '—' }}</p>
        {% endif %}

        <p><strong>Email:</strong> {{ pouzivatel.email or '—' }}</p>
        {% if pouzivatel.typ_subjektu != 'ico' %}
          <p><strong>Mesto / Obec:</strong> {{ pouzivatel.obec or '—' }}</p>
        {% endif %}

        {% if pouzivatel.typ_subjektu == 'ico' %}
          {% set ORG_LABELS = {
            'agentura':'Organizátor / Agentúra',
            'prenajom_techniky':'Prenájom techniky',
            'prenajom_saly':'Prenájom sály / klubu',
            'studio':'Produkčné štúdio',
            'servis':'Servis (opravy / servis techniky)',
            'zus_skola':'ZUŠ / Škola',
            'ine':'Iné'
          } %}
          <p><strong>Zaradenie:</strong>
            {{ ORG_LABELS.get(pouzivatel.org_zaradenie, pouzivatel.org_zaradenie or '—') }}
            {% if pouzivatel.org_zaradenie == 'ine' and pouzivatel.org_zaradenie_ine %}
              – {{ pouzivatel.org_zaradenie_ine }}
            {% endif %}
          </p>
        {% else %}
          {% set zlist = pouzivatel.zamerania_list() %}
          <p><strong>Zamerania:</strong>
            {% if zlist and zlist|length > 0 %}
              {{ zlist|join(', ') }}
            {% else %}—{% endif %}
          </p>
        {% endif %}

        <!-- O mne / O nás -->
        <div class="profil-omne">
          <h4>{{ 'O nás:' if pouzivatel.typ_subjektu == 'ico' else 'O mne:' }}</h4>
          {% set bio_raw = pouzivatel.bio or '' %}
          {% set bio_plain = bio_raw | striptags | trim %}
          {% if bio_plain %}
            <p class="bio-text">{{ bio_raw | e | replace('\n','<br>') | safe }}</p>
          {% else %}
            <p class="bio-text" style="color:#666;">—</p>
          {% endif %}
        </div>
      </div>

      <!-- ======================== EDITAČNÝ FORMULÁR ======================== -->
      {% if can_edit %}
      <form id="editForm" method="POST" action="{{ url_for('uzivatel.profil') }}" class="form-profil" {% if not show_edit %}style="display:none"{% endif %}>
        <div id="fo-identita-blok">
          <div class="form-row">
            <label for="prezyvka">Prezývka *</label>
            <input id="prezyvka" type="text" name="prezyvka"
                  class="ucontrol" value="{{ pouzivatel.prezyvka or '' }}" required autocomplete="nickname">
          </div>
          <div class="form-row">
            <label for="meno">Meno</label>
            <input id="meno" type="text" name="meno"
                  class="ucontrol" value="{{ pouzivatel.meno or '' }}" autocomplete="given-name">
          </div>
          <div class="form-row">
            <label for="priezvisko">Priezvisko</label>
            <input id="priezvisko" type="text" name="priezvisko"
                  class="ucontrol" value="{{ pouzivatel.priezvisko or '' }}" autocomplete="family-name">
          </div>
        </div>

        <div class="form-row">
          <label for="email">Email *</label>
          <input id="email" type="email" name="email"
                class="ucontrol" value="{{ pouzivatel.email or '' }}" required autocomplete="email">
        </div>
        
        <!-- Zameranie (hlavná rola) — presne ako registrácia -->
        <div class="form-row">
          <label for="rola">Zameranie *</label>
          {% set r = pouzivatel.rola or '' %}
          <select id="rola" name="rola" class="ucontrol select" required>
            <option value="">— vyber —</option>
            <option value="hudobnik"      {{ 'selected' if r=='hudobnik'      else '' }}>Hudobník</option>
            <option value="tanecnik"      {{ 'selected' if r=='tanecnik'      else '' }}>Tanečník</option>
            <option value="moderator"     {{ 'selected' if r=='moderator'     else '' }}>Moderátor akcií</option>
            <option value="fotograf"      {{ 'selected' if r=='fotograf'      else '' }}>Fotograf</option>
            <option value="videograf"     {{ 'selected' if r=='videograf'     else '' }}>Videograf</option>
            <option value="zvukar"        {{ 'selected' if r=='zvukar'        else '' }}>Zvukár</option>
            <option value="osvetlovac"    {{ 'selected' if r=='osvetlovac'    else '' }}>Osvetľovač</option>
            <option value="technik_podia" {{ 'selected' if r=='technik_podia' else '' }}>Technik pódia / Roadie</option>
            <option value="producent"     {{ 'selected' if r=='producent'     else '' }}>Producent / Beatmaker</option>
            <option value="skladatel"     {{ 'selected' if r=='skladatel'     else '' }}>Skladateľ / Aranžér</option>
            <option value="ucitel_hudby"  {{ 'selected' if r=='ucitel_hudby'  else '' }}>Učiteľ hudby</option>
            <option value="ine"           {{ 'selected' if r=='ine'           else '' }}>Iné</option>
          </select>
        </div>

        {# ===== HUDOBNÍK — oblasť + špecifikácia (ako Tanečník: checkboxy) ===== #}
        {% set hud_val = pouzivatel.hud_oblast or '' %}
        {% set hud_spec_sel = (pouzivatel.hud_spec or '').split(',') if pouzivatel.hud_spec else [] %}

        <div id="wrap-sub-hudobnik" style="display:none;">
          <div class="form-row">
            <label for="hud_oblast">Hudobník — oblasť *</label>
            <select id="hud_oblast" name="hud_oblast" class="ucontrol select">
              <option value="">— vyber —</option>
              <option value="spev"        {{ 'selected' if hud_val=='spev'        else '' }}>Spev</option>
              <option value="klavesy"     {{ 'selected' if hud_val=='klavesy'     else '' }}>Klávesy</option>
              <option value="gitara"      {{ 'selected' if hud_val=='gitara'      else '' }}>Gitara</option>
              <option value="bicie"       {{ 'selected' if hud_val=='bicie'       else '' }}>Bicie / Perkusie</option>
              <option value="slacikove"   {{ 'selected' if hud_val=='slacikove'   else '' }}>Sláčikové</option>
              <option value="dychove"     {{ 'selected' if hud_val=='dychove'     else '' }}>Dychové</option>
              <option value="dj"          {{ 'selected' if hud_val=='dj'          else '' }}>DJ</option>
              <option value="elektronika" {{ 'selected' if hud_val=='elektronika' else '' }}>Elektronika (live)</option>
              <option value="folklorne"   {{ 'selected' if hud_val=='folklorne'   else '' }}>Folklórne</option>
              <option value="ine"         {{ 'selected' if hud_val=='ine'         else '' }}>Iné</option>
            </select>
          </div>

          {# SPEV #}
          <div class="hud-spec" id="hud-spec-spev">
            <div class="form-row">
              <label>Špecifikácia spevu</label>
              <div class="checkbox-grid">
                {% for val,lbl in [('solo','Sólo'),('vokal','Vokál'),('zbor','Zbor')] %}
                <label class="chk">
                  <input type="checkbox" name="hud_spec[]" value="{{ val }}" {% if val in hud_spec_sel %}checked{% endif %}>
                  <span>{{ lbl }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>

          {# KLÁVESY #}
          <div class="hud-spec" id="hud-spec-klavesy">
            <div class="form-row">
              <label>Špecifikácia klávesov</label>
              <div class="checkbox-grid">
                {% for val,lbl in [('klavir','Klavír'),('keyboard','Keyboard'),('synth','Synthesizer'),('organ','Organ / Hammond'),('ine','Iné')] %}
                <label class="chk">
                  <input type="checkbox" name="hud_spec[]" value="{{ val }}" {% if val in hud_spec_sel %}checked{% endif %}>
                  <span>{{ lbl }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>

          {# GITARA #}
          <div class="hud-spec" id="hud-spec-gitara">
            <div class="form-row">
              <label>Špecifikácia gitary</label>
              <div class="checkbox-grid">
                {% for val,lbl in [('elektricka','Elektrická'),('akusticka','Akustická'),('klasicka','Klasická'),('basgitara','Basgitara'),('ine','Iné')] %}
                <label class="chk">
                  <input type="checkbox" name="hud_spec[]" value="{{ val }}" {% if val in hud_spec_sel %}checked{% endif %}>
                  <span>{{ lbl }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>

          {# BICIE #}
          <div class="hud-spec" id="hud-spec-bicie">
            <div class="form-row">
              <label>Špecifikácia bicích/perkusií</label>
              <div class="checkbox-grid">
                {% for val,lbl in [('bicie_suprava','Bicie súprava'),('perkusie','Perkusie'),('cajon','Cajon'),('ine','Iné')] %}
                <label class="chk">
                  <input type="checkbox" name="hud_spec[]" value="{{ val }}" {% if val in hud_spec_sel %}checked{% endif %}>
                  <span>{{ lbl }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>

          {# SLÁČIKOVÉ #}
          <div class="hud-spec" id="hud-spec-slacikove">
            <div class="form-row">
              <label>Špecifikácia sláčikových</label>
              <div class="checkbox-grid">
                {% for val,lbl in [('husle','Husle'),('viola','Viola'),('violoncello','Violončelo'),('kontrabas','Kontrabas'),('ine','Iné')] %}
                <label class="chk">
                  <input type="checkbox" name="hud_spec[]" value="{{ val }}" {% if val in hud_spec_sel %}checked{% endif %}>
                  <span>{{ lbl }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>

          {# DYCHOVÉ #}
          <div class="hud-spec" id="hud-spec-dychove">
            <div class="form-row">
              <label>Špecifikácia dychových</label>
              <div class="checkbox-grid">
                {% for val,lbl in [('saxofon','Saxofón'),('klarinet','Klarinet'),('priecna_flauta','Priečna flauta'),('trumpeta','Trumpeta'),('pozoun','Pozoun'),('lesny_rog','Lesný roh'),('tuba','Tuba'),('ine','Iné')] %}
                <label class="chk">
                  <input type="checkbox" name="hud_spec[]" value="{{ val }}" {% if val in hud_spec_sel %}checked{% endif %}>
                  <span>{{ lbl }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>

          {# DJ #}
          <div class="hud-spec" id="hud-spec-dj">
            <div class="form-row">
              <label>DJ – štýly</label>
              <div class="checkbox-grid">
                {% for val,lbl in [('svadobny','Svadobný'),('oldies','Oldies'),('80s_90s','80s/90s'),('komercne','Komerčné'),('house','House'),('techno','Techno')] %}
                <label class="chk">
                  <input type="checkbox" name="hud_spec[]" value="{{ val }}" {% if val in hud_spec_sel %}checked{% endif %}>
                  <span>{{ lbl }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>

          {# ELEKTRONIKA #}
          <div class="hud-spec" id="hud-spec-elektronika">
            <div class="form-row">
              <label>Elektronika (live)</label>
              <div class="checkbox-grid">
                {% for val,lbl in [('sampler','Sampler'),('drum_machine','Drum machine'),('live_perf','Live performance'),('ine','Iné')] %}
                <label class="chk">
                  <input type="checkbox" name="hud_spec[]" value="{{ val }}" {% if val in hud_spec_sel %}checked{% endif %}>
                  <span>{{ lbl }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>

          {# FOLKLÓRNE #}
          <div class="hud-spec" id="hud-spec-folklorne">
            <div class="form-row">
              <label>Folklórne</label>
              <div class="checkbox-grid">
                {% for val,lbl in [('cimbal','Cimbal'),('akordeon','Akordeón'),('heligonka','Heligónka'),('gajdy','Gajdy'),('fujara','Fujara'),('ine','Iné')] %}
                <label class="chk">
                  <input type="checkbox" name="hud_spec[]" value="{{ val }}" {% if val in hud_spec_sel %}checked{% endif %}>
                  <span>{{ lbl }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>

          {# OBLASŤ = INÉ (len voľný text) #}
          <div class="hud-spec" id="hud-spec-ine">
            <div class="form-row">
              <label>Upresni „iné“</label>
              <input type="text" name="hud_spec_extra" class="input-line"
                    value="{{ (hud_val=='ine') and (pouzivatel.hud_spec or '') or '' }}">
            </div>
          </div>
        </div>


        <script>
        function syncHudSpec() {
          const sel = document.getElementById('hud_oblast');
          const blocks = document.querySelectorAll('#wrap-sub-hudobnik .hud-spec');

          // skry len vizuálne, NEdeaktivuj inputy
          blocks.forEach(b => {
            b.style.display = 'none';
          });

          const v = sel ? sel.value : '';
          const active = document.getElementById('hud-spec-' + v);
          if (active) {
            active.style.display = 'block';
          }
        }

        document.addEventListener('DOMContentLoaded', () => {
          const sel = document.getElementById('hud_oblast');
          if (sel) {
            sel.addEventListener('change', syncHudSpec);
            syncHudSpec();
          }
        });
        </script>

  
        <!-- TANEČNÍK — checkboxy -->
        {% set tan_sel = (pouzivatel.tanec_spec or '').split(',') if pouzivatel.tanec_spec else [] %}
        <div id="wrap-sub-tanecnik" style="display:none;">
          <div class="form-row">
            <label>Tanečné zameranie</label>
            <div class="checkbox-grid">
              {% for val, lbl in [
                ('moderne','Moderné / Contemporary'),
                ('folklor_subor','Folklórny súbor'),
                ('latino','Latino (Salsa/Bachata)'),
                ('street','Street / Hip-hop'),
                ('ballroom','Ballroom (Štandard/Latina)'),
                ('spolocenske','Spoločenské / Club'),
                ('pedagog','Tanečný pedagóg'),
                ('ine','Iné'),
              ] %}
              <label class="chk">
                <input type="checkbox" name="tanec_spec_multi" value="{{ val }}" {% if val in tan_sel %}checked{% endif %}>
                <span>{{ lbl }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          <div class="form-row stack" id="tanec_ine_wrap" style="display:none;">
            <label for="tanec_ine_text">Upresni „iné“</label>
            <input type="text" id="tanec_ine_text" name="tanec_ine_text" class="ucontrol select" value="{{ pouzivatel.tanec_ine or '' }}">
          </div>
        </div>

        {# MODERÁTOR — viac možností (checkboxy) #}
        {% set pod_multi = (pouzivatel.moderator_podrola or '').split(',') if pouzivatel.moderator_podrola else [] %}
        <div id="wrap-sub-moderator" style="display:none;">
          <div class="form-row">
            <label>Spresnenie</label>
            <div class="checkbox-grid">
              {% for val,lbl in [
                ('staresi','Starejší'),
                ('moderator','Moderátor'),
                ('moderator_hudobnych_akcii','Moderátor hudobných akcií'),
              ] %}
              <label class="chk">
                <input type="checkbox" name="podrola_multi" value="{{ val }}" {% if val in pod_multi %}checked{% endif %}>
                <span>{{ lbl }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>


        <!-- UČITEĽ HUDBY — checkboxy -->
        {% set uc_sel = (pouzivatel.ucitel_predmety or '').split(',') if pouzivatel.ucitel_predmety else [] %}
        <div id="wrap-sub-ucitel" style="display:none;">
          <div class="form-row">
            <label>Učím (vyber aspoň jedno)</label>
            <div class="checkbox-grid">
              {% for val,lbl in [
                ('klavir','Klavír'),('gitara','Gitara'),('husle','Husle'),('flauta','Flauta'),
                ('saxofon','Saxofón'),('klarinet','Klarinet'),('trumpeta','Trúbka'),('bicie','Bicie'),
                ('spev','Spev'),('akordeon','Akordeón'),('heligonka','Heligónka'),('teoria','Hudobná teória'),
                ('ine','Iné')
              ] %}
              <label class="chk">
                <input type="checkbox" name="ucitel_predmety_multi" value="{{ val }}" {% if val in uc_sel %}checked{% endif %}>
                <span>{{ lbl }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          <div class="form-row stack" id="ucitel_ine_wrap" style="display:none;">
            <label for="ucitel_ine_text">Upresni „iné“</label>
            <input type="text" id="ucitel_ine_text" name="ucitel_ine_text" class="ucontrol select" value="{{ pouzivatel.ucitel_ine or '' }}">
          </div>
        </div>

        {% set simple = pouzivatel.simple_roles_selected or [] %}

        <!-- FOTOGRAF -->
        <div id="wrap-sub-fotograf" style="display:none;">
          <div class="form-row">
            <label>Špecifikácia</label>
            <div class="checkbox-grid">
              <label class="chk">
                <input type="checkbox" name="simple_role_multi" value="fotograf" {{ 'checked' if 'fotograf' in simple else '' }}>
                <span>Fotograf</span>
              </label>
            </div>
          </div>
        </div>

        <!-- VIDEOGRAF -->
        <div id="wrap-sub-videograf" style="display:none;">
          <div class="form-row">
            <label>Špecifikácia</label>
            <div class="checkbox-grid">
              <label class="chk">
                <input type="checkbox" name="simple_role_multi" value="videograf" {{ 'checked' if 'videograf' in simple else '' }}>
                <span>Videograf</span>
              </label>
            </div>
          </div>
        </div>

        <!-- ZVUKÁR -->
        <div id="wrap-sub-zvukar" style="display:none;">
          <div class="form-row">
            <label>Špecifikácia</label>
            <div class="checkbox-grid">
              <label class="chk">
                <input type="checkbox" name="simple_role_multi" value="zvukar" {{ 'checked' if 'zvukar' in simple else '' }}>
                <span>Zvukár</span>
              </label>
            </div>
          </div>
        </div>

        <!-- OSVETĽOVAČ -->
        <div id="wrap-sub-osvetlovac" style="display:none;">
          <div class="form-row">
            <label>Špecifikácia</label>
            <div class="checkbox-grid">
              <label class="chk">
                <input type="checkbox" name="simple_role_multi" value="osvetlovac" {{ 'checked' if 'osvetlovac' in simple else '' }}>
                <span>Osvetľovač</span>
              </label>
            </div>
          </div>
        </div>

        <!-- TECHNIK PÓDIA / ROADIE -->
        <div id="wrap-sub-technik_podia" style="display:none;">
          <div class="form-row">
            <label>Špecifikácia</label>
            <div class="checkbox-grid">
              <label class="chk">
                <input type="checkbox" name="simple_role_multi" value="technik_podia" {{ 'checked' if 'technik_podia' in simple else '' }}>
                <span>Technik pódia / Roadie</span>
              </label>
            </div>
          </div>
        </div>

        <!-- PRODUCENT / BEATMAKER -->
        <div id="wrap-sub-producent" style="display:none;">
          <div class="form-row">
            <label>Špecifikácia</label>
            <div class="checkbox-grid">
              <label class="chk">
                <input type="checkbox" name="simple_role_multi" value="producent" {{ 'checked' if 'producent' in simple else '' }}>
                <span>Producent / Beatmaker</span>
              </label>
            </div>
          </div>
        </div>

        <!-- SKLADATEĽ / ARANŽÉR -->
        <div id="wrap-sub-skladatel" style="display:none;">
          <div class="form-row">
            <label>Špecifikácia</label>
            <div class="checkbox-grid">
              <label class="chk">
                <input type="checkbox" name="simple_role_multi" value="skladatel" {{ 'checked' if 'skladatel' in simple else '' }}>
                <span>Skladateľ / Aranžér</span>
              </label>
            </div>
          </div>
        </div>


        <!-- „Iné“ rola -->
        <div id="wrap-rola-ine" style="display:none;">
          <div class="form-row stack">
            <label for="rola_ina">Zameranie – iné</label>
            <input type="text" id="rola_ina" name="rola_ina" class="ucontrol select" value="{{ pouzivatel.rola_ina or '' }}" placeholder="napr. fotograf-koncerty, dramaturg…">
            <div class="form-help">Zbierame návrhy na nové kategórie.</div>
          </div>
        </div>
        

  <!-- Typ účtu (select) -->
        <div class="form-row">
          <label for="typ-subjektu-select">Typ účtu</label>
          <select name="typ_subjektu" id="typ-subjektu-select" class="ucontrol select">
            <option value="fyzicka" {{ 'selected' if pouzivatel.typ_subjektu != 'ico' else '' }}>Fyzická osoba</option>
            <option value="ico"     {{ 'selected' if pouzivatel.typ_subjektu == 'ico' else '' }}>Organizácia (IČO)</option>
          </select>
        </div>


        <div id="profil-ico-blok" {% if pouzivatel.typ_subjektu != 'ico' %}style="display:none"{% endif %}>
          <div class="form-row">
            <label for="ico">IČO *</label>
            <input id="ico" type="text" name="ico" class="ucontrol"
                  inputmode="numeric" pattern="\d{6,10}" title="IČO: 6–10 číslic"
                  value="{{ pouzivatel.ico or '' }}">
          </div>

          <div class="form-row">
            <label for="organizacia_nazov">Názov organizácie *</label>
            <input id="organizacia_nazov" type="text" name="organizacia_nazov" class="ucontrol"
                  value="{{ pouzivatel.organizacia_nazov or '' }}">
          </div>

          <div class="form-row">
            <label for="dic">DIČ</label>
            <input id="dic" type="text" name="dic" class="ucontrol"
                  value="{{ pouzivatel.dic or '' }}">
          </div>

          <div class="form-row">
            <label for="ic_dph">IČ DPH</label>
            <input id="ic_dph" type="text" name="ic_dph" class="ucontrol"
                  value="{{ pouzivatel.ic_dph or '' }}">
          </div>

          <div class="form-row">
            <label for="sidlo_ulica">Sídlo – ulica</label>
            <input id="sidlo_ulica" type="text" name="sidlo_ulica" class="ucontrol"
                  value="{{ pouzivatel.sidlo_ulica or '' }}">
          </div>

          <div class="form-row">
            <label for="sidlo_psc">Sídlo – PSČ</label>
            <input id="sidlo_psc" type="text" name="sidlo_psc" class="ucontrol"
                  inputmode="numeric" pattern="\d{3}\s?\d{2}" title="Formát: 000 00"
                  value="{{ pouzivatel.sidlo_psc or '' }}">
          </div>

          <div class="form-row">
            <label for="sidlo_mesto">Sídlo – mesto</label>
            <select id="sidlo_mesto" name="sidlo_mesto" class="ucontrol select">
              <option value="">— vyber —</option>
              {% for m in (mesta_all or []) %}
                <option value="{{ m.nazov }}"
                        {{ 'selected' if (pouzivatel.sidlo_mesto or '') == m.nazov else '' }}>
                  {{ m.nazov }}{% if m.okres %}, {{ m.okres }}{% endif %}{% if m.kraj %}, {{ m.kraj }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-row">
            <label for="org_zaradenie">Zaradenie *</label>
            {% set oz = pouzivatel.org_zaradenie or '' %}
            <select id="org_zaradenie" name="org_zaradenie" class="ucontrol select" required>
              <option value="">— vyber —</option>
              <option value="agentura"          {{ 'selected' if oz=='agentura'          else '' }}>Organizátor / Agentúra</option>
              <option value="prenajom_techniky" {{ 'selected' if oz=='prenajom_techniky' else '' }}>Prenájom techniky</option>
              <option value="prenajom_saly"     {{ 'selected' if oz=='prenajom_saly'     else '' }}>Prenájom sály / klubu</option>
              <option value="studio"            {{ 'selected' if oz=='studio'            else '' }}>Produkčné štúdio</option>
              <option value="servis"            {{ 'selected' if oz=='servis'            else '' }}>Servis (opravy / servis techniky)</option>
              <option value="zus_skola"         {{ 'selected' if oz=='zus_skola'         else '' }}>ZUŠ / Škola</option>
              <option value="ine"               {{ 'selected' if oz=='ine'               else '' }}>Iné</option>
            </select>
          </div>
          <div class="form-row stack" id="org_zaradenie_ine_wrap" style="display:none;">
            <label for="org_zaradenie_ine">Zaradenie – iné</label>
            <input type="text" id="org_zaradenie_ine" name="org_zaradenie_ine" class="ucontrol"
                  value="{{ pouzivatel.org_zaradenie_ine or '' }}">
          </div>
          <!-- O mne (textarea) -->
          <div class="form-row">
            <label for="bio">{{ 'O nás:' if pouzivatel.typ_subjektu == 'ico' else 'O mne:' }}</label>
            <textarea id="bio" name="bio" class="ucontrol" rows="4"
                      placeholder="Krátky popis (kto ste, čomu sa venujete)…">{{- pouzivatel.bio or '' -}}</textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn primary">💾 Uložiť zmeny</button>
          <button type="button" id="cancelEdit" class="btn">Zrušiť</button>
        </div>
      </form>
      {% endif %}


    </aside>  {# <-- NECHÝBAJÚCE UZATVORENIE ASIDE #}

    <!-- PRAVÁ STRANA -->
    <div class="profil-right">
      <div class="profil-right-card">
        {% if skupina %}
        <section class="sekcia">
          <h3>Skupina</h3>
          <p><strong>Názov:</strong> {{ skupina.nazov }}</p>
          {% if skupina.clenovia and skupina.clenovia|length > 0 %}
            <p><strong>Členovia:</strong></p>
            <ul>
              {% for clen in skupina.clenovia %}
                <li>{{ clen.meno or clen.prezyvka }}{% if clen.instrument %} – {{ clen.instrument }}{% endif %}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p>Žiadni členovia.</p>
          {% endif %}
        </section>
        {% endif %}

        <section class="sekcia">
          <div class="sekcia-head">
            <h3>Galéria</h3>
            {% if can_edit %}
              {% set max_foto = 10 %}
              {% set pocet = pouzivatel.galeria|length %}
              {% set zostava = (max_foto - pocet) if pocet < max_foto else 0 %}
              <form method="POST" action="{{ url_for('profil.nahraj_fotku') }}" enctype="multipart/form-data" id="upload-form-gal">
                <input type="file" id="upload-foto-gal" name="fotos" accept="image/*" multiple hidden {% if zostava == 0 %}disabled{% endif %} onchange="this.form.submit()">
                <label for="upload-foto-gal" class="btn primary sm {% if zostava == 0 %}disabled{% endif %}" {% if zostava == 0 %}title="Limit 10 fotiek je naplnený"{% else %}title="Nahrať fotky (môžeš označiť viac)"{% endif %}>➕ Nahrať</label>
                <small class="gal-limit">{% if zostava > 0 %} zostáva {{ zostava }} {% else %} limit 10/10 {% endif %}</small>
              </form>
            {% endif %}
          </div>

          {% if pouzivatel.galeria and pouzivatel.galeria|length > 0 %}
          <div class="galeria-wrapper" id="profil-galeria">
            {% for foto in pouzivatel.galeria %}
              <div class="foto-blok">
                {% set img_src = url_for('static', filename='galeria_pouzivatel/' ~ foto.nazov_suboru) %}
                <img src="{{ img_src }}" alt="Foto {{ loop.index }}" class="galeria-foto thumb" data-index="{{ loop.index0 }}">
                {% if can_edit %}
                <form method="POST" action="{{ url_for('profil.zmaz_fotku', id=foto.id) }}" class="delete-form" onsubmit="return confirm('Naozaj chceš zmazať túto fotku?');">
                  <button type="submit" class="delete-btn" title="Zmazať">✖</button>
                </form>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% else %}
            <p class="sekcia-empty">Zatiaľ bez fotiek.</p>
          {% endif %}
        </section>

        <section class="sekcia">
          <div class="sekcia-head">
            <h3>Videá</h3>
            <p class="profil-pocet-videi" style="margin:0; color:#666;">Počet videí: {{ youtube_videa | length }}</p>
          </div>

          {% if can_edit %}
          <form action="{{ url_for('profil.pridaj_video') }}" method="POST" class="profil-videoform">
            <input type="url" name="youtube_url" placeholder="https://www.youtube.com/watch?v=..." required>
            <input type="text" name="popis" placeholder="Krátky popis (voliteľné)">
            <button type="submit" class="btn primary">➕ Pridať video</button>
          </form>
          {% endif %}

          {% if youtube_videa and youtube_videa|length > 0 %}
          <div class="profil-video-grid">
            {% for video in youtube_videa %}
              <div class="profil-youtube-video">
                <iframe src="https://www.youtube.com/embed/{{ video.youtube_url | youtube_id }}" title="YouTube video" frameborder="0" allowfullscreen loading="lazy"></iframe>
                {% if video.popis %}<p class="video-popis">{{ video.popis }}</p>{% endif %}
                {% if can_edit %}
                <form action="{{ url_for('profil.zmaz_video', id=video.id) }}" method="POST" class="delete-form">
                  <button type="submit" class="delete-btn" title="Zmazať video" onclick="return confirm('Naozaj chceš zmazať video?')">✖</button>
                </form>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% else %}
            <p class="sekcia-empty">Zatiaľ bez videí.</p>
          {% endif %}
        </section>
      </div>
    </div>

  </div>
</section>

<!-- Prepínanie editácie + Avatar fallback + logika podsekcií -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // ---- prepínanie view/form
  const btnEdit   = document.getElementById('editButton');
  const form      = document.getElementById('editForm');
  const viewBlock = document.getElementById('udaje-zobraz');
  const btnCancel = document.getElementById('cancelEdit');

  function openEdit(){ if(form&&viewBlock){ form.style.display='block'; viewBlock.style.display='none'; } }
  function closeEdit(){ if(form&&viewBlock){ form.style.display='none'; viewBlock.style.display='block'; } }

  btnEdit && btnEdit.addEventListener('click', (e)=>{ e.preventDefault(); openEdit(); });
  btnCancel && btnCancel.addEventListener('click', (e)=>{ e.preventDefault(); closeEdit(); });

  // ---- úseky podľa roly (FO)
  const rolaSel = document.getElementById('rola');
  const blocks = {
    hudobnik:      document.getElementById('wrap-sub-hudobnik'),
    tanecnik:      document.getElementById('wrap-sub-tanecnik'),
    moderator:     document.getElementById('wrap-sub-moderator'),
    ucitel_hudby:  document.getElementById('wrap-sub-ucitel'),
    fotograf:      document.getElementById('wrap-sub-fotograf'),
    videograf:     document.getElementById('wrap-sub-videograf'),
    zvukar:        document.getElementById('wrap-sub-zvukar'),
    osvetlovac:    document.getElementById('wrap-sub-osvetlovac'),
    technik_podia: document.getElementById('wrap-sub-technik_podia'),
    producent:     document.getElementById('wrap-sub-producent'),
    skladatel:     document.getElementById('wrap-sub-skladatel'),
    ine:           document.getElementById('wrap-rola-ine')
  };
  const tanIneWrap = document.getElementById('tanec_ine_wrap');
  const ucIneWrap  = document.getElementById('ucitel_ine_wrap');

  function syncRole(){
    const v = rolaSel ? rolaSel.value : '';
    Object.values(blocks).forEach(b => { if (b) b.style.display = 'none'; });
    if (blocks[v]) blocks[v].style.display = 'block';

    if (tanIneWrap) {
      const anyIne = !!document.querySelector('input[name="tanec_spec_multi"][value="ine"]:checked');
      tanIneWrap.style.display = anyIne ? 'block' : 'none';
    }
    if (ucIneWrap) {
      const anyIne = !!document.querySelector('input[name="ucitel_predmety_multi"][value="ine"]:checked');
      ucIneWrap.style.display = anyIne ? 'block' : 'none';
    }
  }
  document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'rola') syncRole();
    if (e.target && e.target.name === 'tanec_spec_multi') syncRole();
    if (e.target && e.target.name === 'ucitel_predmety_multi') syncRole();
  });

  // ---- IČO / FO logika
  const selTyp   = document.getElementById('typ-subjektu-select');
  const icoBlk   = document.getElementById('profil-ico-blok');
  const foRolaRow = document.getElementById('rola')?.closest('.form-row') ||
                    document.querySelector('.form-row > label[for="rola"]')?.parentElement;

  // Zaradenie (IČO) "iné"
  const orgZar     = document.getElementById('org_zaradenie');
  const orgZarWrap = document.getElementById('org_zaradenie_ine_wrap');
  const orgZarRow  = document.getElementById('org_zar_row');

  function syncOrgZar(){ if (orgZar && orgZarWrap) orgZarWrap.style.display = (orgZar.value === 'ine') ? 'block' : 'none'; }
  orgZar && orgZar.addEventListener('change', syncOrgZar);

  function hideAllFoSubblocks(){
    ['wrap-sub-hudobnik','wrap-sub-tanecnik','wrap-sub-moderator','wrap-sub-ucitel',
     'wrap-sub-fotograf','wrap-sub-videograf','wrap-sub-zvukar','wrap-sub-osvetlovac',
     'wrap-sub-technik_podia','wrap-sub-producent','wrap-sub-skladatel','wrap-rola-ine'
    ].forEach(id => { const el=document.getElementById(id); if (el) el.style.display='none'; });
  }

  function syncICO(){
    const isICO = (selTyp?.value === 'ico');

    if (icoBlk) icoBlk.style.display = isICO ? 'block' : 'none';
    if (foRolaRow) foRolaRow.style.display = isICO ? 'none' : 'grid';

    // FO identita blok
    const foIdent = document.getElementById('fo-identita-blok');
    if (foIdent) foIdent.style.display = isICO ? 'none' : 'block';

    // ⬇️ NOVÉ: Zaradenie riadok + required + skryť "iné" pri FO
    if (orgZarRow) orgZarRow.style.display = isICO ? 'grid' : 'none';
    if (orgZar)    orgZar.required = isICO;
    if (!isICO && orgZarWrap) orgZarWrap.style.display = 'none';

    // povinnosti
    if (form){
      const ico = form.querySelector('input[name="ico"]');
      const org = form.querySelector('input[name="organizacia_nazov"]');
      const prezyvka = document.getElementById('prezyvka');
      if (ico) ico.required = isICO;
      if (org) org.required = isICO;
      if (prezyvka) prezyvka.required = !isICO;   // prezývka len pre FO
    }
    if (rolaSel) rolaSel.required = !isICO;

    // „O mne“ → „O nás“ label
    const bioLabel = document.querySelector('label[for="bio"]');
    if (bioLabel) bioLabel.textContent = isICO ? 'O nás:' : 'O mne:';

    if (isICO){ hideAllFoSubblocks(); }
    syncOrgZar(); // nech rieši "iné" len keď je IČO aktívne
  }

  selTyp && selTyp.addEventListener('change', syncICO);

  // ---- init
  syncRole();
  syncICO();
  syncOrgZar();
});

// Avatar fallback (mimo DOMContentLoaded je OK)
document.addEventListener('error', function(e){
  var img = e.target;
  if (!(img instanceof HTMLImageElement) || !img.classList.contains('avatar')) return;
  img.classList.remove('avatar');
  var fb = img.getAttribute('data-fallback') || '{{ url_for("static", filename="profilovky/default.png") }}';
  img.src = fb;
}, true);
</script>


<style>
  .galeria-wrapper{ display:grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap:.75rem; }
  .foto-blok{ position:relative; }
  .galeria-foto.thumb{ width:100%; height:140px; object-fit:cover; border-radius:.5rem; cursor:pointer; display:block; }
  .delete-form{ position:absolute; top:.35rem; right:.35rem; }
  .delete-btn{ background:rgba(0,0,0,.6); color:#fff; border:0; border-radius:.4rem; padding:.2rem .4rem; cursor:pointer; }

  .role-detail{margin:.6rem 0;padding:.6rem;border:1px dashed #ddd;border-radius:.5rem;background:#fafafa}
  .checkbox-grid{display:grid;gap:.35rem .75rem;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .chk{display:flex;align-items:center;gap:.5rem}
</style>
{% endblock %}
