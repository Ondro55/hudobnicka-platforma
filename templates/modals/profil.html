{% extends 'base.html' %}
{% set is_owner = current_user.is_authenticated and current_user.id == pouzivatel.id %}

{% block content %}
<section class="profil-page">
  <div class="profil-grid">
    <!-- ƒΩAV√Å STRANA -->
    <aside class="profil-left" id="profilLeft">
      <div class="profil-fotka-wrapper">
        {% set foto_url = pouzivatel.profil_fotka_url %}
        <img class="profilovka avatar"
             src="{{ foto_url }}"
             data-fallback="{{ url_for('static', filename='profilovky/default.png') }}"
             alt="Profilov√° fotka">

        {% if is_owner %}
          <!-- overlay: zmena fotky (‚úèÔ∏è) -->
          <form id="upload-form-user" action="{{ url_for('uzivatel.upload_fotka') }}" method="post" enctype="multipart/form-data" class="profil-upload-fotky">
            <input id="upload-input-user" type="file" name="profil_fotka" accept="image/*" onchange="this.form.submit()" hidden>
            <label for="upload-input-user" class="foto-action edit" title="Zmeni≈• fotku">‚úèÔ∏è</label>
          </form>

          {% if pouzivatel.profil_fotka %}
          <!-- overlay: odstr√°ni≈• fotku (‚úñ) -->
          <a href="{{ url_for('uzivatel.odstranit_fotku') }}" class="foto-action delete" title="Odstr√°ni≈• fotku">‚úñ</a>
          {% endif %}
        {% endif %}
      </div>

      <!-- Nick + edit / spr√°va pod fotkou -->
      <div class="profil-nickline">
        <h2 class="profil-nick">
          {{ pouzivatel.prezyvka or (pouzivatel.meno ~ ' ' ~ pouzivatel.priezvisko)|trim }}
        </h2>

        {% if is_owner %}
          <button type="button" id="editButton" class="edit-icon" title="Upravi≈• profil">‚úèÔ∏è</button>
        {% else %}
          <a class="btn primary sm"
             href="{{ url_for('spravy.napisat', komu_id=pouzivatel.id, kontekst='profil', kontekst_id=pouzivatel.id) }}">
            ‚úâÔ∏è Po≈°li spr√°vu
          </a>
        {% endif %}
      </div>

      <!-- Zobrazenie √∫dajov -->
      <div id="udaje-zobraz" class="profil-udaje">
        <p><strong>Meno:</strong> {{ pouzivatel.meno }} {{ pouzivatel.priezvisko }}</p>
        <p><strong>Email:</strong> {{ pouzivatel.email }}</p>
        <p><strong>Mesto / Obec:</strong> {{ pouzivatel.obec or '‚Äî' }}</p>
        <p><strong>Hudobn√Ω n√°stroj:</strong> {{ pouzivatel.instrument or '‚Äî' }}</p>
        <p><strong>Doplnkov√Ω n√°stroj:</strong> {{ pouzivatel.doplnkovy_nastroj or '‚Äî' }}</p>

        {% if pouzivatel.bio %}
        <div class="profil-omne">
          <h4>O mne</h4>
          <p>{{ pouzivatel.bio }}</p>
        </div>
        {% endif %}
      </div>

      <!-- Editaƒçn√Ω formul√°r (skryt√Ω, zap√≠na sa tlaƒçidlom) -->
      {% if is_owner %}
      <form id="editForm" method="POST" action="{{ url_for('uzivatel.profil') }}" class="form-profil">
        <div class="form-row"><label>Prez√Ωvka:</label><input type="text" name="prezyvka" value="{{ pouzivatel.prezyvka }}" required></div>
        <div class="form-row"><label>Meno:</label><input type="text" name="meno" value="{{ pouzivatel.meno }}"></div>
        <div class="form-row"><label>Priezvisko:</label><input type="text" name="priezvisko" value="{{ pouzivatel.priezvisko }}"></div>
        <div class="form-row"><label>Email:</label><input type="email" name="email" value="{{ pouzivatel.email }}" required></div>
        <div class="form-row"><label>Mesto / Obec:</label><input type="text" name="obec" value="{{ pouzivatel.obec }}"></div>
        <div class="form-row"><label>Hudobn√Ω n√°stroj:</label><input type="text" name="instrument" value="{{ pouzivatel.instrument }}"></div>
        <div class="form-row"><label>Doplnkov√Ω n√°stroj:</label><input type="text" name="doplnkovy_nastroj" value="{{ pouzivatel.doplnkovy_nastroj }}"></div>
        <div class="form-row"><label for="bio">O mne:</label><textarea id="bio" name="bio">{{ pouzivatel.bio or '' }}</textarea></div>
        <div class="form-actions">
          <button type="submit" class="btn primary">üíæ Ulo≈æi≈• zmeny</button>
          <button type="button" id="cancelEdit" class="btn">Zru≈°i≈•</button>
        </div>
      </form>
      {% endif %}
    </aside>

    <!-- PRAV√Å STRANA -->
    <div class="profil-right">
      <div class="profil-right-card">
        {% if skupina %}
        <section class="sekcia">
          <h3>Skupina</h3>
          <p><strong>N√°zov:</strong> {{ skupina.nazov }}</p>
          {% if skupina.clenovia and skupina.clenovia|length > 0 %}
            <p><strong>ƒålenovia:</strong></p>
            <ul>
              {% for clen in skupina.clenovia %}
                <li>{{ clen.meno or clen.prezyvka }}{% if clen.instrument %} ‚Äì {{ clen.instrument }}{% endif %}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p>≈Ωiadni ƒçlenovia.</p>
          {% endif %}
        </section>
        {% endif %}

        <section class="sekcia">
          <div class="sekcia-head">
            <h3>Gal√©ria</h3>

            {# tlaƒçidlo "Nahra≈•" uk√°≈æ len vlastn√≠kovi; NEskr√Ωvaj ho, iba disable pri limite #}
            {% if is_owner %}
              {% set max_foto = 10 %}
              {% set pocet = pouzivatel.galeria|length %}
              {% set zostava = (max_foto - pocet) if pocet < max_foto else 0 %}

              <form method="POST"
                    action="{{ url_for('profil.nahraj_fotku') }}"
                    enctype="multipart/form-data"
                    id="upload-form-gal">
                <input type="file"
                      id="upload-foto-gal"
                      name="fotos"
                      accept="image/*"
                      multiple
                      hidden
                      {% if zostava == 0 %}disabled{% endif %}
                      onchange="this.form.submit()">
                <label for="upload-foto-gal"
                      class="btn primary sm {% if zostava == 0 %}disabled{% endif %}"
                      {% if zostava == 0 %}title="Limit 10 fotiek je naplnen√Ω"{% else %}title="Nahra≈• fotky (m√¥≈æe≈° oznaƒçi≈• viac)"{% endif %}>
                  ‚ûï Nahra≈•
                </label>
                <small class="gal-limit">
                  {% if zostava > 0 %} zost√°va {{ zostava }} {% else %} limit 10/10 {% endif %}
                </small>
              </form>
            {% endif %}
          </div>

          {% if pouzivatel.galeria and pouzivatel.galeria|length > 0 %}
          <div class="galeria-wrapper">
            {% for foto in pouzivatel.galeria %}
              <div class="foto-blok">
                <img src="{{ url_for('static', filename='galeria_pouzivatel/' ~ foto.nazov_suboru) }}"
                    alt="Foto" class="galeria-foto">

                {% if is_owner %}
                <form method="POST"
                      action="{{ url_for('profil.zmaz_fotku', id=foto.id) }}"
                      class="delete-form"
                      onsubmit="return confirm('Naozaj chce≈° zmaza≈• t√∫to fotku?');">
                  <button type="submit" class="delete-btn" title="Zmaza≈•">‚úñ</button>
                </form>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% else %}
            <p class="sekcia-empty">Zatiaƒæ bez fotiek.</p>
          {% endif %}
        </section>


          {% if is_owner %}
          <form action="{{ url_for('profil.pridaj_video') }}" method="POST" class="profil-videoform">
            <input type="text" name="youtube_url" placeholder="https://www.youtube.com/watch?v=..." required>
            <input type="text" name="popis" placeholder="Kr√°tky popis (voliteƒæn√©)">
            <button type="submit" class="btn primary">‚ûï Prida≈• video</button>
          </form>
          {% endif %}

          {% if youtube_videa and youtube_videa|length > 0 %}
          <div class="profil-video-grid">
            {% for video in youtube_videa %}
              <div class="profil-youtube-video">
                <iframe src="https://www.youtube.com/embed/{{ video.youtube_url | youtube_id }}"
                        title="YouTube video" frameborder="0" allowfullscreen></iframe>
                {% if video.popis %}<p class="video-popis">{{ video.popis }}</p>{% endif %}
                {% if is_owner %}
                <form action="{{ url_for('profil.zmaz_video', id=video.id) }}" method="POST" class="delete-form">
                  <button type="submit" class="delete-btn" title="Zmaza≈• video" onclick="return confirm('Naozaj chce≈° zmaza≈• video?')">‚úñ</button>
                </form>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% else %}
            <p class="sekcia-empty">Zatiaƒæ bez vide√≠.</p>
          {% endif %}
        </section>
      </div>
    </div>
  </div>
</section>

<!-- Prep√≠nanie edit√°cie + avatar fallback -->
<script>
  (function(){
    var root = document.getElementById('profilLeft');
    if (!root) return;

    var btnEdit = document.getElementById('editButton');
    var btnCancel = document.getElementById('cancelEdit');
    var form = document.getElementById('editForm');
    var view = document.getElementById('udaje-zobraz');

    if (form) form.style.display = 'none';

    if (btnEdit) {
      btnEdit.addEventListener('click', function(e){
        e.preventDefault();
        if (form && view) { form.style.display = 'block'; view.style.display = 'none'; }
      });
    }
    if (btnCancel) {
      btnCancel.addEventListener('click', function(e){
        e.preventDefault();
        if (form && view) { form.style.display = 'none'; view.style.display = 'block'; }
      });
    }
  })();

  // Avatar fallback
  document.addEventListener('error', function(e){
    var img = e.target;
    if (!(img instanceof HTMLImageElement) || !img.classList.contains('avatar')) return;
    img.classList.remove('avatar');
    var fb = img.getAttribute('data-fallback') || '{{ url_for("static", filename="profilovky/default.png") }}';
    img.src = fb;
  }, true);
</script>
{% endblock %}
