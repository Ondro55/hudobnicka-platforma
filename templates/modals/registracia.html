<!-- templates/modals/registracia.html -->
<div id="user-form-panel"
     class="modal-root"
     hidden
     role="dialog"
     aria-modal="true"
     aria-labelledby="register-title">
  <div class="modal-card">
    <button type="button" class="modal-close" data-modal-close aria-label="Zavrie≈•">√ó</button>

    <h2 id="register-title">Registr√°cia</h2>

    {% set typ_val = request.form.get('typ_subjektu', 'fyzicka') %}
    {% set rola_val = request.form.get('rola', '') %}
    {% set podrola_val = request.form.get('podrola', '') %}

    <form method="POST" action="{{ url_for('uzivatel.registracia') }}">
      <!-- Typ √∫ƒçtu -->
      <fieldset style="margin:0 0 .75rem 0;border:0;padding:0;">
        <legend style="font-weight:700;margin-bottom:.5rem;">Typ √∫ƒçtu</legend>
        <div class="account-type">
          <input type="radio" id="acc-fyz" name="typ_subjektu" value="fyzicka" {% if typ_val != 'ico' %}checked{% endif %}>
          <label for="acc-fyz">Fyzick√° osoba</label>

          <input type="radio" id="acc-ico" name="typ_subjektu" value="ico" {% if typ_val == 'ico' %}checked{% endif %}>
          <label for="acc-ico">Organiz√°cia (IƒåO)</label>
        </div>
      </fieldset>

      <!-- ‚ö™ Fyzick√° osoba -->
      <div id="blok-fyzicka" style="display: {{ 'none' if typ_val=='ico' else 'block' }};">
        <div class="form-row">
          <label for="prezyvka">Prez√Ωvka *</label>
          <input type="text" id="prezyvka" name="prezyvka" class="input-line"
                 value="{{ request.form.get('prezyvka','') }}">
        </div>

        <div class="form-row">
          <label for="meno">Meno</label>
          <input type="text" id="meno" name="meno" class="input-line"
                 value="{{ request.form.get('meno','') }}">
        </div>

        <div class="form-row">
          <label for="priezvisko">Priezvisko</label>
          <input type="text" id="priezvisko" name="priezvisko" class="input-line"
                 value="{{ request.form.get('priezvisko','') }}">
        </div>

        <!-- Zameranie -->
        <div class="form-row">
          <label for="rola">Zameranie *</label>
          <select id="rola" name="rola" class="select" required>
            <option value="">‚Äî vyber ‚Äî</option>
            <option value="hudobnik"  {{ 'selected' if rola_val=='hudobnik'  else '' }}>Hudobn√≠k</option>
            <option value="tanecnik"  {{ 'selected' if rola_val=='tanecnik'  else '' }}>Taneƒçn√≠k</option>
            <option value="moderator" {{ 'selected' if rola_val=='moderator' else '' }}>Moder√°tor akci√≠</option>
            <option value="fotograf"  {{ 'selected' if rola_val=='fotograf'  else '' }}>Fotograf</option>
            <option value="videograf" {{ 'selected' if rola_val=='videograf' else '' }}>Videograf</option>
            <option value="zvukar"    {{ 'selected' if rola_val=='zvukar'    else '' }}>Zvuk√°r</option>
            <option value="osvetlovac"{{ 'selected' if rola_val=='osvetlovac' else '' }}>Osvetƒæovaƒç</option>
            <option value="technik_podia" {{ 'selected' if rola_val=='technik_podia' else '' }}>Technik p√≥dia / Roadie</option>
            <option value="producent" {{ 'selected' if rola_val=='producent' else '' }}>Producent / Beatmaker</option>
            <option value="skladatel" {{ 'selected' if rola_val=='skladatel' else '' }}>Skladateƒæ / Aran≈æ√©r</option>
            <option value="ucitel_hudby" {{ 'selected' if rola_val=='ucitel_hudby' else '' }}>Uƒçiteƒæ hudby</option>
            <option value="ine"       {{ 'selected' if rola_val=='ine'       else '' }}>In√©</option>
          </select>
          <div class="form-help">Vyber, ƒçomu sa prim√°rne venuje≈°.</div>
        </div>

        <!-- Hudobn√≠k ‚Äî oblas≈• + ≈°pecifik√°cia -->
        <div id="wrap-sub-hudobnik" style="display:none;">
          <div class="form-row">
            <label for="hud_oblast">Hudobn√≠k ‚Äî oblas≈• *</label>
            <select id="hud_oblast" name="hud_oblast" class="select">
              <option value="">‚Äî vyber ‚Äî</option>
              <option value="spev"      {{ 'selected' if request.form.get('hud_oblast')=='spev'      else '' }}>Spev</option>
              <option value="klavesy"   {{ 'selected' if request.form.get('hud_oblast')=='klavesy'   else '' }}>Kl√°vesy</option>
              <option value="gitara"    {{ 'selected' if request.form.get('hud_oblast')=='gitara'    else '' }}>Gitara</option>
              <option value="bicie"     {{ 'selected' if request.form.get('hud_oblast')=='bicie'     else '' }}>Bicie / Perkusie</option>
              <option value="slacikove" {{ 'selected' if request.form.get('hud_oblast')=='slacikove' else '' }}>Sl√°ƒçikov√©</option>
              <option value="dychove"   {{ 'selected' if request.form.get('hud_oblast')=='dychove'   else '' }}>Dychov√©</option>
              <option value="dj"        {{ 'selected' if request.form.get('hud_oblast')=='dj'        else '' }}>DJ</option>
              <option value="elektronika" {{ 'selected' if request.form.get('hud_oblast')=='elektronika' else '' }}>Elektronika (live)</option>
              <option value="folklorne" {{ 'selected' if request.form.get('hud_oblast')=='folklorne' else '' }}>Folkl√≥rne</option>
              <option value="ine"       {{ 'selected' if request.form.get('hud_oblast')=='ine'       else '' }}>In√©</option>
            </select>
          </div>

          <div id="hud_spec_container"></div>
        </div>

        <!-- Taneƒçn√≠k ‚Äî kateg√≥rie -->
        <div id="wrap-sub-tanecnik" style="display:none;">
          <div class="form-row">
            <label>Taneƒçn√© zameranie</label>
            <div style="display:grid;gap:.35rem .75rem;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));">
              <label><input type="checkbox" name="tanec_spec_multi" value="moderne" style="margin-right:.5rem;"> Modern√© / Contemporary</label>
              <label><input type="checkbox" name="tanec_spec_multi" value="folklor_subor" style="margin-right:.5rem;"> Folkl√≥rny s√∫bor</label>
              <label><input type="checkbox" name="tanec_spec_multi" value="latino" style="margin-right:.5rem;"> Latino (Salsa/Bachata)</label>
              <label><input type="checkbox" name="tanec_spec_multi" value="street" style="margin-right:.5rem;"> Street / Hip-hop</label>
              <label><input type="checkbox" name="tanec_spec_multi" value="ballroom" style="margin-right:.5rem;"> Ballroom (≈†tandard/Latina)</label>
              <label><input type="checkbox" name="tanec_spec_multi" value="spolocenske" style="margin-right:.5rem;"> Spoloƒçensk√© / Club</label>
              <label><input type="checkbox" name="tanec_spec_multi" value="pedagog" style="margin-right:.5rem;"> Taneƒçn√Ω pedag√≥g</label>
              <label><input type="checkbox" name="tanec_spec_multi" value="ine" style="margin-right:.5rem;"> In√©</label>
            </div>
          </div>
          <div class="form-row stack" id="tanec_ine_wrap" style="display:none;">
            <label for="tanec_ine_text">Upresni ‚Äûin√©‚Äú</label>
            <input type="text" id="tanec_ine_text" name="tanec_ine_text" class="input-line">
          </div>
        </div>

        <!-- Moder√°tor (spresnenie) -->
        <div id="wrap-sub-moderator" style="display:none;">
          <div class="form-row">
            <label for="podrola">Spresnenie</label>
            <select id="podrola" name="podrola" class="select">
              <option value="">‚Äî vyber ‚Äî</option>
              <option value="staresi"                   {{ 'selected' if podrola_val=='staresi' else '' }}>Starej≈°√≠</option>
              <option value="moderator"                 {{ 'selected' if podrola_val=='moderator' else '' }}>Moder√°tor</option>
              <option value="moderator_hudobnych_akcii" {{ 'selected' if podrola_val=='moderator_hudobnych_akcii' else '' }}>Moder√°tor hudobn√Ωch akci√≠</option>
            </select>
          </div>
        </div>

        <!-- Uƒçiteƒæ hudby ‚Äî odbory -->
        <div id="wrap-sub-ucitel" style="display:none;">
          <div class="form-row">
            <label>Uƒç√≠m (vyber aspo≈à jedno)</label>
            <div style="display:grid;gap:.35rem .75rem;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));">
              <label><input type="checkbox" name="ucitel_predmety_multi" value="klavir" style="margin-right:.5rem;"> Klav√≠r</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="gitara" style="margin-right:.5rem;"> Gitara</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="husle" style="margin-right:.5rem;"> Husle</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="flauta" style="margin-right:.5rem;"> Flauta</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="saxofon" style="margin-right:.5rem;"> Saxof√≥n</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="klarinet" style="margin-right:.5rem;"> Klarinet</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="trumpeta" style="margin-right:.5rem;"> Tr√∫bka</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="bicie" style="margin-right:.5rem;"> Bicie</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="spev" style="margin-right:.5rem;"> Spev</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="akordeon" style="margin-right:.5rem;"> Akorde√≥n</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="heligonka" style="margin-right:.5rem;"> Helig√≥nka</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="teoria" style="margin-right:.5rem;"> Hudobn√° te√≥ria</label>
              <label><input type="checkbox" name="ucitel_predmety_multi" value="ine" style="margin-right:.5rem;"> In√©</label>
            </div>
          </div>
          <div class="form-row stack" id="ucitel_ine_wrap" style="display:none;">
            <label for="ucitel_ine_text">Upresni ‚Äûin√©‚Äú</label>
            <input type="text" id="ucitel_ine_text" name="ucitel_ine_text" class="input-line">
          </div>
        </div>

        <!-- ‚ÄûIn√©‚Äú zameranie -->
        <div id="wrap-rola-ine" style="display:none;">
          <div class="form-row stack">
            <label for="rola_ina">Zameranie ‚Äì in√©</label>
            <input type="text" id="rola_ina" name="rola_ina" class="input-line"
                   placeholder="napr. fotograf-koncerty, dramaturg‚Ä¶" value="{{ request.form.get('rola_ina','') }}">
            <div class="form-help">Zbierame n√°vrhy na nov√© kateg√≥rie.</div>
          </div>
        </div>
      </div> <!-- /#blok-fyzicka -->

      <!-- üü° Organiz√°cia (IƒåO) -->
      <div id="blok-ico" style="display: {{ 'block' if typ_val=='ico' else 'none' }};">
        <div class="form-row">
          <label for="ico">IƒåO *</label>
          <div style="display:flex;gap:.5rem;align-items:center;flex:1;">
            <input type="text" id="ico" name="ico" class="input-line"
                   inputmode="numeric" pattern="[0-9]{6,10}" title="IƒåO: 6‚Äì10 ƒç√≠slic"
                   value="{{ request.form.get('ico','') }}" required
                   aria-describedby="ico-help">
            <button type="button" id="ico-lookup-btn" class="btn">Naƒç√≠ta≈• √∫daje</button>
          </div>
        </div>
        <div class="form-row stack">
          <label class="sr-only" for="ico"></label>
          <div class="form-help" id="ico-help">Zadaj IƒåO (6‚Äì10 ƒç√≠slic) a klikni ‚ÄûNaƒç√≠ta≈• √∫daje‚Äú. Polia ni≈æ≈°ie sa doplnia automaticky.</div>
        </div>

        <div class="form-row">
          <label for="organizacia_nazov">N√°zov *</label>
          <input type="text" id="organizacia_nazov" name="organizacia_nazov" class="input-line"
                 value="{{ request.form.get('organizacia_nazov','') }}" required>
        </div>

        <div class="form-row">
          <label for="dic">DIƒå</label>
          <input type="text" id="dic" name="dic" class="input-line" value="{{ request.form.get('dic','') }}">
        </div>

        <div class="form-row">
          <label for="ic_dph">Iƒå DPH</label>
          <input type="text" id="ic_dph" name="ic_dph" class="input-line" value="{{ request.form.get('ic_dph','') }}">
        </div>

        <div class="form-row">
          <label for="sidlo_ulica">S√≠dlo (ulica)</label>
          <input type="text" id="sidlo_ulica" name="sidlo_ulica" class="input-line" value="{{ request.form.get('sidlo_ulica','') }}">
        </div>

        <div class="form-row cols-2">
          <label for="sidlo_psc">PSƒå / Mesto</label>
          <input type="text" id="sidlo_psc" name="sidlo_psc" class="input-line" value="{{ request.form.get('sidlo_psc','') }}">
          <input type="text" id="sidlo_mesto" name="sidlo_mesto" class="input-line" value="{{ request.form.get('sidlo_mesto','') }}">
        </div>

        <div class="form-row">
          <label for="org_zaradenie">Zaradenie *</label>
          <select id="org_zaradenie" name="org_zaradenie" class="select" required>
            <option value="">‚Äî vyber ‚Äî</option>
            <option value="agentura"          {{ 'selected' if request.form.get('org_zaradenie')=='agentura' else '' }}>Organiz√°tor / Agent√∫ra</option>
            <option value="prenajom_techniky" {{ 'selected' if request.form.get('org_zaradenie')=='prenajom_techniky' else '' }}>Pren√°jom techniky</option>
            <option value="prenajom_saly"     {{ 'selected' if request.form.get('org_zaradenie')=='prenajom_saly' else '' }}>Pren√°jom s√°ly / klubu</option>
            <option value="studio"            {{ 'selected' if request.form.get('org_zaradenie')=='studio' else '' }}>Produkƒçn√© ≈°t√∫dio</option>
            <option value="servis"            {{ 'selected' if request.form.get('org_zaradenie')=='servis' else '' }}>Servis (opravy / servis techniky)</option>
            <option value="zus_skola"         {{ 'selected' if request.form.get('org_zaradenie')=='zus_skola' else '' }}>ZU≈† / ≈†kola</option>
            <option value="ine"               {{ 'selected' if request.form.get('org_zaradenie')=='ine' else '' }}>In√©</option>
          </select>
        </div>
        <div class="form-row stack" id="org_zaradenie_ine_wrap" style="display:none;">
          <label for="org_zaradenie_ine">Zaradenie ‚Äì in√©</label>
          <input type="text" id="org_zaradenie_ine" name="org_zaradenie_ine" class="input-line"
                 value="{{ request.form.get('org_zaradenie_ine','') }}">
        </div>
      </div>

      <!-- Spoloƒçn√© polia -->
      <div class="form-row">
        <label for="email">E-mail *</label>
        <input type="email" id="email" name="email" class="input-line"
               autocomplete="email" value="{{ request.form.get('email','') }}" required>
      </div>

      <!-- Heslo -->
      <div class="form-row">
        <label for="heslo">Heslo *</label>
        <div class="pw-wrap">
          <input type="password" id="heslo" name="heslo" class="input-line"
                 autocomplete="new-password"
                 minlength="8"
                 pattern="(?=.*[A-Za-z])(?=.*\d).{8,}"
                 title="Min. 8 znakov, aspo≈à 1 p√≠smeno a 1 ƒç√≠slo"
                 aria-describedby="heslo-hint"
                 required>
          <button type="button" class="pw-toggle" data-toggle-password="#heslo" aria-label="Zobrazi≈•/Skry≈• heslo">üëÅÔ∏è</button>
        </div>
        <div class="form-help" id="heslo-hint">Min. 8 znakov a aspo≈à 1 p√≠smeno + 1 ƒç√≠slo.</div>
      </div>

      <!-- Zopakuj heslo -->
      <div class="form-row">
        <label for="heslo2">Zopakuj heslo *</label>
        <div class="pw-wrap">
          <input type="password" id="heslo2" name="heslo2" class="input-line" aria-describedby="heslo2-hint" required>
          <button type="button" class="pw-toggle" data-toggle-password="#heslo2" aria-label="Zobrazi≈•/Skry≈• heslo">üëÅÔ∏è</button>
        </div>
        <div class="form-help" id="heslo2-hint">Zadaj to ist√© heslo e≈°te raz.</div>
      </div>

      <!-- Obec / p√¥sobisko -->
      <div class="form-row">
        <label for="obec">Obec / p√¥sobisko</label>
        <select id="obec" name="obec" class="select">
          <option value="">‚Äî vyber ‚Äî</option>
          {% for m in (mesta_all or []) %}
            <option value="{{ m.nazov }}" {% if request.form.get('obec') == m.nazov %}selected{% endif %}>
              {{ m.nazov }}{% if m.okres %}, {{ m.okres }}{% endif %}{% if m.kraj %}, {{ m.kraj }}{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <button type="submit" class="btn primary" style="margin-top:1rem;">Registrova≈•</button>
    </form>
  </div>
</div>

<script>
(function(){
  const root = document.getElementById('user-form-panel');
  if (!root) return;

  // ===== HUDOBN√çK ≈°pecifik√°cie =====
  const HUD_SPEC = {
    spev: { type:'checkboxes', label:'≈†pecifik√°cia spevu', options:[ ['solo','S√≥lo'], ['vokal','Vok√°l'], ['zbor','Zbor'] ] },
    klavesy: { type:'select', label:'≈†pecifik√°cia kl√°vesov', options:[ ['klavir','Klav√≠r'], ['keyboard','Keyboard'], ['synth','Synthesizer'], ['organ','Organ / Hammond'], ['ine','In√©'] ] },
    gitara: { type:'select', label:'≈†pecifik√°cia gitary', options:[ ['elektricka','Elektrick√°'], ['akusticka','Akustick√°'], ['klasicka','Klasick√°'], ['basgitara','Basgitara'], ['ine','In√©'] ] },
    bicie: { type:'select', label:'≈†pecifik√°cia bic√≠ch/perkusi√≠', options:[ ['bicie_suprava','Bicie s√∫prava'], ['perkusie','Perkusie'], ['cajon','Cajon'], ['ine','In√©'] ] },
    slacikove: { type:'select', label:'≈†pecifik√°cia sl√°ƒçikov√Ωch', options:[ ['husle','Husle'], ['viola','Viola'], ['violoncello','Violonƒçelo'], ['kontrabas','Kontrabas'], ['ine','In√©'] ] },
    dychove: { type:'select', label:'≈†pecifik√°cia dychov√Ωch', options:[ ['saxofon','Saxof√≥n'], ['klarinet','Klarinet'], ['priecna_flauta','Prieƒçna flauta'], ['trumpeta','Trumpeta'], ['pozoun','Pozoun'], ['lesny_rog','Lesn√Ω roh'], ['tuba','Tuba'], ['ine','In√©'] ] },
    dj: { type:'checkboxes', label:'DJ ‚Äì ≈°t√Ωly', options:[ ['svadobny','Svadobn√Ω'], ['oldies','Oldies'], ['80s_90s','80s/90s'], ['komercne','Komerƒçn√©'], ['house','House'], ['techno','Techno'] ] },
    elektronika: { type:'select', label:'Elektronika (live)', options:[ ['sampler','Sampler'], ['drum_machine','Drum machine'], ['live_perf','Live performance'], ['ine','In√©'] ] },
    folklorne: { type:'select', label:'Folkl√≥rne', options:[ ['cimbal','Cimbal'], ['akordeon','Akorde√≥n'], ['heligonka','Helig√≥nka'], ['gajdy','Gajdy'], ['fujara','Fujara'], ['ine','In√©'] ] },
    ine: { type:'input', label:'Upresni ‚Äûin√©‚Äú' }
  };

  // ===== cache elementov =====
  const form     = root.querySelector('form[action="{{ url_for("uzivatel.registracia") }}"]');
  const blokF    = root.querySelector('#blok-fyzicka');
  const blokI    = root.querySelector('#blok-ico');
  const radios   = root.querySelectorAll('input[name="typ_subjektu"]');
  const prezyvka = root.querySelector('#prezyvka');
  const orgNazov = root.querySelector('#organizacia_nazov');
  const ico      = root.querySelector('#ico');
  const rolaSel  = root.querySelector('#rola');

  const wrapHud  = root.querySelector('#wrap-sub-hudobnik');
  const hudObl   = root.querySelector('#hud_oblast');
  const hudSpecC = root.querySelector('#hud_spec_container');
  const wrapMod  = root.querySelector('#wrap-sub-moderator');
  const wrapIne  = root.querySelector('#wrap-rola-ine');
  const wrapTan  = root.querySelector('#wrap-sub-tanecnik');
  const wrapUci  = root.querySelector('#wrap-sub-ucitel');

  // ===== helpers =====
  function setDisabled(container, disabled){
    if (!container) return;
    container.querySelectorAll('input, select, textarea, button').forEach(el=>{
      if (disabled) {
        if (el.required) el.dataset.wasRequired = '1';
        el.required = false;
        el.disabled = true;
      } else {
        el.disabled = false;
        if (el.dataset.wasRequired === '1') { el.required = true; delete el.dataset.wasRequired; }
      }
    });
  }

  function syncType(){
    const val = root.querySelector('input[name="typ_subjektu"]:checked')?.value || 'fyzicka';
    const isICO = (val === 'ico');

    if (blokF) blokF.style.display = isICO ? 'none'  : 'block';
    if (blokI) blokI.style.display = isICO ? 'block' : 'none';

    if (prezyvka) prezyvka.required = !isICO;
    if (orgNazov) orgNazov.required =  isICO;
    if (ico)      ico.required      =  isICO;
    if (rolaSel)  rolaSel.required  = !isICO;

    setDisabled(blokF, isICO);
    setDisabled(blokI, !isICO);
  }

  function syncRola() {
    const r = rolaSel?.value || '';
    wrapHud.style.display = (r === 'hudobnik') ? 'block' : 'none';
    wrapMod.style.display = (r === 'moderator') ? 'block' : 'none';
    wrapIne.style.display = (r === 'ine') ? 'block' : 'none';
    wrapTan.style.display = (r === 'tanecnik') ? 'block' : 'none';
    wrapUci.style.display = (r === 'ucitel_hudby') ? 'block' : 'none';
  }

  function renderHudSpec() {
    hudSpecC.innerHTML = '';
    const key = hudObl?.value || '';
    if (!key) return;
    const cfg = HUD_SPEC[key];
    if (!cfg) return;

    const row = document.createElement('div');
    row.className = 'form-row';
    const lab = document.createElement('label');
    lab.textContent = cfg.label || '≈†pecifik√°cia';
    row.appendChild(lab);

    let fieldWrap = document.createElement('div');

    if (cfg.type === 'select') {
      const sel = document.createElement('select');
      sel.name = 'hud_spec';
      sel.id = 'hud_spec';
      sel.className = 'select';
      sel.innerHTML = `<option value="">‚Äî vyber ‚Äî</option>` + (cfg.options||[]).map(([v,t])=>`<option value="${v}">${t}</option>`).join('');
      fieldWrap.appendChild(sel);

      sel.addEventListener('change', () => {
        let extra = row.querySelector('#hud_spec_ine_wrap');
        if (sel.value === 'ine') {
          if (!extra) {
            extra = document.createElement('div');
            extra.id = 'hud_spec_ine_wrap';
            extra.className = 'form-row stack';
            extra.innerHTML = `
              <label for="hud_spec_ine">Upresni ‚Äûin√©‚Äú</label>
              <input type="text" id="hud_spec_ine" name="hud_spec_ine" class="input-line">
            `;
            hudSpecC.appendChild(extra);
          }
        } else if (extra) {
          extra.remove();
        }
      });

    } else if (cfg.type === 'checkboxes') {
      fieldWrap.style.display = 'grid';
      fieldWrap.style.gap = '.35rem .75rem';
      fieldWrap.style.gridTemplateColumns = 'repeat(auto-fit,minmax(160px,1fr))';
      (cfg.options||[]).forEach(([v,t])=>{
        const lbl = document.createElement('label');
        lbl.style.display = 'inline-flex';
        lbl.style.alignItems = 'center';
        lbl.innerHTML = `<input type="checkbox" name="hud_spec_multi" value="${v}" style="margin-right:.5rem;"> ${t}`;
        fieldWrap.appendChild(lbl);
      });

    } else if (cfg.type === 'input') {
      fieldWrap.innerHTML = `<input type="text" id="hud_spec_free" name="hud_spec_free" class="input-line" placeholder="Upresni, pros√≠m‚Ä¶">`;
    }

    row.appendChild(fieldWrap);
    hudSpecC.appendChild(row);
  }

  function bindInes() {
    const tanecChecks = root.querySelectorAll('input[name="tanec_spec_multi"]');
    const tanecWrap = root.querySelector('#tanec_ine_wrap');
    const ucitelChecks = root.querySelectorAll('input[name="ucitel_predmety_multi"]');
    const ucitelWrap = root.querySelector('#ucitel_ine_wrap');

    function toggleWrap(checks, wrap) {
      if (!wrap) return;
      const anyIne = [...checks].some(c => c.checked && c.value === 'ine');
      wrap.style.display = anyIne ? 'block' : 'none';
    }
    tanecChecks.forEach(c => c.addEventListener('change', () => toggleWrap(tanecChecks, tanecWrap)));
    ucitelChecks.forEach(c => c.addEventListener('change', () => toggleWrap(ucitelChecks, ucitelWrap)));
    toggleWrap(tanecChecks, tanecWrap);
    toggleWrap(ucitelChecks, ucitelWrap);
  }

  // ===== IƒåO lookup =====
  const orgZar = root.querySelector('#org_zaradenie');
  const orgZarWrap = root.querySelector('#org_zaradenie_ine_wrap');
  function syncOrgZar(){ if (orgZar && orgZarWrap) orgZarWrap.style.display = (orgZar.value === 'ine') ? 'block' : 'none'; }

  const icoInput = ico;
  const icoBtn   = root.querySelector('#ico-lookup-btn');

  const fillICO = (d={})=>{
    const set = (id, v)=>{ const el=root.querySelector('#'+id); if(el && v!=null) el.value = v; };
    set('organizacia_nazov', d.nazov);
    set('dic', d.dic);
    set('ic_dph', d.ic_dph);
    set('sidlo_ulica', d.ulica);
    set('sidlo_psc', d.psc);
    set('sidlo_mesto', d.mesto);
  };

  async function doLookup(){
    const val = (icoInput?.value||'').trim();
    if(!/^\d{6,10}$/.test(val)){ alert('Zadaj platn√© IƒåO (6‚Äì10 ƒç√≠slic).'); icoInput?.focus(); return; }
    try{
      if (icoBtn) { icoBtn.disabled = true; icoBtn.textContent = 'Naƒç√≠tavam‚Ä¶'; }
      const r = await fetch(`{{ url_for('uzivatel.ico_lookup') }}?ico=${val}`);
      if(!r.ok){ throw new Error('Pre zadan√© IƒåO sa √∫daje nena≈°li.'); }
      const data = await r.json();
      fillICO(data);
      orgZar?.focus({preventScroll:true});
    }catch(err){
      alert(err.message || 'Nepodarilo sa naƒç√≠ta≈• √∫daje.');
    }finally{
      if (icoBtn) { icoBtn.disabled = false; icoBtn.textContent = 'Naƒç√≠ta≈• √∫daje'; }
    }
  }

  // ===== submit guard =====
  function onSubmit(e){
    // hesl√°
    const h1 = root.querySelector('#heslo');
    const h2 = root.querySelector('#heslo2');
    if (h1 && h2 && h1.value !== h2.value) {
      e.preventDefault(); alert('Hesl√° sa nezhoduj√∫.'); h2.focus(); return;
    }

    const typ = root.querySelector('input[name="typ_subjektu"]:checked')?.value || 'fyzicka';

    if (typ === 'fyzicka'){
      const r = rolaSel?.value || '';
      if (!r){ e.preventDefault(); alert('Vyber zameranie.'); rolaSel?.focus(); return; }
      if (r === 'hudobnik'){
        if (!hudObl?.value) { e.preventDefault(); alert('Vyber oblas≈• (Spev, Kl√°vesy, ‚Ä¶)'); hudObl?.focus(); return; }
        const hudSpecSel = root.querySelector('#hud_spec');
        const anyCB = [...root.querySelectorAll('input[name="hud_spec_multi"]:checked')].length > 0;
        const free = root.querySelector('#hud_spec_free');
        if (hudSpecSel && !hudSpecSel.value) { e.preventDefault(); alert('Vyber ≈°pecifik√°ciu.'); hudSpecSel.focus(); return; }
        if (free && !free.value.trim()) { e.preventDefault(); alert('Upresni ‚Äûin√©‚Äú.'); free.focus(); return; }
        if (!hudSpecSel && !free && !anyCB) { e.preventDefault(); alert('Zvoƒæ ≈°pecifik√°ciu.'); return; }
      }
      if (r === 'tanecnik'){
        const any = [...root.querySelectorAll('input[name="tanec_spec_multi"]:checked')].length > 0;
        if (!any) { e.preventDefault(); alert('Vyber aspo≈à jednu taneƒçn√∫ kateg√≥riu.'); return; }
        const ineOn = [...root.querySelectorAll('input[name="tanec_spec_multi"]:checked')].some(c => c.value === 'ine');
        const ineText = root.querySelector('#tanec_ine_text');
        if (ineOn && (!ineText || !ineText.value.trim())) { e.preventDefault(); alert('Upresni ‚Äûin√©‚Äú pri Taneƒçn√≠kovi.'); ineText?.focus(); return; }
      }
      if (r === 'ucitel_hudby'){
        const any = [...root.querySelectorAll('input[name="ucitel_predmety_multi"]:checked')].length > 0;
        if (!any) { e.preventDefault(); alert('Vyber aspo≈à jeden vyuƒçovan√Ω odbor.'); return; }
        const ineOn = [...root.querySelectorAll('input[name="ucitel_predmety_multi"]:checked')].some(c => c.value === 'ine');
        const ineText = root.querySelector('#ucitel_ine_text');
        if (ineOn && (!ineText || !ineText.value.trim())) { e.preventDefault(); alert('Upresni ‚Äûin√©‚Äú pri Uƒçiteƒæovi hudby.'); ineText?.focus(); return; }
      }
    } else {
      // IƒåO re≈æim
      const val = (icoInput?.value||'').trim();
      const nazov = (orgNazov?.value||'').trim();
      const zar = (orgZar?.value||'').trim();
      if (!/^\d{6,10}$/.test(val)) { e.preventDefault(); alert('Zadaj platn√© IƒåO (6‚Äì10 ƒç√≠slic).'); icoInput?.focus(); return; }
      if (!nazov) { e.preventDefault(); alert('Ch√Ωba N√°zov organiz√°cie (sk√∫s ‚ÄûNaƒç√≠ta≈• √∫daje‚Äú).'); orgNazov?.focus(); return; }
      if (!zar) { e.preventDefault(); alert('Vyber Zaradenie organiz√°cie.'); orgZar?.focus(); return; }
    }

    // disable submit
    const btn = form?.querySelector('button[type="submit"]');
    if (btn){ btn.disabled = true; btn.textContent = 'Odosielam‚Ä¶'; }
  }

  // ===== init =====
  radios.forEach(r => r.addEventListener('change', syncType));
  rolaSel?.addEventListener('change', syncRola);
  hudObl?.addEventListener('change', renderHudSpec);
  orgZar?.addEventListener('change', syncOrgZar);
  icoBtn?.addEventListener('click', doLookup);
  icoInput?.addEventListener('blur', ()=> { if(/^\d{6,10}$/.test(icoInput.value)) doLookup(); });

  form?.addEventListener('submit', onSubmit);

  // prv√© naƒç√≠tanie
  syncType(); syncRola(); renderHudSpec(); bindInes(); syncOrgZar();
})();
</script>
