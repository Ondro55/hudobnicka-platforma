<!-- templates/modals/registracia.html -->
<div id="user-form-panel"
     class="modal-root"
     hidden
     role="dialog"
     aria-modal="true"
     aria-labelledby="register-title">
  <div class="modal-card">
    <button type="button" class="modal-close" data-modal-close aria-label="Zavrie≈•">√ó</button>

    <h2 id="register-title">Registr√°cia</h2>

    <div id="flash-box" aria-live="polite">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="flash-messages" style="background:#f0fff0;padding:10px;border-left:4px solid green;">
            {% for message in messages %}
              <p style="margin:0;font-weight:bold;color:green">{{ message }}</p>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>

    {% set typ_val = request.form.get('typ_subjektu', 'fyzicka') %}

    <form method="POST" action="{{ url_for('uzivatel.registracia') }}">
      <!-- Typ √∫ƒçtu ‚Äì guliƒçky -->
      <fieldset style="margin:0 0 .75rem 0;border:0;padding:0;">
        <legend style="font-weight:700;margin-bottom:.25rem;">Typ √∫ƒçtu</legend>
        <label style="margin-right:1rem;">
          <input type="radio" name="typ_subjektu" value="fyzicka"
                 {% if typ_val != 'ico' %}checked{% endif %}> Fyzick√° osoba
        </label>
        <label>
          <input type="radio" name="typ_subjektu" value="ico"
                 {% if typ_val == 'ico' %}checked{% endif %}> Organiz√°cia (IƒåO)
        </label>
      </fieldset>

      <!-- ‚ö™ Fyzick√° osoba -->
      <div id="blok-fyzicka" style="display: {{ 'none' if typ_val=='ico' else 'block' }};">
        <label for="prezyvka">Prez√Ωvka *</label>
        <input type="text" id="prezyvka" name="prezyvka"
               value="{{ request.form.get('prezyvka','') }}">

        <label for="meno">Meno</label>
        <input type="text" id="meno" name="meno"
               value="{{ request.form.get('meno','') }}">

        <label for="priezvisko">Priezvisko</label>
        <input type="text" id="priezvisko" name="priezvisko"
               value="{{ request.form.get('priezvisko','') }}">

        <label for="instrument">Hudobn√Ω n√°stroj</label>
        <select id="instrument" name="instrument">
          <option value="">-- Vyber --</option>
          {% for val, txt in [('klavesy','Kl√°vesy'), ('gitara','Gitara'), ('bicie','Bicie'), ('dychove','Dychov√©'), ('slacikove','Sl√°ƒçikov√©'), ('ine','In√©')] %}
            <option value="{{val}}" {% if request.form.get('instrument') == val %}selected{% endif %}>{{txt}}</option>
          {% endfor %}
        </select>

        <div id="instrument-ine" style="{% if request.form.get('instrument') == 'ine' %}display:block;{% else %}display:none;{% endif %}">
          <label for="doplnkovy_nastroj">Dopl≈à hudobn√Ω n√°stroj</label>
          <input type="text" id="doplnkovy_nastroj" name="doplnkovy_nastroj"
                 value="{{ request.form.get('doplnkovy_nastroj','') }}">
        </div>
      </div>

      <!-- üü° Organiz√°cia (IƒåO) -->
      <div id="blok-ico" style="display: {{ 'block' if typ_val=='ico' else 'none' }};">
        <label for="organizacia_nazov">N√°zov organiz√°cie *</label>
        <input type="text" id="organizacia_nazov" name="organizacia_nazov"
               value="{{ request.form.get('organizacia_nazov','') }}">

        <label for="ico">IƒåO *</label>
        <input type="text" id="ico" name="ico"
               inputmode="numeric" pattern="[0-9]{6,10}" title="IƒåO: 6‚Äì10 ƒç√≠slic"
               value="{{ request.form.get('ico','') }}">
      </div>

      <!-- Spoloƒçn√© polia -->
      <label for="email">Email *</label>
      <input type="email" id="email" name="email" autocomplete="email"
             value="{{ request.form.get('email','') }}" required>

      <label for="heslo">Heslo *</label>
      <input type="password" id="heslo" name="heslo" autocomplete="new-password" minlength="8"
             title="Heslo mus√≠ ma≈• aspo≈à 8 znakov" required>

      <label for="heslo2">Zopakuj heslo *</label>
      <input type="password" id="heslo2" name="heslo2" required>

      <label>Obec / p√¥sobisko</label>
      <div class="miesto-grid" style="display:grid;grid-template-columns:1fr;gap:.75rem;">
        <div>
          <label for="obec" class="label-spacer" style="visibility:hidden;display:block;height:1.2rem;margin:0 0 .25rem;">
            Miesto (v√Ωber z miest)
          </label>
          <select id="obec" name="obec">
            <option value="">‚Äî vyber ‚Äî</option>
            {% for m in (mesta_all or []) %}
              <option value="{{ m.nazov }}"
                      {% if request.form.get('obec') == m.nazov %}selected{% endif %}>
                {{ m.nazov }}{% if m.okres %}, {{ m.okres }}{% endif %}{% if m.kraj %}, {{ m.kraj }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <button type="submit" class="btn primary" style="margin-top:1rem;">Registrova≈•</button>
    </form>
  </div>
</div>

<script>
  (function(){
    const root = document.getElementById('user-form-panel');
    if (!root) return;

    // prep√≠nanie typov √∫ƒçtu (r√°di√°)
    const radios = root.querySelectorAll('input[name="typ_subjektu"]');
    const blokF = root.querySelector('#blok-fyzicka');
    const blokI = root.querySelector('#blok-ico');

    const prezyvka = root.querySelector('#prezyvka');
    const org      = root.querySelector('#organizacia_nazov');
    const ico      = root.querySelector('#ico');

    function syncType(){
      const val = root.querySelector('input[name="typ_subjektu"]:checked')?.value || 'fyzicka';
      const isICO = val === 'ico';
      blokF.style.display = isICO ? 'none'  : 'block';
      blokI.style.display = isICO ? 'block' : 'none';
      if (prezyvka) prezyvka.required = !isICO;
      if (org)      org.required      =  isICO;
      if (ico)      ico.required      =  isICO;

      // fokus na prv√© pole
      setTimeout(() => (isICO ? org : prezyvka)?.focus({preventScroll:true}), 0);
    }
    radios.forEach(r => r.addEventListener('change', syncType));
    syncType();

    // "In√©" n√°stroje ‚Äì len pre fyzick√∫ osobu
    const selInstr      = root.querySelector('#instrument');
    const wrapInstrIne  = root.querySelector('#instrument-ine');
    if (selInstr && wrapInstrIne) {
      selInstr.addEventListener('change', () => {
        wrapInstrIne.style.display = selInstr.value === 'ine' ? 'block' : 'none';
      });
    }

    // valid√°cia: hesl√° sa musia zhodova≈•
    root.addEventListener('submit', (e) => {
      const h1 = root.querySelector('#heslo');
      const h2 = root.querySelector('#heslo2');
      if (h1 && h2 && h1.value !== h2.value) {
        e.preventDefault();
        alert('Hesl√° sa nezhoduj√∫.');
      }
    });
  })();
</script>
