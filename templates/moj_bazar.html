{% extends 'base.html' %}
{% block title %}Pridať inzerát{% endblock %}

{% block content %}
<section class="pridaj-inzerat">
  <h2>📝 Pridaj nový inzerát</h2>
   <div class="form-wrapper">
    <form action="{{ url_for('inzerat.moj_bazar') }}" method="post" enctype="multipart/form-data" style="display: flex; gap: 2rem; align-items: flex-start; width: 100%;">
      
      <!-- ĽAVÁ STRANA -->
      <div class="inzerat-form" style="flex: 1;">
        <select name="typ" required>
          <option value="" disabled selected>Vyber typ</option>
          <option value="Predám">Predám</option>
          <option value="Kúpim">Kúpim</option>
          <option value="Darujem">Darujem</option>
          <option value="Vymením">Vymením</option>
          <option value="Hľadám">Hľadám</option>
        </select>

        <select name="kategoria" required>
          <option value="" disabled selected>Vyber kategóriu</option>
          {% for kategoria in kategorie %}
            <option value="{{ kategoria }}">{{ kategoria }}</option>
          {% endfor %}
        </select>
        
        <label>Popis</label>
        <textarea name="popis" rows="5"></textarea>
        
        <select id="mesto" name="mesto_id" required>
          <option value="">-- Vyber mesto --</option>
          {% for mesto in mesta %}
            <option value="{{ mesto.id }}">{{ mesto.nazov }}</option>
          {% endfor %}
        </select>

        <select name="doprava" required>
          <option value="" disabled selected>Vyber spôsob doručenia</option>
          <option value="Osobne">Osobne</option>
          <option value="Poštou">Poštou</option>
          <option value="Kuriér">Kuriér</option>
        </select>

        <input type="number" step="10" name="cena" placeholder="Cena (€)">
        <button type="submit">💾 Pridať inzerát</button>
      </div>

      <!-- 📷 PRAVÁ STRANA -->
      <div class="foto-panel" style="flex: 1;">
        <h3>📸 Fotky k inzerátu</h3>

        <!-- Skrytý input + štýlové tlačidlo -->
        <input type="file" id="fotky-input" accept="image/*" multiple style="display: none;">
        <label for="fotky-input" class="vlastne-tlacidlo">📁 Vybrať fotky</label>

        <p style="font-size: 0.9rem;">Max. 5 fotiek. Formáty: JPG, PNG.</p>

        <!-- Náhľady a skryté inputy -->
        <div id="nahlady-fotiek" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem;"></div>
        <div id="realne-fotky"></div>
      </div>
    </form>
  </div>
</section>

<hr>

<h2>Moje aktívne inzeráty</h2>

{% if inzeraty %}
  <div class="zoznam-inzeratov">
    {% for inzerat in inzeraty %}
      <div class="inzerat-box">
        <div class="inzerat-header">
            {{ inzerat.typ }} – {{ inzerat.kategoria }}
        </div>
        <p>{{ inzerat.popis }}</p>
        <p>📍 {{ inzerat.mesto.nazov }} | 💶 {{ inzerat.cena }} €</p>
        <small>🕒 Pridané: {{ inzerat.datum.strftime('%d.%m.%Y') }}</small>
        {% if inzerat.fotky %}
          <div class="inzerat-fotky">
            {% for foto in inzerat.fotky %}
              <img src="{{ url_for('static', filename='galeria_inzerat/' ~ foto.nazov_suboru) }}" alt="Náhľad" style="width: 150px; border-radius: 6px; margin: 5px;">
            {% endfor %}
          </div>
        {% endif %}


        <div class="inzerat-akcie">
          <a href="{{ url_for('inzerat.uprav_inzerat', inzerat_id=inzerat.id) }}">✏️ Upraviť</a>
          <a href="{{ url_for('inzerat.zmaz_inzerat', inzerat_id=inzerat.id) }}" onclick="return confirm('Naozaj chceš zmazať tento inzerát?')">🗑️ Zmazať</a>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>Nemáš zatiaľ žiadne inzeráty.</p>
{% endif %}

<script>
  const input = document.getElementById('fotky-input');
  const nahlady = document.getElementById('nahlady-fotiek');
  const realne = document.getElementById('realne-fotky');
  let ulozeneFotky = [];

  input.addEventListener('change', function () {
    const noveFotky = Array.from(this.files);

    // Pridaj nové, ale max 5
    ulozeneFotky = ulozeneFotky.concat(noveFotky).slice(0, 5);

    zobrazNahlady();
    obnovSkryteInputy();
    this.value = '';
  });

  function zobrazNahlady() {
    nahlady.innerHTML = '';
    ulozeneFotky.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        const box = document.createElement('div');
        box.style.position = 'relative';
        box.innerHTML = `
          <img src="${e.target.result}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 6px;">
          <button type="button" onclick="odstranitFotku(${index})" style="position: absolute; top: 2px; right: 2px; background: crimson; color: white; border: none; border-radius: 50%; cursor: pointer;">✖</button>
        `;
        nahlady.appendChild(box);
      };
      reader.readAsDataURL(file);
    });
  }

  function odstranitFotku(index) {
    ulozeneFotky.splice(index, 1);
    zobrazNahlady();
    obnovSkryteInputy();
  }

  function obnovSkryteInputy() {
    realne.innerHTML = '';
    ulozeneFotky.forEach((file) => {
      const input = document.createElement('input');
      input.type = 'file';
      input.name = 'fotky';
      input.multiple = false; // každý input = 1 súbor
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;
      input.style.display = 'none';
      realne.appendChild(input);
    });
  }
</script>
{% endblock %}
