<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Muzikuj{% endblock %}</title>
  <script>
  (function () {
    try {
      var userTheme = {{ (current_user.theme if current_user.is_authenticated else None)|tojson }};
      var m = document.cookie.match(/(?:^|; )mz_prefs=([^;]+)/);
      var cookieTheme = null;
      if (m) { try { cookieTheme = JSON.parse(decodeURIComponent(m[1])).theme; } catch(_) {} }

      var theme = cookieTheme || (userTheme && userTheme !== 'system' ? userTheme : null);

      if (theme && theme !== 'system') {
        document.documentElement.setAttribute('data-theme', theme);
      } else {
        document.documentElement.removeAttribute('data-theme'); // => hnedý default
      }
    } catch (_) {}
  })();
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Open+Sans&display=swap" rel="stylesheet" />

  <!-- 1) Tokens & Base -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tokens.css', v=3) }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">

  <!-- 2) Layout -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout/header.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout/sidebar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout/footer.css') }}">

  <!-- 3) Components -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/button.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/modal.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/sidebar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/alert.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/role-badge.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/header-icons.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/mini-list.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/filterbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/grids.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/card.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/novinky.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/notice.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/formbox.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/utils.css') }}">

  <!-- 4) Forms -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}">

  <!-- 5) Pages -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/home.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/kontakt.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/podujatie.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/reklama.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/registracia.css') }}">

  <!-- 6) Špecifické sekcie -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profil.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/skupina.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/kalendar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/inzerat.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/komunita.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/spravy.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dopyty.css') }}">

</head>

<body data-zobraz="{{ zobraz_formular }}">

<header class="hlavicka-grid">
  <div class="box1"><div class="logo">muziku♪.sk</div></div>

  <div class="box2">
    <div class="box2-wrapper">
      <div class="social-icons">
        <a href="#"><img src="{{ url_for('static', filename='fb.png') }}" alt="Facebook"></a>
        <a href="#"><img src="{{ url_for('static', filename='ig.png') }}" alt="Instagram"></a>
      </div>

      <div class="user-panel">
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('spravy.inbox') }}"
             class="msg-icon {{ 'has-unread' if neprecitane_count and neprecitane_count > 0 else '' }}"
             aria-label="Správy" title="Správy">
            <span class="icon">✉️</span>
            {% if neprecitane_count and neprecitane_count > 0 %}
              <span class="badge">{{ neprecitane_count }}</span>
            {% endif %}
          </a>

          {% set has_unread = (neprecitane_forum_count|default(0)|int) > 0 %}
          <a href="{{ url_for('forum.goto_unread') if has_unread else url_for('komunita.hub', tab='forum') + '#tab-forum' }}"
             class="msg-icon {{ 'has-unread' if has_unread else '' }}"
             aria-label="Fórum" title="Fórum">
            <span class="icon">💬</span>
            {% if has_unread %}
              <span class="badge">{{ neprecitane_forum_count|default(0)|int }}</span>
            {% endif %}
          </a>

          <span class="user-info">
            👋 {{ current_user.prezyvka }}
            {% if current_user.is_admin %}
              <span class="role-badge admin" title="Admin">Admin</span>
            {% elif current_user.is_moderator %}
              <span class="role-badge mod" title="Moderátor">Mod</span>
            {% endif %}
          </span>

          
          {% if current_user.is_admin or current_user.is_moderator %}
            <a href="{{ url_for('moderacia.dashboard' if current_user.is_admin else 'moderacia.queue') }}" class="header-btn">
              🛡️ {{ 'Admin' if current_user.is_admin else 'Moderácia' }}
            </a>
          {% endif %}

          <a href="{{ url_for('uzivatel.profil') }}" class="header-btn">Moje konto</a>
          <a href="{{ url_for('uzivatel.logout') }}" class="header-btn logout-btn">Odhlásiť sa</a>
        {% else %}
          <a href="{{ url_for('uzivatel.login') }}" class="header-btn" data-modal-open="#modal-login">Prihlásiť sa</a>
          <a href="{{ url_for('uzivatel.registracia') }}" class="header-btn" data-modal-open="#user-form-panel">Registrovať sa</a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="box3">
    <button class="hamburger" onclick="toggleMenu()">☰</button>
    <div class="nav-wrapper">
      <nav class="main-nav">
        <a href="{{ url_for('uzivatel.index') }}">DOMOV</a>

        {% if current_user.is_authenticated %}
          <a href="{{ url_for('dopyty.zobraz_dopyty') }}">📬 DOPYTY</a>
          {% if current_user.typ_subjektu != 'ico' %}
            <a href="{{ url_for('skupina.prehlad_skupin') }}">🎸 SKUPINY</a>
            <a href="{{ url_for('inzerat.bazar_verejny') }}">🛒 BAZÁR</a>
            <a href="{{ url_for('komunita.hub') }}">KOMUNITA</a>
          {% endif %}
          <!--<a href="#">e-shop</a>-->
          <a href="#kontakt">KONTAKT</a>
        {% else %}
          <a href="#" class="disabled-link" data-modal-open="#modal-login">📬 DOPYTY</a>
          <a href="#" class="disabled-link" data-modal-open="#modal-login">🎵 SKUPINY</a>
          <a href="#" class="disabled-link" data-modal-open="#modal-login">🛒 BAZÁR</a>
          <a href="#" class="disabled-link" data-modal-open="#modal-login">KOMUNITA</a>
          <!--<a href="#">e-shop</a>-->
          <a href="#kontakt">KONTAKT</a>
        {% endif %}
      </nav>
    </div>
  </div>
</header>

  {# =======================
          HOMEPAGE 
    ======================= #}
  {% if request.endpoint == 'uzivatel.index' %}
    <div class="page-grid">
      <!-- ĽAVÝ fluid stĺpec (sidebar sa lepí k stredu) -->
      <div class="page-left">
        <aside class="button-sidebar">
          {% include 'includes/sidebox.html' %}
        </aside>
      </div>

      <!-- STRED – 1200px shell (tvoj 3-stĺpcový home obsah) -->
      <main class="page-center">
        {% block home_filter %}{% endblock %}
        <div class="home-shell">
          <div class="home-grid">
            <aside class="home-left">
              {% block home_left %}{% endblock %}
            </aside>

            <section class="home-center" id="home-feed">
              {% block home_content %}{% endblock %}
            </section>

            <aside class="home-right">
              {% block home_right %}{% endblock %}
            </aside>
          </div>
        </div>
      </main>

      <!-- PRAVÝ fluid stĺpec (vzduch/symetria) -->
      <div class="page-right" aria-hidden="true"></div>
    </div>
  {% else %}
    <div class="button-container">
      {% if current_user.is_authenticated %}
        <aside class="button-sidebar">
          {% include 'includes/sidebox.html' %}
        </aside>
      {% endif %}
      <main class="{{ 'main-content' if current_user.is_authenticated else 'main-no-sidebar' }}">
        {% block content %}{% endblock %}
      </main>

    </div>
    
  {% endif %}


{% include 'includes/novinky.html' %}
{% include 'partials/flash.html' %}

{% if zobraz_uvitanie %}
  <div id="uvitanie-popup" class="uvitanie-box">
    <h2>🎉 Vitaj v komunite hudobníkov, {{ zobraz_uvitanie }}!</h2>
    <p>Tvoj účet bol úspešne vytvorený.</p>
  </div>
{% endif %}

<!-- MODÁLY -->
{% include 'modals/prihlasenie.html' %}
{% include 'modals/registracia.html' %}
{% include 'includes/cookie_banner.html' %}
{% include "modals/dopyt_form.html" %}
<script src="{{ url_for('static', filename='js/cookies.js') }}" defer></script>


<!-- Extra modal pre správy (unifikované triedy, BEZ inline štýlov) -->
<div id="sprava-modal" class="modal-root" hidden aria-hidden="true" role="dialog" aria-labelledby="sprava-title">
  <div class="modal-backdrop" data-modal-close></div>
  <div class="modal-card">
    <form id="sprava-form" method="POST" action="#">
      <h3 id="sprava-title">Napísať reakciu</h3>
      <input type="hidden" name="dopyt_id">
      <div class="form-fields">
        <label>Komu <input type="email" name="to" placeholder="prijímateľ" required></label>
        <label>Predmet <input type="text" name="subject" required></label>
        <label>Správa <textarea name="message" rows="6" placeholder="Tvoja ponuka, dostupnosť, cena…" required></textarea></label>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn" data-modal-close>Zavrieť</button>
        <button type="submit" class="btn primary">Odoslať</button>
      </div>
    </form>
  </div>
</div>

<section id="kontakt" class="kontakt">
  <h2>Kontaktujte nás</h2>
  <div class="kontakt-boxy">
    <div class="kontakt-box"><h3>Email</h3><p><a href="mailto:info@muzikuj.sk">info@muzikuj.sk</a></p></div>
    <div class="kontakt-box"><h3>Sociálne siete</h3><p><a href="#">Facebook</a> | <a href="#">Instagram</a></p></div>
  </div>
</section>

<div id="imgLightbox" class="img-lightbox" hidden aria-hidden="true" role="dialog">
  <span class="close" aria-label="Zavrieť">×</span>
  <img alt="">
</div>

<footer><p>&copy; 2025 Muzikuj.sk | Všetky práva vyhradené</p>
  <a href="#" onclick="openCookieSettings();return false;">Nastavenia súkromia</a>
</footer>

<!-- Burger menu -->
<script>
  function toggleMenu(){ document.querySelector('.main-nav')?.classList.toggle('active'); }
</script>

<!-- Dedup modálov (ak by sa niekde vložili 2x) -->
<script>
  (function () {
    ['modal-login', 'user-form-panel', 'dopyt-form', 'form-inzerat'].forEach(id => {
      const all = document.querySelectorAll('#' + id);
      if (all.length > 1) {
        all.forEach((el, i) => { if (i < all.length - 1) el.remove(); });
        console.warn('⚠️ Removed duplicate modal:', id, 'had', all.length, 'copies');
      }
    });
  })();
</script>

<!-- Správca modálov + fallback na URL (bez dopisovania štýlov) -->
<script>
  (function () {
    if (window.__PORTAL_MODAL_MGR__) return; window.__PORTAL_MODAL_MGR__ = true;
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    let lastOpener = null;

    function openModal(selOrEl) {
      const isSelector = typeof selOrEl === 'string';
      const m = isSelector ? $(selOrEl) : selOrEl;

      if (!m) {
        const sel = isSelector ? selOrEl : '';
        if (sel === '#modal-login') {
          window.location.href = "{{ url_for('uzivatel.login') }}";
        } else if (sel === '#user-form-panel') {
          window.location.href = "{{ url_for('uzivatel.registracia') }}";
        } else if (sel === '#dopyt-form') {
          window.location.href = "{{ url_for('uzivatel.index') }}#dopyt-form";
        }
        return;
      }

      m.hidden = false;
      m.setAttribute('aria-hidden','false');
      m.classList.add('open');
      document.body.classList.add('modal-open');

      const first = m.querySelector('[autofocus], input, select, textarea, button, [href], [tabindex]:not([tabindex="-1"])');
      if (first) first.focus({preventScroll:true});
    }

    function closeModal(node) {
      const m = node?.closest?.('.modal-root, .modal') || node; if (!m) return;
      if (m.contains(document.activeElement)) document.activeElement.blur();
      m.classList.remove('open');
      m.hidden = true;
      m.setAttribute('aria-hidden','true');

      if (!document.querySelector('.modal-root.open, .modal.open')) {
        document.body.classList.remove('modal-open');
      }
      if (lastOpener && document.body.contains(lastOpener)) lastOpener.focus({preventScroll:true});
    }

    document.addEventListener('click', (e) => {
      const opener = e.target.closest('[data-modal-open]');
      if (opener){
        e.preventDefault();
        lastOpener = opener;
        openModal(opener.getAttribute('data-modal-open'));
        return;
      }
      const closer = e.target.closest('[data-modal-close], .modal-close');
      if (closer){ e.preventDefault(); closeModal(closer); return; }
      if (e.target.classList?.contains('modal-backdrop')) { e.preventDefault(); closeModal(e.target); }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') $$('.modal-root.open, .modal.open').forEach(m => closeModal(m));
    });

    window.openModal = openModal; window.closeModal = closeModal;
  })();
</script>

<!-- Auto-otvorenie dopytu pri príchode s #dopyt-form -->
<script>
  document.addEventListener('DOMContentLoaded', function(){
    if (location.hash === '#dopyt-form' && document.querySelector('#dopyt-form')) {
      if (typeof window.openModal === 'function') window.openModal('#dopyt-form');
    }
  });
</script>

<script>
(function(){
  const lb = document.getElementById('imgLightbox');
  if (!lb) return;

  const imgEl = lb.querySelector('img');

  function open(src, alt){
    imgEl.src = src;
    imgEl.alt = alt || '';
    lb.hidden = false;
    lb.classList.add('open');
    lb.setAttribute('aria-hidden','false');
  }
  function close(){
    lb.classList.remove('open');
    lb.hidden = true;
    lb.setAttribute('aria-hidden','true');
    imgEl.src = '';
  }

  // Delegovaný klik: funguje pre [data-lightbox] aj .feed-card .cover
  document.addEventListener('click', (e) => {
    const trigger = e.target.closest('[data-lightbox], .feed-card .cover');
    if (trigger){
      e.preventDefault();
      const src = trigger.getAttribute && trigger.getAttribute('data-full')
                 ? trigger.getAttribute('data-full')
                 : (trigger.currentSrc || trigger.src);
      const alt = (trigger.getAttribute && trigger.getAttribute('alt')) || '';
      open(src, alt);
      return;
    }
    if (e.target === lb || e.target.closest('.close')) close();
  });

  // ESC zavrie lightbox
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && lb.classList.contains('open')) close();
  });
})();
</script>
<script>
(function(){
  const hdr = document.querySelector('.hlavicka-grid');
  if(!hdr) return;
  const set = () => {
    document.documentElement.style.setProperty('--header-h', hdr.getBoundingClientRect().height + 'px');
  };
  set();
  window.addEventListener('resize', set);
  new ResizeObserver(set).observe(hdr); // <- toto dorob
})();
</script>


<script type="text/plain" data-cat="analytics" src="https://plausible.io/js/plausible.js" data-domain="muzikuj.sk" defer></script>



<!-- Projektové skripty -->
<script src="{{ url_for('static', filename='main.js') }}" defer></script>
{% if show_tpl_badge and current_user.is_authenticated and (current_user.is_admin or current_user.is_moderator) %}
<div style="position:fixed;left:8px;bottom:8px;z-index:9999;background:#111;color:#0f0;font:12px/1.2 monospace;padding:4px 6px;border-radius:4px;opacity:.85;">
  TPL: {{ g._last_template or 'neznáme' }} • EP: {{ request.endpoint or '—' }}
</div>
{% endif %}

</body>
</html>
