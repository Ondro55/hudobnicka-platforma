<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Muzikuj{% endblock %}</title>

  <!-- Štýly -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profil.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/skupina.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/vyskakovacie_okno.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/kalendar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/inzerat.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/komunita.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/spravy.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Open+Sans&display=swap" rel="stylesheet" />
</head>

<body data-zobraz="{{ zobraz_formular }}">

<header class="hlavicka-grid">
  <div class="box1">
    <div class="logo">Muzikuj.sk</div>
  </div>

  <div class="box2">
    <div class="box2-wrapper">
      <div class="social-icons">
        <a href="#"><img src="{{ url_for('static', filename='fb.png') }}" alt="Facebook"></a>
        <a href="#"><img src="{{ url_for('static', filename='ig.png') }}" alt="Instagram"></a>
      </div>

      <div class="user-panel">
        {% if current_user.is_authenticated %}
          <!-- ✉️ Ikonka správ (pred user-info) -->
          <a href="{{ url_for('spravy.inbox') }}"
            class="msg-icon {% if neprecitane_count and neprecitane_count > 0 %}has-unread{% endif %}"
            aria-label="Správy">
            <span class="icon">✉️</span>
            {% if neprecitane_count and neprecitane_count > 0 %}
              <span class="badge">{{ neprecitane_count }}</span>
            {% endif %}
          </a>

          <span class="user-info">👋 {{ current_user.prezyvka }}</span>
          <a href="{{ url_for('uzivatel.profil') }}" class="header-btn">Moje konto</a>
          <a href="{{ url_for('main.logout') }}" class="header-btn logout-btn">Odhlásiť sa</a>
        {% else %}
          <button type="button" class="header-btn" data-modal-open="#modal-login">Prihlásiť sa</button>
          <button type="button" class="header-btn" data-modal-open="#user-form-panel">Registrovať sa</button>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="box3">
    <button class="hamburger" onclick="toggleMenu()">☰</button>
    <div class="nav-wrapper">
      <nav class="main-nav">
        <a href="{{ url_for('uzivatel.profil') }}">Domov</a>
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('dopyty.zobraz_dopyty') }}">📬 Dopyty</a>
          <a href="#" id="show-band-form">🎵 Kapely</a>
          <a href="{{ url_for('inzerat.bazar_verejny') }}">🛒 Bazár</a>
          <a href="{{ url_for('komunita.komunita') }}">Komunita</a>
          <a href="#">e-shop</a>
          <a href="#kontakt">Kontakt</a>
        {% else %}
          <!-- “Sivé” odkazy otvoria login modal -->
          <a href="#" class="disabled-link" data-modal-open="#modal-login">📬 Dopyty</a>
          <a href="#" class="disabled-link" data-modal-open="#modal-login">🎵 Kapely</a>
          <a href="#" class="disabled-link" data-modal-open="#modal-login">🛒 Bazár</a>
          <a href="#" class="disabled-link" data-modal-open="#modal-login">Komunita</a>
          <a href="#">e-shop</a>
          <a href="#kontakt">Kontakt</a>
        {% endif %}
      </nav>
    </div>
  </div>
</header>

<div class="button-container">
  {% if current_user.is_authenticated and request.endpoint != 'index' %}
    <aside class="button-sidebar">
      <a href="{{ url_for('uzivatel.profil') }}"  class="sidebar-btn {% if request.endpoint == 'uzivatel.profil' %}aktivne{% endif %}">👤 Profil</a>
      <a href="{{ url_for('skupina.skupina') }}"  class="sidebar-btn {% if request.endpoint == 'skupina.skupina' %}aktivne{% endif %}">🎸 Moja skupina</a>
      <a href="{{ url_for('kalendar.kalendar') }}" class="sidebar-btn {% if request.endpoint == 'kalendar.kalendar' %}aktivne{% endif %}">📅 Kalendár</a>
      <a href="{{ url_for('inzerat.moj_bazar') }}" class="sidebar-btn {% if request.endpoint == 'inzerat.moj_bazar' %}aktivne{% endif %}">🛍️ Môj bazár</a>
      <a href="{{ url_for('spravy.inbox') }}" class="sidebar-btn {% if request.endpoint and request.endpoint.startswith('spravy') %}aktivne{% endif %}">📨 Správy</a>
    </aside>

    <main class="main-content">
  {% else %}
    <main class="main-no-sidebar">
  {% endif %}
      {% block content %}{% endblock %}
    </main>
</div>


{% include 'includes/novinky.html' %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-container">
      {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if zobraz_uvitanie %}
  <div id="uvitanie-popup" class="uvitanie-box">
    <h2>🎉 Vitaj v komunite hudobníkov, {{ zobraz_uvitanie }}!</h2>
    <p>Tvoj účet bol úspešne vytvorený.</p>
  </div>
{% endif %}

<!-- MODÁLNE FORMULÁRE -->
{% include 'modals/prihlasenie.html' %}
{% include 'modals/registracia.html' %}

<!-- 🧹 Dedup: ak by sa modaly vložili 2×, ponechaj poslednú -->
<script>
  (function () {
    ['modal-login', 'user-form-panel', 'form-hladam-kapelu', 'form-inzerat'].forEach(id => {
      const all = document.querySelectorAll('#' + id);
      if (all.length > 1) {
        all.forEach((el, i) => { if (i < all.length - 1) el.remove(); });
        console.warn('⚠️ Removed duplicate modal:', id, 'had', all.length, 'copies');
      }
    });
  })();
</script>

<section id="kontakt" class="kontakt">
  <h2>Kontaktujte nás</h2>
  <p>Ak máte otázky, návrhy alebo chcete pridať svoju skupinu/kapelu, ozvite sa:</p>
  <div class="kontakt-boxy">
    <div class="kontakt-box">
      <h3>Email</h3>
      <p><a href="mailto:info@muzikuj.sk">info@muzikuj.sk</a></p>
    </div>
    <div class="kontakt-box">
      <h3>Telefón</h3>
      <p>+421 900 123 456</p>
    </div>
    <div class="kontakt-box">
      <h3>Sociálne siete</h3>
      <p><a href="#">Facebook</a> | <a href="#">Instagram</a></p>
    </div>
  </div>
</section>
<div id="sprava-modal" class="modal" hidden aria-hidden="true" role="dialog" aria-labelledby="sprava-title">
  <div class="modal-backdrop" data-close="sprava-modal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);"></div>
  <div class="modal-panel" style="position:fixed;inset:10% auto auto 50%;transform:translateX(-50%);
       max-width:620px;width:calc(100% - 2rem);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <form id="sprava-form" method="POST"
          action="#"
          style="padding:1rem;">
      <h3 id="sprava-title" style="margin:0 0 .5rem 0;">Napísať reakciu</h3>

      <input type="hidden" name="dopyt_id">
      <div style="display:grid;gap:.75rem;">
        <label>Komu
          <input type="email" name="to" placeholder="prijímateľ" required>
        </label>
        <label>Predmet
          <input type="text" name="subject" required>
        </label>
        <label>Správa
          <textarea name="message" rows="6" placeholder="Tvoja ponuka, dostupnosť, cena…" required></textarea>
        </label>
      </div>

      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;">
        <button type="button" class="btn" data-close="sprava-modal">Zavrieť</button>
        <button type="submit" class="btn primary">Odoslať</button>
      </div>
    </form>
  </div>
</div>

<footer>
  <p>&copy; 2025 Muzikuj.sk | Všetky práva vyhradené</p>
</footer>

<script>
  // hamburger
  function toggleMenu(){
    const nav = document.querySelector('.main-nav');
    if (nav) nav.classList.toggle('active');
  }

  // ✅ JEDEN správca modálov (delegácia + ESC + backdrop)
  (function () {
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    // otvor POSLEDNÚ kópiu podľa selektora (ak by sa niekde ešte duplikovalo)
    function openModal(selOrEl) {
      let m = null;
      if (typeof selOrEl === 'string') {
        const all = $$(selOrEl);
        m = all[all.length - 1] || null;
      } else {
        m = selOrEl;
      }
      if (!m) return;
      m.classList.add('open');
      requestAnimationFrame(() => {
        const r = m.getBoundingClientRect();
        if (r.width > 0 && r.height > 0) document.body.style.overflow = 'hidden';
      });
    }

    function closeModal(el) {
      const m = el?.closest?.('.modal-root') || el;
      if (!m) return;
      m.classList.remove('open');
      if (!$('.modal-root.open')) document.body.style.overflow = '';
    }

    // Delegované kliky
    document.addEventListener('click', (e) => {
      const openBtn  = e.target.closest('[data-modal-open]');
      const closeBtn = e.target.closest('[data-modal-close], .modal-close');
      if (openBtn) { e.preventDefault(); openModal(openBtn.getAttribute('data-modal-open')); return; }
      if (closeBtn){ e.preventDefault(); closeModal(closeBtn); return; }
      // klik priamo na backdrop
      if (e.target.classList && e.target.classList.contains('modal-root')) {
        e.preventDefault(); closeModal(e.target);
      }
    });

    // ESC zatvorí všetky otvorené
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') $$('.modal-root.open').forEach(m => closeModal(m));
    });

    // Auto-open podľa data-zobraz
    document.addEventListener('DOMContentLoaded', () => {
      const z = document.body.getAttribute('data-zobraz');
      if (z === 'prihlasenie') openModal('#modal-login');
      if (z === 'uzivatel')    openModal('#user-form-panel');

      // ak existuje tlačidlo „Nájdi kapelu“ a panel, prepoj ho
      const bandBtn = document.getElementById('show-band-form');
      if (bandBtn && $('#form-hladam-kapelu')) {
        bandBtn.setAttribute('data-modal-open', '#form-hladam-kapelu');
      }
    });
  })();
</script>

<!-- projektové skripty -->
<script src="{{ url_for('static', filename='main.js') }}" defer></script>
<script src="{{ url_for('static', filename='vyskakovacie_okno.js') }}" defer></script>
</body>
</html>
