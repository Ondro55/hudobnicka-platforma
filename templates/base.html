<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Muzikuj{% endblock %}</title>

  <!-- Štýly -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profil.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/skupina.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/vyskakovacie_okno.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/kalendar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/inzerat.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/komunita.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/spravy.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Open+Sans&display=swap" rel="stylesheet" />
</head>

<body data-zobraz="{{ zobraz_formular }}">

<header class="hlavicka-grid">
  <div class="box1"><div class="logo">Muzikuj.sk</div></div>

  <div class="box2">
    <div class="box2-wrapper">
      <div class="social-icons">
        <a href="#"><img src="{{ url_for('static', filename='fb.png') }}" alt="Facebook"></a>
        <a href="#"><img src="{{ url_for('static', filename='ig.png') }}" alt="Instagram"></a>
      </div>

      <div class="user-panel">
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('spravy.inbox') }}"
             class="msg-icon {% if neprecitane_count and neprecitane_count > 0 %}has-unread{% endif %}"
             aria-label="Správy">
            <span class="icon">✉️</span>
            {% if neprecitane_count and neprecitane_count > 0 %}
              <span class="badge">{{ neprecitane_count }}</span>
            {% endif %}
          </a>

          <span class="user-info">👋 {{ current_user.prezyvka }}</span>
          <a href="{{ url_for('uzivatel.profil') }}" class="header-btn">Moje konto</a>
          <a href="{{ url_for('main.logout') }}" class="header-btn logout-btn">Odhlásiť sa</a>
        {% else %}
          <button type="button" class="header-btn" data-modal-open="#modal-login">Prihlásiť sa</button>
          <button type="button" class="header-btn" data-modal-open="#user-form-panel">Registrovať sa</button>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="box3">
    <button class="hamburger" onclick="toggleMenu()">☰</button>
    <div class="nav-wrapper">
      <nav class="main-nav">
        <a href="{{ url_for('uzivatel.profil') }}">Domov</a>
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('dopyty.zobraz_dopyty') }}">📬 Dopyty</a>
          <a href="#" id="show-band-form">🎵 Kapely</a>
          <a href="{{ url_for('inzerat.bazar_verejny') }}">🛒 Bazár</a>
          <a href="{{ url_for('komunita.komunita') }}">Komunita</a>
          <a href="#">e-shop</a>
          <a href="#kontakt">Kontakt</a>
        {% else %}
          <a href="#" class="disabled-link" data-modal-open="#modal-login">📬 Dopyty</a>
          <a href="#" class="disabled-link" data-modal-open="#modal-login">🎵 Kapely</a>
          <a href="#" class="disabled-link" data-modal-open="#modal-login">🛒 Bazár</a>
          <a href="#" class="disabled-link" data-modal-open="#modal-login">Komunita</a>
          <a href="#">e-shop</a>
          <a href="#kontakt">Kontakt</a>
        {% endif %}
      </nav>
    </div>
  </div>
</header>

<div class="button-container">
  {% if current_user.is_authenticated and request.endpoint != 'index' %}
    <aside class="button-sidebar">
      <a href="{{ url_for('uzivatel.profil') }}"  class="sidebar-btn {% if request.endpoint == 'uzivatel.profil' %}aktivne{% endif %}">👤 Profil</a>
      <a href="{{ url_for('skupina.skupina') }}"  class="sidebar-btn {% if request.endpoint == 'skupina.skupina' %}aktivne{% endif %}">🎸 Moja skupina</a>
      <a href="{{ url_for('kalendar.kalendar') }}" class="sidebar-btn {% if request.endpoint == 'kalendar.kalendar' %}aktivne{% endif %}">📅 Kalendár</a>
      <a href="{{ url_for('inzerat.moj_bazar') }}" class="sidebar-btn {% if request.endpoint == 'inzerat.moj_bazar' %}aktivne{% endif %}">🛍️ Môj bazár</a>
      <a href="{{ url_for('spravy.inbox') }}" class="sidebar-btn {% if request.endpoint and request.endpoint.startswith('spravy') %}aktivne{% endif %}">📨 Správy</a>
    </aside>
    <main class="main-content">
  {% else %}
    <main class="main-no-sidebar">
  {% endif %}
      {% block content %}{% endblock %}
    </main>
</div>

{% include 'includes/novinky.html' %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-container">
      {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if zobraz_uvitanie %}
  <div id="uvitanie-popup" class="uvitanie-box">
    <h2>🎉 Vitaj v komunite hudobníkov, {{ zobraz_uvitanie }}!</h2>
    <p>Tvoj účet bol úspešne vytvorený.</p>
  </div>
{% endif %}

<!-- MODÁLNE FORMULÁRE (login/registrácia) -->
{% include 'modals/prihlasenie.html' %}
{% include 'modals/registracia.html' %}

<!-- 🧹 Dedup len pre istotu -->
<script>
  (function () {
    ['modal-login', 'user-form-panel', 'dopyt-form', 'form-inzerat'].forEach(id => {
      const all = document.querySelectorAll('#' + id);
      if (all.length > 1) {
        all.forEach((el, i) => { if (i < all.length - 1) el.remove(); });
        console.warn('⚠️ Removed duplicate modal:', id, 'had', all.length, 'copies');
      }
    });
  })();
</script>

<section id="kontakt" class="kontakt">
  <h2>Kontaktujte nás</h2>
  <div class="kontakt-boxy">
    <div class="kontakt-box"><h3>Email</h3><p><a href="mailto:info@muzikuj.sk">info@muzikuj.sk</a></p></div>
    <div class="kontakt-box"><h3>Telefón</h3><p>+421 900 123 456</p></div>
    <div class="kontakt-box"><h3>Sociálne siete</h3><p><a href="#">Facebook</a> | <a href="#">Instagram</a></p></div>
  </div>
</section>

<!-- 📩 Správy – extra modal (ponechané) -->
<div id="sprava-modal" class="modal" hidden aria-hidden="true" role="dialog" aria-labelledby="sprava-title">
  <div class="modal-backdrop" data-modal-close style="position:fixed;inset:0;background:rgba(0,0,0,.5);"></div>
  <div class="modal-panel" style="position:fixed;inset:10% auto auto 50%;transform:translateX(-50%);
       max-width:620px;width:calc(100% - 2rem);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <form id="sprava-form" method="POST" action="#" style="padding:1rem;">
      <h3 id="sprava-title" style="margin:0 0 .5rem 0;">Napísať reakciu</h3>
      <input type="hidden" name="dopyt_id">
      <div style="display:grid;gap:.75rem;">
        <label>Komu <input type="email" name="to" placeholder="prijímateľ" required></label>
        <label>Predmet <input type="text" name="subject" required></label>
        <label>Správa <textarea name="message" rows="6" placeholder="Tvoja ponuka, dostupnosť, cena…" required></textarea></label>
      </div>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;">
        <button type="button" class="btn" data-modal-close>Zavrieť</button>
        <button type="submit" class="btn primary">Odoslať</button>
      </div>
    </form>
  </div>
</div>

<footer><p>&copy; 2025 Muzikuj.sk | Všetky práva vyhradené</p></footer>

<!-- drobná utilita pre burger -->
<script>
  function toggleMenu(){ document.querySelector('.main-nav')?.classList.toggle('active'); }
</script>

<!-- Jeden spoľahlivý správca modálov (portál + fokus) -->
<script>
  (function () {
    if (window.__PORTAL_MODAL_MGR__) return; window.__PORTAL_MODAL_MGR__ = true;
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    let lastOpener = null;

    function toBodyTop(modal){
      if (!modal) return;
      if (modal.parentNode !== document.body || modal !== document.body.lastElementChild) {
        document.body.appendChild(modal);
      }
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.zIndex = '2147483647';
      modal.style.pointerEvents = 'auto';
      const card = modal.querySelector('.modal-card, .modal-panel');
      if (card) { card.style.position = 'relative'; card.style.zIndex = '2'; card.style.pointerEvents = 'auto'; }
      const bd = modal.querySelector('.modal-backdrop');
      if (bd)   { bd.style.zIndex = '1'; bd.style.pointerEvents = 'auto'; }
    }
    function focusFirst(modal){
      const first = modal.querySelector('[autofocus], select, input, textarea, button, [href], [tabindex]:not([tabindex="-1"])');
      if (first) { first.focus({preventScroll:true}); return; }
      modal.setAttribute('tabindex', '-1'); modal.focus({preventScroll:true});
    }
    function getLast(sel){ const all = $$(sel); return all[all.length - 1] || null; }

    function openModal(selOrEl) {
      const m = (typeof selOrEl === 'string') ? getLast(selOrEl) : selOrEl;
      if (!m) return;
      toBodyTop(m); m.hidden = false; m.setAttribute('aria-hidden','false'); m.classList.add('open');
      document.body.classList.add('modal-open'); setTimeout(() => focusFirst(m), 0);
    }
    function closeModal(node) {
      const m = node?.closest?.('.modal-root, .modal') || node; if (!m) return;
      if (m.contains(document.activeElement)) document.activeElement.blur();
      m.classList.remove('open'); m.hidden = true; m.setAttribute('aria-hidden','true');
      if (!$('.modal-root.open, .modal:not([hidden])')) document.body.classList.remove('modal-open');
      if (lastOpener && document.body.contains(lastOpener)) lastOpener.focus({preventScroll:true});
    }

    document.addEventListener('click', (e) => {
      const opener = e.target.closest('[data-modal-open]'); if (opener){ e.preventDefault(); lastOpener = opener; openModal(opener.getAttribute('data-modal-open')); return; }
      const closer = e.target.closest('[data-modal-close], .modal-close'); if (closer){ e.preventDefault(); closeModal(closer); return; }
      if (e.target.classList?.contains('modal-backdrop')) {e.preventDefault(); closeModal(e.target);}
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') $$('.modal-root.open, .modal:not([hidden])').forEach(m => closeModal(m)); });

    window.openModal = openModal; window.closeModal = closeModal;
  })();
</script>

<!-- projektové skripty -->
<script src="{{ url_for('static', filename='main.js') }}" defer></script>
<script src="{{ url_for('static', filename='vyskakovacie_okno.js') }}" defer></script>
</body>
</html>
