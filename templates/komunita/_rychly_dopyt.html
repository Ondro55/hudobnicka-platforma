{# templates/komunita/_rychly_dopyt.html #}

<header style="display:flex;justify-content:space-between;align-items:end;gap:1rem;margin-bottom:.5rem;">
  <div>
    <h3 style="margin:0;">‚ö° R√Ωchly dopyt</h3>
    <p class="meta" style="margin:.25rem 0 0;color:#666;">
      Kr√°tke po≈æiadavky komunity. Pr√≠spevky sa po ƒçase automaticky archivuj√∫.
    </p>
  </div>
  <div>
    {% if current_user.is_authenticated %}
      <a class="btn primary" href="#" data-modal-open="#rychly-dopyt-form">‚ûï Zada≈• r√Ωchly dopyt</a>
    {% else %}
      <a class="btn primary" href="#" data-modal-open="#modal-login">‚ûï Zada≈• r√Ωchly dopyt</a>
    {% endif %}
  </div>
</header>

{# filter li≈°ta ‚Äì konzistentn√° s in√Ωmi str√°nkami #}
{% set action_url = url_for('komunita.hub', tab='rychly-dopyt') %}
{% set placeholder = 'Hƒæada≈• r√Ωchle dopyty‚Ä¶' %}
{% set btn_label = 'Hƒæada≈•' %}
{% set show_mesto = True %}
{% set show_zaner = False %}
{% set show_kategoria = False %}
{% set q = request.args.get('q','') %}
{% set mesto = request.args.get('mesto','') %}
{% include "includes/filterbar.html" %}

{# hlaviƒçka stƒ∫pcov #}
<div class="columns-head" style="font-size:.85rem;color:#666;margin:.5rem 0;">
  <div class="kom-grid-head rychly"
       style="display:grid;gap:.75rem;align-items:center;
              grid-template-columns:minmax(0,2.4fr) .9fr .9fr .9fr;">
    <div>Spr√°va</div>
    <div>Mesto</div>
    <div>Autor</div>
    <div>Akcie</div>
  </div>
</div>

{# zoznam r√Ωchlych dopytov ‚Äì oƒçak√°va premen√∫ 'rychle_dopyty' #}
<div class="list-rows">
  {% for qd in (rychle_dopyty or []) %}
    {% set txt = qd.text or qd.popis or qd.nazov or '' %}
    <article class="list-row kom-grid-row rychly"
             style="display:grid;gap:.75rem;align-items:start;
                    grid-template-columns:minmax(0,2.4fr) .9fr .9fr .9fr;">

      <!-- Spr√°va (2 riadky, nepre≈•ahuje grid) -->
      <div style="min-width:0;">
        <div style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
          {{ txt }}
        </div>
        {% if qd.plati_do %}
          <div class="meta" style="color:#666;margin-top:.2rem;">üïí platn√© do: {{ qd.plati_do|localtime('%d.%m.%Y') }}</div>
        {% endif %}
      </div>

      <!-- Mesto -->
      <div class="text-clip">
        {% if qd.mesto_ref %}{{ qd.mesto_ref.nazov }}{% elif qd.miesto %}{{ qd.miesto }}{% else %}‚Äî{% endif %}
      </div>

      <!-- Autor -->
      <div class="text-clip">
        {% if qd.autor %}{{ qd.autor.prezyvka or qd.autor.meno or 'Pou≈æ√≠vateƒæ' }}{% else %}‚Äî{% endif %}
      </div>

      <!-- Akcie -->
      <div class="row-actions">
        {% if current_user.is_authenticated %}
          {% if qd.autor_id and (qd.autor_id != current_user.id) %}
            <a class="btn sm" href="{{ url_for('spravy.napisat', komu_id=qd.autor_id) }}">‚úâÔ∏è Spr√°va</a>
          {% else %}
            <span class="meta" style="color:#666;">Tvoj dopyt</span>
          {% endif %}
          {# mazanie vlastn√©ho dopytu ‚Äì backend dopln√≠me nesk√¥r #}
          {% if qd.autor_id == current_user.id %}
            <form method="post" action="#" onsubmit="return confirm('Zmaza≈• tento r√Ωchly dopyt?');" style="display:inline;">
              {{ csrf_token() if csrf_token is defined }}
              <button class="btn ghost sm" type="submit">Zmaza≈•</button>
            </form>
          {% endif %}
        {% else %}
          <a class="btn primary sm" href="#" data-modal-open="#modal-login">‚úâÔ∏è Spr√°va</a>
        {% endif %}
      </div>

    </article>
  {% else %}
    <p style="padding:.75rem 0;">üòï Zatiaƒæ ≈æiadne r√Ωchle dopyty podƒæa filtra.</p>
  {% endfor %}
</div>

{# MOD√ÅL: nov√Ω r√Ωchly dopyt (ƒçist√Ω frontend; akciu dopln√≠me po route) #}
<div id="rychly-dopyt-form" class="modal" hidden>
  <div class="modal-content" style="max-width:680px;">
    <header class="modal-header">
      <h3 style="margin:0;">‚ûï Nov√Ω r√Ωchly dopyt</h3>
      <button class="icon-btn" data-modal-close>‚úñ</button>
    </header>

    {% if current_user.is_authenticated %}
      <form method="post" action="#" autocomplete="off">
        {{ csrf_token() if csrf_token is defined }}
        <div class="modal-body" style="display:flex;flex-direction:column;gap:.75rem;">
          <textarea class="input" name="text" rows="4"
                    placeholder="Napr.: Hƒæad√°m kl√°ves√°ka na sobotu 19:00, Bratislava ‚Äì sk√∫≈°ka/koncert."
                    required></textarea>

          <div style="display:grid;grid-template-columns:1.2fr 1fr;gap:.5rem;">
            <div>
              <label class="meta" style="display:block;margin-bottom:.25rem;color:#666;">Mesto</label>
              <select class="select" name="mesto_id">
                <option value="">‚Äî vyber mesto ‚Äî</option>
                {% for m in (mesta_all or []) %}
                  <option value="{{ m.id }}">{{ m.nazov }}{% if m.okres %}, {{ m.okres }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="meta" style="display:block;margin-bottom:.25rem;color:#666;">≈Ωivotnos≈•</label>
              <select class="select" name="ttl_days">
                <option value="7">7 dn√≠</option>
                <option value="14">14 dn√≠</option>
                <option value="30" selected>30 dn√≠</option>
              </select>
            </div>
          </div>

          <p class="meta" style="color:#666;margin:0;">Kr√°tke a vecn√©, ≈æiadne kontakty priamo v texte ‚Äì komunik√°cia prebehne cez Spr√°vy.</p>
        </div>
        <footer class="modal-footer" style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.5rem;">
          <button type="button" class="btn ghost" data-modal-close>Zru≈°i≈•</button>
          <button type="submit" class="btn primary">Ulo≈æi≈•</button>
        </footer>
      </form>
    {% else %}
      <div class="modal-body">
        <p class="meta" style="color:#666;">Aby si mohol prida≈• r√Ωchly dopyt, prihl√°s sa.</p>
        <a class="btn primary" href="#" data-modal-open="#modal-login">Prihl√°si≈• sa</a>
      </div>
    {% endif %}
  </div>
</div>

<style>
  .kom-grid-head.rychly,
  .kom-grid-row.rychly { grid-template-columns: minmax(0, 2.4fr) .9fr .9fr .9fr; }
  .kom-grid-row.rychly > div { min-width:0; overflow-wrap:anywhere; word-break:break-word; }
  .row-actions { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
</style>
