{# templates/komunita/_forum.html ‚Äî ƒæavo: editor + filter + zoznam, pravo: detail + odpovede #}
{% set watched_ids = watched_ids or [] %}

<div class="forum-layout">
  <!-- ƒΩAVO (‚âà1/3): editor + filter + zoznam -->
  <section class="forum-left">
    {# EDITOR (bez kateg√≥ri√≠) #}
    <article class="card" style="padding:1rem;margin-bottom:.75rem;">
      {% if current_user.is_authenticated %}
        <form method="post" action="{{ url_for('forum.create') }}" style="display:grid;gap:.6rem;">
          {{ csrf_token() if csrf_token is defined }}
          <input class="input" name="nazov" placeholder="N√°zov t√©my (jednou vetou)‚Ä¶" required>
          <textarea class="input" name="body" rows="4" placeholder="Pop√≠≈° probl√©m / ot√°zku‚Ä¶ ƒåo si sk√∫≈°al/a? N√°stroj/verzia‚Ä¶"></textarea>
          <div style="display:flex;justify-content:flex-end;">
            <button class="btn primary" type="submit">Prida≈• t√©mu</button>
          </div>
        </form>
      {% else %}
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap;">
          <div class="meta" style="color:#666;">Na zalo≈æenie t√©my sa prihl√°s.</div>
          <a class="btn primary" href="#" data-modal-open="#modal-login">Prihl√°si≈• sa</a>
        </div>
      {% endif %}
    </article>
    
    <form method="post" action="{{ url_for('forum.mark_all_read') }}" style="margin:.25rem 0 0 auto;">
      {{ csrf_token() if csrf_token is defined }}
      <button class="btn sm ghost" title="Vynulova≈• f√≥rov√© badge">Oznaƒçi≈• v≈°etko preƒç√≠tan√©</button>
    </form>

    {# FILTER + ‚ÄûMoje‚Ä¶‚Äú v tom istom wrapperi #}
    <div class="filterbar forum-filterbar">
      <!-- horn√Ω riadok: hƒæadanie + zoradenie -->
      <form class="filter-row" method="get" action="{{ url_for('komunita.hub') }}">
        <input type="hidden" name="tab" value="forum">

        <input class="input" type="search" name="q"
               value="{{ request.args.get('q','') }}"
               placeholder="Hƒæada≈• v t√©mach‚Ä¶">

        {% set _sort = request.args.get('sort','activity') %}
        <select class="select" name="sort" title="Zoradenie">
          <option value="activity" {{ 'selected' if _sort=='activity' else '' }}>Podƒæa aktivity</option>
          <option value="newest"   {{ 'selected' if _sort=='newest'   else '' }}>Najnov≈°ie</option>
          <option value="answers"  {{ 'selected' if _sort=='answers'  else '' }}>Najviac odpoved√≠</option>
        </select>

        <button class="btn sm" type="submit">Filtrova≈•</button>
      </form>

      <!-- spodn√Ω riadok: ‚ÄûMoje‚Äú chipy -->
      <div class="filter-row mine-row">
        <a href="{{ url_for('komunita.hub', tab='forum', view='mine') }}"
           class="chip-btn {{ 'active' if request.args.get('view')=='mine' else '' }}">Moje t√©my</a>
        <a href="{{ url_for('komunita.hub', tab='forum', view='replied') }}"
           class="chip-btn {{ 'active' if request.args.get('view')=='replied' else '' }}">Moje odpovede</a>
        <a href="{{ url_for('komunita.hub', tab='forum', view='watching') }}"
           class="chip-btn {{ 'active' if request.args.get('view')=='watching' else '' }}">Sledovan√©</a>
      </div>
    </div>

    {# ZOZNAM T√âM ‚Äî iba n√°zov, ≈æiadny snippet, akcie = len ‚≠ê/‚òÜ #}
    <div class="columns-head" style="font-size:.85rem;color:#666;margin:.25rem 0;">
      <div class="kom-grid-head forum">
        <div>T√©ma</div>
        <div>Odpovede</div>
        <div>Aktivita</div>
        <div>Akcie</div>
      </div>
    </div>

    <div class="list-rows">
      {% for t in (topics or []) %}
        <article class="list-row kom-grid-row forum">
          <!-- T√©ma: len n√°zov -->
          <div class="cell-title">
            <a class="link-plain" href="{{ url_for('komunita.hub', tab='forum', t=t.id) }}">
              <strong class="title">{{ t.nazov }}</strong>
            </a>
          </div>

          <!-- Odpovede -->
          <div class="text-clip hide-sm">{{ t.pocet_odpovedi or 0 }}</div>

          <!-- Aktivita -->
          <div class="text-clip hide-sm activity">
            {% if t.aktivita_at %}{{ t.aktivita_at|localtime }}{% else %}‚Äî{% endif %}
          </div>


          <!-- Akcie: sledovanie -->
          <div class="row-actions">
            {% if current_user.is_authenticated %}
              {% set watching = (t.id in watched_ids) %}
              <form method="post" action="{{ url_for('forum.toggle_watch', topic_id=t.id) }}" style="display:inline;">
                {{ csrf_token() if csrf_token is defined }}
                <button class="icon-btn" title="{{ 'Zru≈°i≈• sledovanie' if watching else 'Sledova≈•' }}">
                  {{ '‚≠ê' if watching else '‚òÜ' }}
                </button>
              </form>
            {% else %}
              <button class="icon-btn" data-modal-open="#modal-login" title="Sledova≈•">‚òÜ</button>
            {% endif %}
          </div>
        </article>
      {% else %}
        <p style="padding:.75rem 0;">üòï Zatiaƒæ ≈æiadne t√©my. Nap√≠≈° prv√∫ v editore hore.</p>
      {% endfor %}
    </div>
  </section>

  <!-- PRAVO (‚âà2/3): detail + odpovede + reply ‚Äûpre niekoho‚Äú -->
  <aside class="forum-right">
    {% if selected_topic %}
      {# kotva pre skrol na vrch detailu #}
      <span id="topic-detail-top"></span>

      <article id="topic-detail-card" class="card" style="padding:1rem;">
        {% set watching_detail = current_user.is_authenticated and (selected_topic.id in watched_ids) %}

        <header style="display:flex;justify-content:space-between;align-items:start;gap:1rem;">
          <div style="min-width:0;">
            <h3 style="margin:.2rem 0 .25rem 0;line-height:1.25;">{{ selected_topic.nazov }}</h3>
            <div class="meta" style="color:#666;">
              üßë {{ (selected_topic.autor.prezyvka or selected_topic.autor.meno) if selected_topic.autor else 'Autor t√©my' }}
              ‚Ä¢ ‚è±Ô∏è {{ selected_topic.vytvorene_at|localtime if selected_topic.vytvorene_at else '' }}
            </div>
          </div>
          <div class="row-actions" style="flex-shrink:0;">
            {% if current_user.is_authenticated %}
              <form method="post" action="{{ url_for('forum.toggle_watch', topic_id=selected_topic.id) }}" style="display:inline;">
                {{ csrf_token() if csrf_token is defined }}
                <button class="icon-btn" title="{{ 'Zru≈°i≈• sledovanie' if watching_detail else 'Sledova≈•' }}">
                  {{ '‚≠ê' if watching_detail else '‚òÜ' }}
                </button>
              </form>
            {% else %}
              <button class="icon-btn" data-modal-open="#modal-login" title="Sledova≈•">‚òÜ</button>
            {% endif %}
          </div>
        </header>

        {% if selected_topic.body %}
          <div style="white-space:pre-wrap;margin-top:.5rem;">{{ selected_topic.body }}</div>
        {% endif %}

        <section style="margin-top:1rem;">
          <h4 style="margin:0 0 .5rem 0;">Odpovede</h4>
          {% for p in (selected_topic.posts or []) %}
            <div class="list-row" id="post-{{ p.id }}" style="display:block;padding:.75rem;">
              <div class="meta" style="color:#666;margin-bottom:.25rem;">
                üßë {{ (p.autor.prezyvka or p.autor.meno) if p.autor else 'Pou≈æ√≠vateƒæ' }}
                ‚Ä¢ ‚è±Ô∏è {{ p.vytvorene_at|localtime if p.vytvorene_at else '' }}
                {% if p.is_answer %} ‚Ä¢ ‚úÖ Najlep≈°ia odpoveƒè{% endif %}
              </div>
              <div style="white-space:pre-wrap;">{{ p.body }}</div>
              <div class="row-actions" style="margin-top:.35rem;display:flex;gap:.5rem;flex-wrap:wrap;">
                {% if current_user.is_authenticated and selected_topic.autor_id == current_user.id and not p.is_answer %}
                  <form method="post" action="{{ url_for('forum.mark_best', post_id=p.id) }}" style="display:inline;">
                    {{ csrf_token() if csrf_token is defined }}
                    <button class="btn sm">Oznaƒçi≈• ako najlep≈°iu</button>
                  </form>
                {% endif %}

                {% set target_name = (p.autor.prezyvka or p.autor.meno) if p.autor else 'Pou≈æ√≠vateƒæ' %}
                {% set target_id = p.autor_id or 0 %}

                {% if current_user.is_authenticated %}
                  <button class="btn ghost sm" type="button"
                          onclick="setReplyTarget('{{ target_name|e }}', {{ target_id }})">
                    Odpoveda≈•
                  </button>
                {% else %}
                  <button class="btn ghost sm" data-modal-open="#modal-login">Odpoveda≈•</button>
                {% endif %}

                <button class="btn ghost sm" data-report-post="{{ p.id }}">Nahl√°si≈•</button>
              </div>
            </div>
          {% else %}
            <p class="meta" style="color:#666;">Zatiaƒæ bez odpoved√≠. Buƒè prv√Ω ‚úçÔ∏è</p>
          {% endfor %}
        </section>

        <section style="margin-top:1rem;">
          {% if current_user.is_authenticated %}
            {% set topic_author_name = (selected_topic.autor.prezyvka or selected_topic.autor.meno) if selected_topic.autor else 'Autor t√©my' %}
            {% set topic_author_id   = selected_topic.autor_id or 0 %}

            <div id="reply-target-pill" class="reply-pill">
              Odpoved√°≈°: <strong id="reply-target-name">@{{ topic_author_name }}</strong>
              <button type="button" class="pill-clear" onclick="resetReplyTarget()">Zru≈°i≈•</button>
            </div>

            <form id="reply-form" method="post" action="{{ url_for('forum.reply', topic_id=selected_topic.id) }}" style="display:flex;flex-direction:column;gap:.5rem;">
              {{ csrf_token() if csrf_token is defined }}
              <input type="hidden" name="reply_to_user_id" id="reply-to-user-id" value="{{ topic_author_id }}">
              <input type="hidden" name="reply_to_name"    id="reply-to-name"    value="{{ topic_author_name }}">
              <textarea class="input" name="body" id="reply-body" rows="3" placeholder="Nap√≠≈° odpoveƒè‚Ä¶"></textarea>
              <div style="display:flex;gap:.5rem;justify-content:flex-end;">
                <button type="submit" class="btn">Odosla≈•</button>
              </div>
            </form>

            <script>
              // default: autor t√©my ‚Äî bez focusu, aby to NEROLLOVALO dole
              (function initReplyDefault(){
                setReplyTarget("{{ topic_author_name|e }}", {{ topic_author_id }}, /*setBodyPrefix=*/false, /*doFocus=*/false);
              })();

              // setReplyTarget(name, userId, setBodyPrefix=true, doFocus=true)
              function setReplyTarget(name, userId, setBodyPrefix = true, doFocus = true){
                const pillName = document.getElementById('reply-target-name');
                const hidId    = document.getElementById('reply-to-user-id');
                const hidName  = document.getElementById('reply-to-name');
                const ta       = document.getElementById('reply-body');
                pillName.textContent = '@' + name;
                hidId.value = userId || '';
                hidName.value = name || '';

                if(setBodyPrefix){
                  const prefix = '@' + name + ' ';
                  if(!ta.value.startsWith(prefix)){
                    ta.value = ta.value.replace(/^@\S+\s+/, '');
                    ta.value = prefix + ta.value;
                  }
                }

                // focus LEN keƒè user klikol na "Odpoveda≈•"
                if (doFocus) {
                  ta.focus();
                  ta.selectionStart = ta.selectionEnd = ta.value.length;
                }
              }

              function resetReplyTarget(){
                setReplyTarget("{{ topic_author_name|e }}", {{ topic_author_id }}, false, false);
              }
            </script>
          {% else %}
            <a class="btn primary" href="#" data-modal-open="#modal-login">Prihl√°s sa a odpovedaj</a>
          {% endif %}
        </section>
      </article>
    {% else %}
      <article class="card" style="padding:1rem;">
        <p class="meta" style="margin:0;color:#666;">Vyber t√©mu vƒæavo alebo nap√≠≈° nov√∫ v editore hore.</p>
      </article>
    {% endif %}
  </aside>

  {# skrol + blik po naƒç√≠tan√≠ detailu #}
  {% if selected_topic %}
    <script>
      (function() {
        if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
        // ak URL obsahuje #post-..., nechaj prehliadaƒç skoƒçi≈• na anchor
        if (location.hash && location.hash.indexOf('#post-') === 0) return;
        window.scrollTo({ top: 0, behavior: 'auto' });
        const card = document.getElementById('topic-detail-card');
        if (card) {
          requestAnimationFrame(() => {
            card.classList.add('flash-highlight');
            setTimeout(() => card.classList.remove('flash-highlight'), 1200);
          });
        }
      })();
    </script>
    {% endif %}
</div>

<style>
  /* Rozlo≈æenie: 1/3 + 2/3 */
  .forum-layout{
    display:grid;
    grid-template-columns:minmax(280px,36%) 1fr;
    gap:1.25rem;
  }

  /* Filterbar v ƒæavom stƒ∫pci: dva riadky, rovnak√Ω wrapper ako inde */
  .forum-left .filterbar.forum-filterbar .filter-row{
    display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; justify-content:flex-start;
  }
  .forum-left .filterbar.forum-filterbar .mine-row{
    border-top:1px dashed #e5e7eb; margin-top:.5rem; padding-top:.5rem;
  }

  /* Chip tlaƒçidl√° (Moje‚Ä¶) */
  .chip-btn{
    display:inline-flex; align-items:center; height:34px; padding:0 .75rem;
    border:1px solid #e5e7eb; border-radius:8px; background:#fff;
    text-decoration:none; font-weight:500; color:#111;
    transition:background .15s ease, border-color .15s ease, color .15s ease;
  }
  .chip-btn:hover{ background:#f9fafb; border-color:#cbd5e1; }
  .chip-btn.active{ background:#111; color:#fff; border-color:#111; }

  /* Zoznam t√©m: 4 stƒ∫pce ‚Äì t√©ma | odpovede | aktivita | akcie */
  .kom-grid-head.forum,
  .kom-grid-row.forum{
    display:grid; gap:.75rem; align-items:center;
    grid-template-columns:minmax(0,3.0fr) .3fr 1.2fr .3fr;
  }
  .kom-grid-row.forum > div{ min-width:0; overflow-wrap:anywhere; word-break:break-word; }
  .row-actions{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }

  /* Pilulka ‚ÄûOdpoved√°≈°: @meno‚Äú */
  .reply-pill{
    display:inline-flex; align-items:center; gap:.5rem;
    background:#f8fafc; border:1px solid #e5e7eb; border-radius:999px;
    padding:.25rem .6rem; margin-bottom:.4rem; font-size:.95em;
  }
  .reply-pill .pill-clear{
    background:transparent; border:none; cursor:pointer; color:#6b7280; padding:.1rem .3rem;
  }
  .reply-pill .pill-clear:hover{ color:#111; text-decoration:underline; }

  /* Mobil */
  @media (max-width: 900px){
    .forum-layout{ grid-template-columns:1fr; }
    .kom-grid-row.forum{ grid-template-columns:1fr auto; }
    .kom-grid-row.forum .cell-title{ grid-column:1 / -1; }
    .kom-grid-row.forum .row-actions{ grid-column:1 / -1; }
  }
  /* Jednotn√° v√Ω≈°ka riadku ‚Äúna 2 riadky titulku‚Äù */
    .list-rows .kom-grid-row.forum{
      height: 50px;               /* ~2 riadky + padding; dolad√≠≈° ak treba */
      padding-block: .5rem;       /* zjednoten√Ω vertical padding */
    }
  /* kotva ‚Äì nech re≈°pektuje fixn√Ω header (uprav ƒç√≠slo podƒæa v√Ω≈°ky headera) */
#topic-detail-top { scroll-margin-top: 80px; }

/* jemn√© zv√Ωraznenie otvorenej t√©my */
@keyframes ringPulse {
  0%   { box-shadow: 0 0 0 6px rgba(34,197,94,.28); }
  100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
}
.flash-highlight {
  animation: ringPulse 1.1s ease-out 1;
  border-radius: 12px;
}

</style>
