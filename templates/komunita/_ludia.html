{# templates/komunita/_ludia.html #}

{% set action_url = url_for('komunita.hub', tab='ludia') %}
{% set placeholder = 'HÄ¾adaÅ¥ Ä¾udÃ­â€¦' %}
{% set btn_label = 'HÄ¾adaÅ¥' %}
{% set show_mesto = True %}
{% set show_zaner = True %}
{% set show_kategoria = False %}

{# predvyplnenie #}
{% set q = request.args.get('q','') %}
{% set mesto = request.args.get('mesto','') %}
{% set zaner = request.args.get('zaner','') %}

{# moÅ¾nosti pre Zameranie/Zaradenie #}
{% set ZANER_FO = [
  ('hudobnik','HudobnÃ­k'),
  ('tanecnik','TaneÄnÃ­k'),
  ('moderator','ModerÃ¡tor akciÃ­'),
  ('fotograf','Fotograf'),
  ('videograf','Videograf'),
  ('zvukar','ZvukÃ¡r'),
  ('osvetlovac','OsvetÄ¾ovaÄ'),
  ('technik_podia','Technik pÃ³dia / Roadie'),
  ('producent','Producent / Beatmaker'),
  ('skladatel','SkladateÄ¾ / AranÅ¾Ã©r'),
  ('ucitel_hudby','UÄiteÄ¾ hudby'),
  ('ine','InÃ©'),
] %}

{% set ORG_ZAR = [
  ('agentura','OrganizÃ¡tor / AgentÃºra'),
  ('prenajom_techniky','PrenÃ¡jom techniky'),
  ('prenajom_saly','PrenÃ¡jom sÃ¡ly / klubu'),
  ('studio','ProdukÄnÃ© Å¡tÃºdio'),
  ('servis','Servis (opravy / servis techniky)'),
  ('zus_skola','ZUÅ  / Å kola'),
  ('ine','InÃ©'),
] %}

{% set zaner_options = {'fo': ZANER_FO, 'org': ORG_ZAR} %}
{% include "includes/filterbar.html" %}

{# hlaviÄka stÄºpcov #}
<div class="columns-head" style="font-size:.85rem;color:#666;margin:.5rem 0;">
  <div class="kom-grid-head">
    <div>Foto</div>
    <div>PrezÃ½vka</div>
    <div>Zameranie / Zaradenie</div>
    <div>Obec</div>
    <div>Akcie</div>
  </div>
</div>

{% if current_user.is_authenticated and current_user.is_admin %}
  <form method="get" class="inline-filters" style="margin:.5rem 0; display:flex; gap:.5rem; align-items:center;">
    <input type="hidden" name="tab" value="ludia">
    <input type="hidden" name="q" value="{{ request.args.get('q','') }}">
    <label class="chip" style="display:inline-flex;gap:.35rem;align-items:center;">
      <input type="checkbox" name="vip" value="1" {% if request.args.get('vip') == '1' %}checked{% endif %}>
      Iba VIP
    </label>
    <button class="btn sm" type="submit">FiltrovaÅ¥</button>
    {% if request.args.get('vip') == '1' %}
      <a class="btn sm" href="{{ url_for('komunita.hub', tab='ludia', q=request.args.get('q','')) }}">ZruÅ¡iÅ¥ VIP filter</a>
    {% endif %}
  </form>
{% endif %}

{# zoznam pouÅ¾Ã­vateÄ¾ov #}
<div class="list-rows">
  {% for u in users %}
    {% set is_org = (u.typ_subjektu == 'ico') %}
    {% set display_name = (u.organizacia_nazov if is_org else (u.prezyvka or (u.meno ~ ' ' ~ u.priezvisko)|trim)) %}
    {% set mesto_disp = (u.sidlo_mesto if is_org else u.obec) %}
    {% set ORG_LABELS = {
      'agentura':'OrganizÃ¡tor / AgentÃºra',
      'prenajom_techniky':'PrenÃ¡jom techniky',
      'prenajom_saly':'PrenÃ¡jom sÃ¡ly / klubu',
      'studio':'ProdukÄnÃ© Å¡tÃºdio',
      'servis':'Servis (opravy / servis techniky)',
      'zus_skola':'ZUÅ  / Å kola',
      'ine':'InÃ©'
    } %}

    <article class="list-row kom-grid-row">
      <!-- Foto -->
      <div>
        {% set foto = url_for('static', filename='profilovky/' ~ (u.profil_fotka or 'avatar-user.svg')) %}
        <img class="avatar"
             src="{{ foto }}"
             data-fallback="{{ url_for('static', filename='profilovky/avatar-user.svg') }}"
             alt="ProfilovÃ¡ fotka"
             style="width:48px;height:48px;object-fit:cover;border-radius:50%;display:block;">
      </div>

      <!-- NÃ¡zov / PrezÃ½vka (ellipsis ok) -->
      <div class="text-clip" style="display:flex; align-items:center; gap:.35rem;">
        <a class="link-plain" href="{{ url_for('uzivatel.verejny_profil', user_id=u.id) }}">
          <strong>{{ display_name or 'â€”' }}</strong>
        </a>
        {% if is_org %}
          <span class="badge" style="border:1px solid #ddd;border-radius:.35rem;padding:.05rem .35rem;font-size:.75rem;">IÄŒO</span>
        {% endif %}
        {% if current_user.is_authenticated and current_user.is_admin and u.is_vip %}
          <span class="role-badge vip" title="VIP">â­</span>
        {% endif %}
      </div>

      <!-- Zameranie / Zaradenie -->
      <div class="col-zameranie">
        {% if is_org %}
          {{ ORG_LABELS.get(u.org_zaradenie, u.org_zaradenie or 'â€”') }}
          {% if u.org_zaradenie == 'ine' and u.org_zaradenie_ine %} â€“ {{ u.org_zaradenie_ine }}{% endif %}
        {% else %}
          {% set zlist = u.zamerania_list() %}
          {{ zlist|join(', ') if zlist and zlist|length > 0 else 'â€”' }}
        {% endif %}
      </div>
            
      <!-- Mesto (tieÅ¾ bez .text-clip) -->
      <div>{{ mesto_disp or 'â€”' }}</div>


      <!-- Akcie -->
      <div class="row-actions">
        {% if current_user.is_authenticated %}
          <a class="kom-msg-btn" href="{{ url_for('spravy.napisat', komu_id=u.id) }}">âœ‰ï¸ SprÃ¡va</a>
        {% else %}
          <a class="btn primary sm" href="#" data-modal-open="#modal-login">âœ‰ï¸ SprÃ¡va</a>
        {% endif %}
      </div>
    </article>
  {% else %}
    <p style="padding:.75rem 0;">ğŸ˜• NenaÅ¡li sa Å¾iadni pouÅ¾Ã­vatelia podÄ¾a filtra.</p>
  {% endfor %}
</div>

<script>
  // avatar fallback
  document.addEventListener('error', function (e) {
    const img = e.target;
    if (!(img instanceof HTMLImageElement) || !img.classList.contains('avatar')) return;
    img.classList.remove('avatar');
    img.src = "{{ url_for('static', filename='profilovky/default.png') }}";
  }, true);
</script>
