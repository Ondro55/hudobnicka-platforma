{% extends 'base.html' %}
{% block title %}Dopyty | Muzikuj{% endblock %}

{% block content %}
<section class="komunita-wrapper" style="padding:2rem;">

  <header style="display:flex;justify-content:space-between;align-items:end;gap:1rem;margin-bottom:1rem;">
    <div>
      <h2 style="margin:0;">üì¨ Dopyty</h2>
      <p style="margin:.25rem 0 0;">Po≈æiadavky na hudbu z verejn√©ho formul√°ra.</p>
    </div>
    <div>
      <button type="button" class="btn primary" data-modal-open="#dopyt-form">‚ûï Prida≈• dopyt</button>
    </div>
  </header>

  {# ---- nastavenie pre jednotn√Ω filterbar ---- #}
  {% set action_url = url_for('dopyty.zobraz_dopyty') %}
  {% set placeholder = 'Hƒæada≈• dopyty‚Ä¶' %}
  {% set btn_label = 'Hƒæada≈•' %}
  {% set show_mesto = True %}
  {% set show_zaner = False %}
  {% set show_kategoria = False %}

  {# zachovaj predvyplnen√© hodnoty, ak pri≈°li z GETu #}
  {% set q = q or request.args.get('q','') %}
  {% set mesto = mesto or request.args.get('mesto','') %}

  {% include "includes/filterbar.html" %}

  {# ---- ZOZNAM DOPYTOV v jednotn√Ωch kart√°ch ---- #}
  {% if dopyty and dopyty|length %}
    <div class="result-grid">
      {% for d in dopyty %}
        <article class="card">
          <div class="row">
            <h4 style="margin:0;">
              {{ d.typ_akcie|title if d.typ_akcie else 'Dopyt' }}
            </h4>
            <span class="meta">
              {% if d.datum %}üìÖ {{ d.datum.strftime('%d.%m.%Y') }}{% endif %}
              {% if d.cas_od or d.cas_do %}
                ‚Ä¢ ‚è∞ {{ d.cas_od.strftime('%H:%M') if d.cas_od else '‚Äî' }} ‚Äì {{ d.cas_do.strftime('%H:%M') if d.cas_do else '‚Äî' }}
              {% endif %}
            </span>
          </div>

          <p class="meta" style="margin:.25rem 0 0;">
            {% if d.mesto_ref %}
              üìç {{ d.mesto_ref.nazov }}{% if d.mesto_ref.okres %}, {{ d.mesto_ref.okres }}{% endif %}{% if d.mesto_ref.kraj %}, {{ d.mesto_ref.kraj }}{% endif %}
            {% elif d.miesto %}
              üìç {{ d.miesto }}
            {% endif %}
            ‚Ä¢ üí∂ {{ ('%.0f'|format(d.rozpocet)) ~ ' ‚Ç¨' if d.rozpocet is not none else 'dohodou' }}
            {% if d.meno %} ‚Ä¢ üë§ {{ d.meno }}{% endif %}
          </p>

          {% if d.popis %}
            <p style="margin:.5rem 0 0;">{{ d.popis | truncate(220, True, '‚Ä¶') }}</p>
          {% endif %}

          <div class="row" style="margin-top:.6rem;">
            {% if current_user.is_authenticated %}
              {% if d.email %}
                <a class="btn primary"
                   href="{{ url_for('spravy.napisat', kontekst='dopyt', kontekst_id=d.id, komu_email=d.email) }}">
                  ‚úâÔ∏è Po≈°li spr√°vu
                </a>
              {% else %}
                <span class="meta">Kontakt nie je k dispoz√≠cii.</span>
              {% endif %}
            {% else %}
              <a class="btn" href="{{ url_for('uzivatel.login') }}">Prihl√°s sa a reaguj</a>
            {% endif %}

            {% if current_user.is_authenticated and d.pouzivatel_id == current_user.id %}
              <form method="post"
                    action="{{ url_for('dopyty.delete_mine', dopyt_id=d.id) }}"
                    onsubmit="return confirm('Naozaj zmaza≈• tento dopyt?');"
                    style="margin-left:auto;">
                <button type="submit" class="btn ghost">Zmaza≈•</button>
              </form>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="sekcia-empty" style="margin-top:.75rem;">Zatiaƒæ ≈æiadne dopyty podƒæa filtra.</p>
  {% endif %}

  {# modal s formul√°rom #}
  {% include 'modals/dopyt_form.html' %}
  <script>window.TYPY_DOPYT = {{ (typy or [])|tojson }};</script>
</section>
{% endblock %}
