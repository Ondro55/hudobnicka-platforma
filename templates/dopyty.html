{% extends 'base.html' %}
{% block title %}Dopyty | Muzikuj{% endblock %}

{% block content %}
<section class="bazar-wrapper dopyty-wrapper" style="padding: 2rem; max-width: 1100px; margin: 0 auto;">

  <header class="bazar-header" style="margin-bottom: 1.5rem; display:flex; justify-content:space-between; align-items:end; gap:1rem;">
    <div>
      <h1 style="margin: 0;">üéØ Dopyty</h1>
      <p style="margin: .25rem 0 0 0;">Zoznam po≈æiadaviek na hudbu vytvoren√Ωch verejn√Ωm formul√°rom.</p>
    </div>
    <div>
      <button type="button" class="btn primary" data-modal-open="#dopyt-form">‚ûï Prida≈• dopyt</button>
    </div>
  </header>

  <!-- FILTRE -->
  <section class="bazar-filter filter-panel" style="margin-bottom: 1.5rem; border: 1px solid var(--hover); border-radius: 12px; padding: 1rem;">
    <form method="GET" action="{{ url_for('dopyty.zobraz_dopyty') }}"
          style="display:grid;grid-template-columns:1fr 2fr 1fr auto;gap:.75rem;align-items:end;">

      <div>
        <label for="flt_typ_akcie" class="label">Typ akcie</label>
        <select id="flt_typ_akcie" name="typ_akcie" class="select" style="width:100%;">
          <option value="">V≈°etko</option>
          {% for val, label in [('svadba','Svadba'),('oslava','Oslava'),('firemna','Firemn√° akcia'),('ine','In√©')] %}
            <option value="{{ val }}" {% if request.args.get('typ_akcie')==val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="flt_mesto_id" class="label">Miesto</label>
        <select id="flt_mesto_id" name="mesto_id" class="select" style="width:100%;">
          <option value="">V≈°etky</option>
          {% for m in mesta %}
            <option value="{{ m.id }}" {% if request.args.get('mesto_id', type=int)==m.id %}selected{% endif %}>
              {{ m.nazov }}{% if m.okres %}, {{ m.okres }}{% endif %}{% if m.kraj %}, {{ m.kraj }}{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="flt_datum" class="label">D√°tum</label>
        <input id="flt_datum" name="datum" type="date" value="{{ request.args.get('datum','') }}" class="input" style="width:100%;">
      </div>

      <div style="display:flex; gap:.5rem;">
        <button type="submit" class="btn">Filtrova≈•</button>
        <a class="btn" href="{{ url_for('dopyty.zobraz_dopyty') }}">Zru≈°i≈•</a>
      </div>
    </form>
  </section>

  <!-- ZOZNAM -->
  <section class="bazar-list dopyty-list" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
    {% if dopyty and dopyty|length %}
      {% for d in dopyty %}
        <article class="inzerat-card dopyt-card" style="border: 1px solid var(--hover); border-radius: 12px; padding: 1rem;">
          <div class="card-top" style="display:flex; justify-content:space-between; gap:1rem; flex-wrap: wrap;">
            <h3 style="margin:0;">
              {{ d.typ_akcie|title if d.typ_akcie else 'Dopyt' }}
            </h3>
            <div class="card-date" style="opacity:.8;">
              {% if d.datum %}üìÖ {{ d.datum.strftime('%d.%m.%Y') }}{% endif %}
              {% if d.cas_od or d.cas_do %}
                &nbsp;‚Ä¢&nbsp; ‚è∞ {{ d.cas_od.strftime('%H:%M') if d.cas_od else '‚Äî' }} ‚Äì {{ d.cas_do.strftime('%H:%M') if d.cas_do else '‚Äî' }}
              {% endif %}
            </div>
          </div>

          <div class="card-meta" style="margin-top:.5rem; display:flex; gap:1rem; flex-wrap:wrap; opacity:.9;">
            {% if d.mesto_ref %}
              <span>üìç {{ d.mesto_ref.nazov }}{% if d.mesto_ref.okres %}, {{ d.mesto_ref.okres }}{% endif %}{% if d.mesto_ref.kraj %}, {{ d.mesto_ref.kraj }}{% endif %}</span>
            {% elif d.miesto %}
              <span>üìç {{ d.miesto }}</span>
            {% endif %}
            {% if d.rozpocet is not none %}
              <span>üí∂ {{ '%.0f'|format(d.rozpocet) }} ‚Ç¨</span>
            {% else %}
              <span>üí∂ dohodou</span>
            {% endif %}
            {% if d.meno %}<span>üë§ {{ d.meno }}</span>{% endif %}
          </div>

          {% if d.popis %}
            <p class="card-desc" style="margin-top:.75rem;">{{ d.popis | truncate(220, True, '‚Ä¶') }}</p>
          {% endif %}

          <div class="card-actions" style="display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap;">
            {% if current_user.is_authenticated %}
              {% if d.email %}
                <a class="btn"
                  href="{{ url_for('spravy.napisat', kontekst='dopyt', kontekst_id=d.id, komu_email=d.email) }}">
                  ‚úâÔ∏è Reagova≈• cez e-mail
                </a>
              {% else %}
                <span class="muted">Kontakt nie je k dispoz√≠cii.</span>
              {% endif %}
            {% else %}
              <span class="muted">Prihl√°s sa, aby si mohol reagova≈•.</span>
            {% endif %}

            {% if current_user.is_authenticated and d.pouzivatel_id == current_user.id %}
              <form method="post"
                    action="{{ url_for('dopyty.delete_mine', dopyt_id=d.id) }}"
                    onsubmit="return confirm('Naozaj zmaza≈• tento dopyt?');"
                    style="display:inline;">
                <button type="submit" class="btn danger">Zmaza≈•</button>
              </form>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    {% else %}
      <div class="empty-state" style="text-align:center; padding: 2rem; border:1px dashed var(--hover); border-radius: 12px;">
        <p>Zatiaƒæ ≈æiadne dopyty podƒæa zvolen√Ωch filtrov.</p>
        <a class="btn" href="{{ url_for('dopyty.zobraz_dopyty') }}">Zobrazi≈• v≈°etko</a>
      </div>
    {% endif %}
  </section>

  {% include 'modals/dopyt_form.html' %}

  <!-- Data pre JS (typy) -->
  <script>window.TYPY_DOPYT = {{ (typy or [])|tojson }};</script>
</section>
{% endblock %}
