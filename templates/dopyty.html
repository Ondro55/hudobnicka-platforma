{% extends 'base.html' %}
{% block title %}Dopyty | Muzikuj{% endblock %}

{% block content %}
<section class="komunita-wrapper" style="padding:2rem;">

  <header style="display:flex;justify-content:space-between;align-items:end;gap:1rem;margin-bottom:1rem;">
    <div>
      <h2 style="margin:0;">üì¨ Dopyty</h2>
      <p style="margin:.25rem 0 0;">Po≈æiadavky na hudbu z verejn√©ho formul√°ra.</p>
    </div>
    <div>
      <button type="button" class="btn primary" data-modal-open="#dopyt-form">‚ûï Prida≈• dopyt</button>
    </div>
  </header>

  {# ---- jednotn√Ω filterbar (ako v skupin√°ch/komunite/baz√°ri) ---- #}
  {% set action_url = url_for('dopyty.zobraz_dopyty') %}
  {% set placeholder = 'Hƒæada≈• dopyty‚Ä¶' %}
  {% set btn_label = 'Hƒæada≈•' %}
  {% set show_mesto = True %}
  {% set show_zaner = False %}
  {% set show_kategoria = False %}

  {# zachovaj predvyplnen√© hodnoty z GETu #}
  {% set q = q or request.args.get('q','') %}
  {% set mesto = mesto or request.args.get('mesto','') %}

  {% include "includes/filterbar.html" %}

  {# ---- HLAVIƒåKA STƒπPCOV (5 stƒ∫pcov) ---- #}
  <div class="columns-head" style="font-size:.85rem;color:#666;margin:.5rem 0;">
    <div class="kom-grid-head dopyt" style="grid-template-columns:1.4fr .9fr 1fr .8fr .9fr;">
      <div>Typ / Popis</div>
      <div>D√°tum & ƒças</div>
      <div>Obec / Miesto</div>
      <div>Rozpoƒçet</div>
      <div>Akcie</div>
    </div>
  </div>

  {# ---- ZOZNAM v jednotn√Ωch riadkoch ---- #}
  <div class="list-rows">
    {% if dopyty and dopyty|length %}
      {% for d in dopyty %}
        <article class="list-row kom-grid-row dopyt" style="grid-template-columns:1.4fr .9fr 1fr .8fr .9fr;">

          {# Typ / Popis ‚Äì n√°zov + rozbaliteƒæn√Ω popis bez zdvojenia riadku #}
            <div>
              <h4 class="dpy-title">
                <span class="who">{{ d.meno or 'Meno / organiz√°cia' }}</span>
                <span class="sep">‚Ä¢</span>
                <span class="what">{{ d.typ_akcie or 'Dopyt' }}</span>
              </h4>

              {% if d.popis %}
                <details class="popis" style="margin-top:.2rem;">
                  <summary class="popis-summary">
                    <span class="summary-collapsed text-clip">
                      {{ d.popis | truncate(120, True, '‚Ä¶ viac') }}
                    </span>
                    <span class="summary-open">Zbali≈• popis ‚ñ≤</span>
                  </summary>
                  <div class="popis-full">
                    {{ d.popis }}
                  </div>
                </details>
              {% endif %}
            </div>

          {# D√°tum & ƒças #}
          <div class="text-clip">
            {% if d.datum %}{{ d.datum.strftime('%d.%m.%Y') }}{% else %}‚Äî{% endif %}
            {% if d.cas_od or d.cas_do %}
              <span> ‚Ä¢ {{ d.cas_od.strftime('%H:%M') if d.cas_od else '‚Äî' }}‚Äì{{ d.cas_do.strftime('%H:%M') if d.cas_do else '‚Äî' }}</span>
            {% endif %}
          </div>

          {# Obec / Miesto #}
          <div class="text-clip">
            {% if d.mesto_ref %}
              {{ d.mesto_ref.nazov }}{% if d.mesto_ref.okres %}, {{ d.mesto_ref.okres }}{% endif %}{% if d.mesto_ref.kraj %}, {{ d.mesto_ref.kraj }}{% endif %}
            {% elif d.miesto %}
              {{ d.miesto }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>

          {# Rozpoƒçet #}
          <div class="text-clip">
            {% if d.rozpocet is not none %}
              {{ '%.0f'|format(d.rozpocet) }} ‚Ç¨
            {% else %}
              dohodou
            {% endif %}
          </div>

          {# Akcie #}
          <div class="row-actions">
            {% if current_user.is_authenticated %}
              {% if d.email %}
                <a class="kom-msg-btn"
                  href="{{ url_for('spravy.napisat',
                                    kontekst='dopyt',
                                    kontekst_id=d.id,
                                    komu_email=d.email) }}">
                  ‚úâÔ∏è Spr√°va
                </a>
              {% endif %}
            {% else %}
              <a class="btn primary sm" href="#" data-modal-open="#modal-login">‚úâÔ∏è Spr√°va</a>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p style="padding:.75rem 0;">üòï Zatiaƒæ ≈æiadne dopyty podƒæa filtra.</p>
    {% endif %}
  </div>

  {# modal s formul√°rom #}
  {% include 'modals/dopyt_form.html' %}
  <script>window.TYPY_DOPYT = {{ (typy or [])|tojson }};</script>
</section>
{% endblock %}
