{# templates/podujatie_moje.html #}
{% extends "base.html" %}
{% block title %}Moje podujatie{% endblock %}

{% block content %}
{% set form_action = action or url_for('podujatie.vytvor') %}
<section class="komunita-wrapper" style="padding:2rem;">
  <h2 style="margin-top:0;">Moje podujatie</h2>

  <div class="evt-grid">
    <!-- ƒΩAVO: formul√°r -->
    <form method="POST" action="{{ form_action }}" enctype="multipart/form-data"
          id="event-form" class="card evt-form">
      <div>
        <div class="form-row">
          <label>N√°zov</label>
          <input class="input-line" type="text" name="nazov" id="inp-nazov"
                 value="{{ event.nazov if event else '' }}" required>
        </div>

        <div class="form-row">
          <label>Organiz√°tor (voliteƒæn√©)</label>
          <input class="input-line" type="text" name="organizator" id="inp-org"
                 value="{{ event.organizator if event else '' }}">
        </div>

        <div class="form-row">
          <label>Miesto</label>
          <input class="input-line" type="text" name="miesto" id="inp-miesto"
                 value="{{ event.miesto if event else '' }}">
        </div>

        <div class="form-row two">
          <div>
            <label>D√°tum</label>
            <input class="input-line" type="date" name="datum" id="inp-datum"
                   value="{{ event.start_dt.strftime('%Y-%m-%d') if event and event.start_dt else '' }}" required>
          </div>
          <div>
            <label>Zaƒçiatok</label>
            <input class="input-line" type="time" name="cas" id="inp-cas"
                   value="{{ event.start_dt.strftime('%H:%M') if event and event.start_dt else '' }}" required>
          </div>
        </div>

        <div class="form-row">
          <label>Vstupn√© (‚Ç¨) ‚Äì voliteƒæn√©</label>
          <input class="input-line" type="text" name="vstupne" id="inp-vstupne"
                 value="{{ ('%.2f' % event.vstupne).rstrip('0').rstrip('.') if event and event.vstupne is not none else '' }}"
                 inputmode="decimal" placeholder="napr. 9 alebo 9.90">
        </div>

        <div class="form-row">
          <label>Popis</label>
          <textarea class="input-area" name="popis" id="inp-popis" rows="6"
                    placeholder="Kr√°tky popis programu‚Ä¶">{{ event.popis if event else '' }}</textarea>
        </div>

        <div class="form-row">
          <label>Obr√°zok podujatia (1 ks)</label>
          <input class="input-file" type="file" name="foto" id="inp-foto" accept="image/*">
          {% if event and event.foto_nazov %}
            <div class="file-inline">
              <small>Aktu√°lne: {{ event.foto_nazov }}</small>
              <form method="POST" action="{{ url_for('podujatie.zmaz_foto', id=event.id) }}"
                    onsubmit="return confirm('Odstr√°ni≈• obr√°zok podujatia?');">
                <button class="btn sm">Zmaza≈• obr√°zok</button>
              </form>
            </div>
          {% endif %}
        </div>

        <input type="hidden" name="zverejnit" value="1">
      </div>

      <div class="form-actions">
        <button type="submit" class="btn primary">üöÄ Ulo≈æi≈• & zverejni≈•</button>
        {% if event %}
          <a class="btn" href="{{ url_for('podujatie.moje') }}">Nov√© podujatie</a>
        {% endif %}
      </div>
    </form>

    <!-- PRAVO: ≈æiv√Ω n√°hƒæad -->
    {% set default_img = url_for('static', filename='podujatia/default-event.jpg') %}
    {% set current_img = (url_for('static', filename='podujatia/' ~ event.foto_nazov) if event and event.foto_nazov else default_img) %}

    <article class="card evt-preview">
      <div class="preview-copy">
        <h4 id="prev-nazov" class="prev-title">
          {{ event.nazov if event else 'N√°zov podujatia' }}
        </h4>
        <div id="prev-meta" class="prev-meta">
          {% if event and event.start_dt %}
            {{ event.start_dt.strftime('%d.%m.%Y') }} ‚Ä¢ {{ event.start_dt.strftime('%H:%M') }}{% if event.miesto %} ‚Ä¢ {{ event.miesto }}{% endif %}
          {% else %}
            01.08.2025 ‚Ä¢ 19:00 ‚Ä¢ Bratislava
          {% endif %}
        </div>
        <div id="prev-vstupne" class="prev-price">
          {% if event and event.vstupne is not none %}
            Vstupn√©: {{ ('%.2f' % event.vstupne).rstrip('0').rstrip('.') }} ‚Ç¨
          {% endif %}
        </div>
        <p id="prev-popis" class="prev-desc">
          {{ event.popis if event else 'Kr√°tky popis programu‚Ä¶' }}
        </p>
      </div>

      <div class="preview-toolbar">
        <label class="fit-opt">
          <input type="radio" name="fitMode" value="contain" checked>
          Bez orezania
        </label>
        <label class="fit-opt">
          <input type="radio" name="fitMode" value="cover">
          Orez (vyplni≈•)
        </label>
      </div>

      <div class="preview-frame">
        <img id="preview-img" src="{{ current_img }}" alt="N√°hƒæad">
      </div>
    </article>
  </div>

  <hr style="margin:1.25rem 0;">
  <div class="evt-lists">
    <section>
      <h3>Akt√≠vne</h3>
      <div class="list-rows">
        {% for e in aktivne %}
          <article class="list-row evt-row">
            <div>
              <strong>{{ e.nazov }}</strong><br>
              <small>{{ e.start_dt.strftime('%d.%m.%Y ‚Ä¢ %H:%M') }}{% if e.miesto %} ‚Ä¢ {{ e.miesto }}{% endif %}</small>
            </div>
            <a class="btn sm" href="{{ url_for('podujatie.edit', id=e.id) }}">Upravi≈•</a>
            <form method="POST" action="{{ url_for('podujatie.zmaz', id=e.id) }}"
                  onsubmit="return confirm('Zmaza≈• podujatie?')">
              <button class="btn sm">Zmaza≈•</button>
            </form>
          </article>
        {% else %}
          <p>≈Ωiadne akt√≠vne.</p>
        {% endfor %}
      </div>
    </section>

    <section>
      <h3>Arch√≠v</h3>
      <div class="list-rows">
        {% for e in archiv %}
          <article class="list-row evt-row">
            <div>
              <strong>{{ e.nazov }}</strong><br>
              <small>{{ e.start_dt.strftime('%d.%m.%Y ‚Ä¢ %H:%M') }}{% if e.miesto %} ‚Ä¢ {{ e.miesto }}{% endif %}</small>
            </div>
            <a class="btn sm" href="{{ url_for('podujatie.edit', id=e.id) }}">Upravi≈•</a>
            <form method="POST" action="{{ url_for('podujatie.zmaz', id=e.id) }}"
                  onsubmit="return confirm('Zmaza≈• podujatie?')">
              <button class="btn sm">Zmaza≈•</button>
            </form>
          </article>
        {% else %}
          <p>≈Ωiadny arch√≠v.</p>
        {% endfor %}
      </div>
    </section>
  </div>
</section>

<style>
  .evt-grid{
    display:grid;
    grid-template-columns: 340px minmax(0,1fr);
    gap:1.25rem;
    align-items: stretch; /* NATIAHNE OBA STƒπPCE NA ROVNAK√ö V√ù≈†KU */
  }
  
  .evt-form{
  flex:0 0 340px;           /* ≈°√≠rku si vie≈° upravi≈• (napr. 320‚Äì380px) */
  display:flex;
  flex-direction:column;
  margin:0;                 /* ≈æiadne spodn√© marg√≠ny, nech niƒç ‚Äûnepretek√°‚Äú */
  }
  
  .evt-preview{
    display:flex;
    flex-direction:column;
    padding:0;
    overflow:hidden;
    height:100%;                /* vyrovnanie v√Ω≈°ky s formul√°rom */
  }

  .form-row{ margin-bottom:.85rem; }
  .form-row.two{ display:grid; grid-template-columns:1fr 1fr; gap:.75rem; }
  .input-line, .input-area, .input-file{
    width:100%; padding:.6rem .2rem .5rem .2rem;
    border:none; border-bottom:1px solid #ddd; background:transparent; outline:none;
  }
  .input-area{ min-height:120px; resize:vertical; }
  .input-line:focus, .input-area:focus{ border-bottom-color:#999; }
  .file-inline{ margin-top:.5rem; display:flex; gap:.5rem; align-items:center; }
  .form-actions{ margin-top:.9rem; display:flex; gap:.5rem; }

  .preview-copy{ padding:1rem 1rem .6rem 1rem; }
  .prev-title{ margin:.1rem 0 .35rem 0; }
  .prev-meta{ color:#666; font-size:.95rem; margin-bottom:.3rem; }
  .prev-price{ color:#444; font-size:.95rem; margin-bottom:.4rem; }
  .prev-desc{ margin:.35rem 0 0 0; white-space:pre-wrap; }

  .preview-toolbar{
    display:flex; gap:1rem; align-items:center;
    padding:.6rem 1rem .4rem 1rem; border-top:1px solid #eee;
  }
  .preview-toolbar .fit-opt{ display:flex; align-items:center; gap:.35rem; font-size:.95rem; }

  .preview-frame{
    position:relative; aspect-ratio:16/9; background:#fff;
    border-top:1px solid #eee;
    flex-grow:1;               /* zaberie zvy≈°ok a dorovn√° v√Ω≈°ku kƒæudne aj pri malom texte */
  }
  .preview-frame img{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit: contain; object-position: center; /* default: bez orezania */
    display:block;
  }

  .evt-lists{ display:grid; grid-template-columns:1fr 1fr; gap:1.25rem; }
  .evt-row{ display:grid; grid-template-columns:1fr auto auto; gap:.5rem; align-items:center; }

@media (max-width: 980px){
  .evt-grid{ grid-template-columns: 1fr; }
  .evt-grid > .card{ height:auto; }
}

</style>

<script>
  // ≈Ωiv√Ω n√°hƒæad textov/meta + obr√°zka
  (function(){
    const $ = s => document.querySelector(s);
    const nazov  = $('#inp-nazov');
    const datum  = $('#inp-datum');
    const cas    = $('#inp-cas');
    const miesto = $('#inp-miesto');
    const popis  = $('#inp-popis');
    const vstup  = $('#inp-vstupne');
    const file   = $('#inp-foto');

    const prevNazov = $('#prev-nazov');
    const prevMeta  = $('#prev-meta');
    const prevPopis = $('#prev-popis');
    const prevVst   = $('#prev-vstupne');
    const prevImg   = $('#preview-img');

    function render(){
      const n = nazov?.value?.trim() || 'N√°zov podujatia';
      const d = datum?.value || '';
      const c = cas?.value || '';
      const m = miesto?.value?.trim() || '';
      const p = popis?.value || '';
      const v = vstup?.value?.trim();

      prevNazov.textContent = n;

      let meta = '';
      if (d) {
        try {
          const dt = new Date(d);
          const dd = String(dt.getDate()).padStart(2,'0');
          const mm = String(dt.getMonth()+1).padStart(2,'0');
          const yyyy = dt.getFullYear();
          meta += `${dd}.${mm}.${yyyy}`;
        } catch {}
      }
      if (c) meta += (meta ? ' ‚Ä¢ ' : '') + c;
      if (m) meta += (meta ? ' ‚Ä¢ ' : '') + m;
      prevMeta.textContent = meta || '01.08.2025 ‚Ä¢ 19:00 ‚Ä¢ Bratislava';

      prevPopis.textContent = p || 'Kr√°tky popis programu‚Ä¶';
      prevVst.textContent = v ? `Vstupn√©: ${v.replace(',', '.')} ‚Ç¨` : '';
    }

    [nazov, datum, cas, miesto, popis, vstup].forEach(el => el && el.addEventListener('input', render));
    render();

    if (file) {
      file.addEventListener('change', () => {
        const f = file.files && file.files[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        prevImg.onload = () => URL.revokeObjectURL(url);
        prevImg.src = url;
      });
    }
  })();

  // Prep√≠naƒç orezania (contain/cover)
  (function(){
    const img = document.getElementById('preview-img');
    const fitRadios = document.querySelectorAll('input[name="fitMode"]');

    function applyFit(mode){
      img.style.objectFit = (mode === 'cover') ? 'cover' : 'contain';
      img.style.objectPosition = 'center';
    }
    function refresh(){ applyFit(Array.from(fitRadios).find(r => r.checked)?.value || 'contain'); }

    fitRadios.forEach(r => r.addEventListener('change', refresh));

    if (img.complete && img.naturalWidth) refresh();
    else img.addEventListener('load', refresh);
  })();
</script>
{% endblock %}
