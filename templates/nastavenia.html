{% extends "base.html" %}
{% block title %}Nastavenia | Muzikuj{% endblock %}

{% block content %}
<section class="settings">
  <h1>⚙️ Nastavenia</h1>

  <!-- ÚČET: zmena hesla + žiadosť o vymazanie -->
  <form action="{{ url_for('nastavenia.ucet') }}" method="post" class="formbox" id="form-ucet">
    <h2 id="ucet">Účet</h2>

    <fieldset>
      <legend>Zmena hesla</legend>
      <label>Aktuálne heslo
        <input type="password" name="old_password" required>
      </label>
      <label>Nové heslo
        <input type="password" name="new_password" required>
      </label>
      <label>Potvrdiť nové heslo
        <input type="password" name="new_password2" required>
      </label>
      <button class="btn primary" name="action" value="change_password">Uložiť heslo</button>
    </fieldset>

    <fieldset style="margin-top:1rem;">
      <legend>Vymazanie účtu</legend>
      <p>Vymazanie je trvalé. Verejný obsah zostane anonymizovaný (napr. „Deleted user“).</p>
      <label>Potvrdiť heslom
        <input type="password" name="confirm_password">
      </label>
      <button class="btn danger" name="action" value="request_delete">
        Požiadať o vymazanie
      </button>
    </fieldset>
  </form>

  <!-- SÚKROMIE: viditeľnosť profilu, videá, hodnotenia -->
  <form action="{{ url_for('nastavenia.sukromie') }}" method="post" class="formbox" id="form-sukromie">
    <h2 id="sukromie">Súkromie</h2>

    <fieldset>
      <legend>Viditeľnosť účtu</legend>

      <label>
        <input type="radio" name="verejny_ucet" value="1"
              {{ 'checked' if current_user.verejny_ucet else '' }}>
        Účet verejný (viditeľný aj pre neprihlásených)
      </label>

      <label>
        <input type="radio" name="verejny_ucet" value="0"
              {{ 'checked' if not current_user.verejny_ucet else '' }}>
        Len pre komunitu (iba prihlásení)
      </label>
    </fieldset>

    <fieldset style="margin-top:1rem">
      <legend>Ďalšie</legend>
      <label>
        <input type="checkbox" name="povolit_hodnotenie" value="1"
              {{ 'checked' if current_user.povolit_hodnotenie else '' }}>
        Povoliť hodnotenie (hviezdičky)
      </label>
    </fieldset>

    <div style="margin-top:1rem">
      <button class="btn primary">Uložiť</button>
    </div>
  </form>

  <!-- VZHĽAD: téma / farebné varianty -->
  <form action="/nastavenia/vzhlad" method="post" class="formbox" id="form-vzhlad" style="margin-top:1rem;">
    <h2 id="vzhlad">Vzhľad</h2>

    {% set sel = (current_user.theme or 'system') %}
    <label><input type="radio" name="theme" value="system" {{ 'checked' if sel=='system' else '' }}> Systém (hnedý)</label>
    <label><input type="radio" name="theme" value="blue"   {{ 'checked' if sel=='blue'   else '' }}> Jemný modrý</label>
    <label><input type="radio" name="theme" value="green"  {{ 'checked' if sel=='green'  else '' }}> Jemný zelený</label>
    <label><input type="radio" name="theme" value="red"    {{ 'checked' if sel=='red'    else '' }}> Jemný červený</label>



    <button class="btn primary">Uložiť vzhľad</button>
  </form>

  <!-- SLEDOVANIE: čo ma zaujíma (žánre / subjekty) -->
  <form action="/nastavenia/sledovanie" method="post" class="formbox" id="form-sledovanie" style="margin-top:1rem;">
    <h2 id="sledovanie">Sledovanie</h2>

    <div role="group" aria-label="Režim sledovania" style="margin-bottom:.5rem;">
      <label><input type="radio" name="follow_mode" value="all" checked> Sledovať všetko</label>
      <label><input type="radio" name="follow_mode" value="custom"> Vlastný výber</label>
    </div>

    <div class="follow-categories" style="margin-bottom:.5rem;">
      <h3 style="margin:.25rem 0;">Žánre</h3>
      <label><input type="checkbox" name="zanre" value="folklor"> Folklór</label>
      <label><input type="checkbox" name="zanre" value="rock"> Rock</label>
      <label><input type="checkbox" name="zanre" value="jazz"> Jazz</label>
      <label><input type="checkbox" name="zanre" value="pop"> Pop</label>
      <label><input type="checkbox" name="zanre" value="klasika"> Klasika</label>
    </div>

    <div class="follow-entities" style="margin-bottom:.5rem;">
      <h3 style="margin:.25rem 0;">Typy subjektov</h3>
      <label><input type="checkbox" name="entities" value="kapely"> Kapely</label>
      <label><input type="checkbox" name="entities" value="hudobnici"> Hudobníci</label>
      <label><input type="checkbox" name="entities" value="djs"> DJovia</label>
      <label><input type="checkbox" name="entities" value="organizatori"> Organizátori</label>
    </div>

    <button class="btn primary">Uložiť sledovanie</button>
  </form>

</section>
<script>
(function(){
  const form = document.getElementById('form-ucet');
  if(!form) return;

  function setRequired(el, on){ if(el){ el.required = !!on; } }
  function setDisabled(el, on){ if(el){ el.disabled = !!on; } }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('button[name="action"]');
    if(!btn || btn.form !== form) return;

    const oldP = form.querySelector('input[name="old_password"]');
    const newP = form.querySelector('input[name="new_password"]');
    const newP2 = form.querySelector('input[name="new_password2"]');
    const conf = form.querySelector('input[name="confirm_password"]');

    if (btn.value === 'request_delete') {
      // pre delete: vypnúť required na poliach pre zmenu hesla
      setRequired(oldP, false); setRequired(newP, false); setRequired(newP2, false);
      // voliteľne ich dočasne disable, nech sa neposielajú:
      setDisabled(oldP, true); setDisabled(newP, true); setDisabled(newP2, true);
      // a vyžadovať potvrdenie heslom pre delete
      setRequired(conf, true);

      if (!confirm('Naozaj chcete vymazať účet? Vymazaním stratíte všetky údaje na muzikuj.sk.')) {
        // vráť stavy späť, ak zruší
        setDisabled(oldP, false); setDisabled(newP, false); setDisabled(newP2, false);
        setRequired(conf, false);
        e.preventDefault();
      }
    } else if (btn.value === 'change_password') {
      // pre change password: validujeme len polia pre heslo
      setDisabled(oldP, false); setDisabled(newP, false); setDisabled(newP2, false);
      setRequired(oldP, true);  setRequired(newP, true);  setRequired(newP2, true);
      setRequired(conf, false);
    }
  });
})();
</script>

{% endblock %}
